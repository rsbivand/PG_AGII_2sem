[
  {
    "objectID": "index.html",
    "href": "index.html",
    "title": "Spatial Econometrics",
    "section": "",
    "text": "Course description\n\nPlanned topics\n\nIntroducing Spatial Econometrics\nSpatial data\nWorking with spatial data\nCreating spatial weights objects\nSpatial Econometrics: Antecedents\nEconomic and social research questions using spatial data\nTests of spatial autocorrelation, model specification\nSpatial autoregressive models: conditional (CAR) and simultaneous (SAR)\nEstimation of spatial autoregressive models: methods (GMM, ML, Bayesian)\nNo orthogonality between regression and autoregression coefficients\nPrediction and spatial models\nEigenvectors and eigenvalues of graphs of relationships between cross-sectional observations\n\n\n\nTeam projects\nThe teams should aim to prepare notebooks showing reasoning, code, workflow, conclusions, and should include a log of team discussions, and the conclusions should show how the team, with hindsight, might have modified the topics and workflow had more time, data, or other resources been available.\nTeams should try to limit joint team work to the 30 hours available, but team members may choose to make progress individually to tackle technical snags. The team may choose to delegate parts to team members; use of GitHub or similar to share writing of the notebook is encouraged.\n\nestablish communication through moodle for on-demand consultations in or outside the scheduled project hours\nweek 11: draft team project proposals to be decided\nweek 12: feedback on progress with projects\nweek 15: mid-term team project reports\nweek 16: feedback on progress with projects\nweek 17: feedback on progress with projects\nMonday 6 May, 15:15-18:00 presentation of team projects and wrap-up\n\n\n\nOnline resources\n\nPebesma and Bivand (2023) is also available at: https://r-spatial.org/book\nMore on constructing spatial neighbour objects: https://r-spatial.github.io/spdep/articles/nb_sf.html\nSpatial weights as graphs: https://r-spatial.github.io/spatialreg/articles/nb_igraph.html\nEMOS talk 19 April 2023: https://rsbivand.github.io/emos_talk_2304/, https://www.youtube.com/watch?v=spYPyHxa7v8\nUAM short courses: https://rsbivand.github.io/UAM21_I/, https://rsbivand.github.io/UAM21_II/\nWhyR 2020 keynote: https://www.youtube.com/watch?v=mEAyQ8bv1zU\n2020 BAN 422 Masters course Visualization: https://rsbivand.github.io/BAN422_V20/\nECS530 PhD course 2019 (with recorded talks): https://rsbivand.github.io/ECS530_h19/, https://www.youtube.com/watch?v=KkIbg50Pa0I&list=PLXUoTpMa_9s10NVk4dBQljNOaOXAOhcE0\n2019 BAN 421 Masters course Data structures: https://rsbivand.github.io/ban421_h19/\n\nSpatial Econometrics: Team project using R © 2024 by Roger Bivand is licensed under CC Attribution-NonCommercial-NoDerivatives 4.0 International BY-NC-ND 4.0\n\n\n\n\nPebesma, Edzer, and Roger Bivand. 2023. Spatial Data Science with Applications in R. Boca Raton, FL: CRC Press.",
    "crumbs": [
      "Course description"
    ]
  },
  {
    "objectID": "01_talk.html",
    "href": "01_talk.html",
    "title": "1  Introducing Spatial Econometrics",
    "section": "",
    "text": "1.1 Why is spatial data special?\nThe three kinds of spatial data (Cressie 1993) are spatial point patterns, geostatistical data observed at sample stations for prediction to unobserved locations, and areal data, also known as lattice data. In the case of spatial point patterns, it is assumed that all points are known, and the point process of interest is that driving the patterning of the points, for example that they are more clustered than if they were randomly distributed over the study area. Geostatistical modelling developed from hydrology and mining (environmental science) to estimate areas or volumes of quantities of interest, where more variability in the variables observed might suggest the need for sample locations to be closer to each other. While spatial econometrics has some links with spatial point patterns (e.g. Arbia 2001; Marcon et al. 2015; Marcon and Puech 2017, 2023), and geostatistics (e.g. Dearmon and Smith 2021), areal or lattice spatial data are much more commonly analysed.\nAreal or lattice spatial data may be aggregates within administrative boundaries, such as municipalities, counties or census tracts, or may be points representing observations that do not reasonably match observations on a continuous surface as would have suited a geostatistical approach. In preparing data for modelling, support is often changed when, for example, night-time light intensity observed over raster cells is aggregated to irregular polygons, or read off by dropping points onto the raster cells. By support, we mean the geometry of the initial observation (Pebesma and Bivand 2023, 49–54), so that when we for example use the centroid of an areal observation in place of its boundaries, we change the meaning of the variables - the population count for the polygon is not the same as the count at the centroid point.\nChange of support (Gotway and Young 2002) remains a largely unresolved, even unseen, problem, such as reading off data from sources with a different support than the modelled variable - like register data address points on other aggregate or estimated variables. Change of support implies acceptance that the transformed data are an estimate with a distribution, and that this uncertainty is often not carried through to the target estimation. This problem affects temporal data, but here the possible implied smoothing incurred when changing temporal units (hours, days, weeks, quarters, years) is better understood. What are the specific challenges involved in analysing areal spatial data?\nTemporal autocorrelation and cross-correlation are quite well understood, an observation of a continuous variable at time point or interval t is likely to be more similar to the value at t-1 than when the time lag is greater, unless periodicity is more dominant. Two variables may well co-vary in time; knowing the degree of co-variation and autocorrelation, forecasts can be made readily. For time series, we know that present values depend in some degree on past values, observed at points or intervals of time for which entities of observation have an acknowledged status.\nUnderstanding of spatial autocorrelation is less simple, partly because it also includes the more fluid association of observed values with observational units. A classic case is the discussion following the presentation of a paper in anthropology by Tylor on marriage and descent laws and customs (Tylor 1889). In the discussion - printed with the paper, Galton raises the question of the independence of the reported observations (Galton’s Problem is also known as phylogenetic autocorrelation):\nThe speaker responded:\nOne view of this exchange is that nearness in space and the fluid assignment of boundaries between observations may affect our view of how many valid observations have been made. Is n n or some reduced number reflecting the common origins of the data reported? The assignment of bourdaries between observations, entitation, is a key concept in the modelling of spatial interaction (Wilson 2000, 2002, 2012), where often unobservable micro-level movements are tallied by meso-level containers. As Openshaw and Taylor (1979) showed, the “modifiable areal unit problem” (MAUP), can permit the re-arrangement of component spatial sub-units into higher-level contiguous units that give the desired outcome (also known as gerrymandering, creating voting districts to ensure desired outcomes).\nYule and Kendall (1958) distinguish clearly between modifiable units of observation and units that cannot be modified by subdivision or aggregation (temporal units are also modifiable). If units are modifiable, then any results from analysis will be valid only in relation to the units:\nAn extension of this view is seen where the units of observation chosen do not address important sources of variation in the response; Kendall (1939) analysed crop productivity in England by crop counties for which data were readily available, but was criticised in discussion for not using soil or climate classifications in their place by Dudley Stamp, who was directing the Land Utilisation Survey of Britain at that time:\nThe speaker responded:\nAn overlapping view on Galton’s Problem is that, assuming that the spatial units of observation are accepted as given, spurious correlation due to position may arise from unobserved spillover between nearby observations; Student (1914) touches briefly on agricultural trial plots in describing this aspect of the problem as treatments may leach between neighbouring plots. Student had been concerned in several contexts with the effective degrees of freedom of a collection of observations. Positive spillover, leading to more likeness between neighbours, would clearly reduce the effective count of independent observations. Stephan (1934) gives us a powerful picture of the problem:\nTobler expresses his view, perhaps the view that is most often cited in discussing spatial data, in this way:\nHowever, Olsson (1970) asks whether the unquestioning application of the ubiquity of spatial autocorrelation, as the only lens through which to view spatial data, is wise:\nSpecification errors of the kind concerning Olsson may be manifold, such as inappropriate entitation, inappropriate functional form, and omitted variables among others. Standard tests for spatial autocorrelation, like tests for temporal autocorrelation, often pick up other causes of mis-specification than the mutual dependence of observations that the tests were created to detect (Schabenberger and Gotway 2005; McMillen 2003). Inappropriate entitation may involve the spatial scale of the empirical processes of interest, where the units of observation may be too large to pick up the phenomena being observed, or the footprint of the observed phenomenon may be split up among many units of observation (Galton’s Problem). The interaction of scale, heterogeneity - based on scale, functional form, and/or missing covariates - and spatial autocorrelation has been a major topic of debate in numerical ecology for many years (Dray et al. 2012).\nAt this point it might be tempting to step back, sensing that spatial data is special, not so much specially promising, but more specially challenging (Ripley 1988). However, if the data to hand or the data to be collected are spatially located, it is sensible to accept the challenges that analysis of such data may entail. The next section will depict how spatial econometrics was created in the form in which we now know it, to address som of the challenges and to benefit from some of the opportunities presented.",
    "crumbs": [
      "<span class='chapter-number'>1</span>  <span class='chapter-title'>Introducing Spatial Econometrics</span>"
    ]
  },
  {
    "objectID": "01_talk.html#sec-why-special",
    "href": "01_talk.html#sec-why-special",
    "title": "1  Introducing Spatial Econometrics",
    "section": "",
    "text": "It was extremely desirable for the sake of those who may wish to study the evidence for Dr. Tylor’s conclusions, that full information should be given as to the degree in which the customs of the tribes and races which are compared together are independent. It might be, that some of the tribes had derived them from a common source, so that they were duplicate copies of the same original. Certainly, in such an investigation as this, each of the observations ought, in the language of statisticians, to be carefully “weighted.” It would give a useful idea of the distribution of the several customs and of their relative prevalence in the world, if a map were so marked by shadings and colour as to present a picture of their geographical ranges. (Tylor 1889, 270) \n\n\n\nThe difficulty raised by Mr. Galton that some of the concurrences might result from transmission from a common source, so that a single character might be counted several times from its mere duplicates, is a difficulty ever present in such investigations, as for instance in the Malay region, where groups of islands have enough differentiation in their marriage systems to justify their being classed separately, though traces of common origin are at the same time conspicuous. The only way of meeting this objection is to make separate clsssification depend on well marked differences, and to do this all over the world. (Tylor 1889, 272) \n\n\n\n\nThey have no absolute validity independently of those units, but are relative to them. They measure, as it were, not only the variation in the quantities under consideration, but the properties of the unit-mesh which we have imposed on the system in order to measure it. (Yule and Kendall 1958, 312)\n\n\n\n… the author had partly anticipated his main criticism - namely, that the foundation of data actually available was at the present time totally inadequate to support the superstructure which he had erected on it. …\nit would be difficult to find any division of England more unsuitable for the arrangement of the superstructure than the administrative counties. (Kendall 1939, 52)\n\n\n\nIt was an inherent defect in this work, as far as it was a practical description of the geography of the country, that it did deal with particular counties and not with farming districts. Such value as might be claimed for the paper lay in the nature of the trial methods rather than in the results themselves, but he did differ from Dr. Stamp on one point. Dr. Stamp, if Mr. Kendall understood him correctly, suggested a division of the country on climatic or pedological lines. Mr. Kendall thought that if one had to select smaller areas within the county for study, one would select them on a farming type basis, not on a geographical basis. Apart from soil and climate the existing organization of the farm had a powerful influence on its nature and on its productivity. (Kendall 1939, 61)\n\n\n\nData of geographic units are tied together, like bunches of grapes, not separate, like balls in an urn. Of course mere contiguity in time and space does not of itself indicate lack of independence between units in a relevant variable or attribute, but in dealing with social data, we know that by virtue of their very social character, persons, groups and their characteristics are interrelated and not independent. (Stephan 1934, 165)\n\n\n\n… the first law of geography: everything is related to everything else, but near things are more related than distant things. (Tobler 1970, 236)\n\n\n\nThe existence of such autocorrelations makes it tempting to agree with Tobler (1970, 236 [the original refers to the pagination of a conference paper]) that ‘everything is related to everything else, but near things are more related than distant things.’ On the other hand, the fact that the autocorrelations seem to hide systematic specification errors suggests that the elevation of this statement to the status of ‘the first law of geography’ is at best premature. At worst, the statement may represent the spatial variant of the post hoc fallacy, which would mean that coincidence has been mistaken for a causal relation. (Olsson 1970, 228; cf. Pebesma and Bivand 2023, 210) \n\n\n\n\n\n\n\nArbia, Giuseppe. 2001. “Modelling the Geography of Economic Activities on a Continuous Space.” Papers in Regional Science 80 (4): 411–24. https://doi.org/10.1111/j.1435-5597.2001.tb01211.x.\n\n\nCressie, Noel A. C. 1993. Statistics for Spatial Data. New York: John Wiley & Sons.\n\n\nDearmon, Jacob, and Tony E. Smith. 2021. “A Hierarchical Approach to Scalable Gaussian Process Regression for Spatial Data.” Journal of Spatial Econometrics 2 (7): 1–33. https://doi.org/10.1007/s43071-021-00012-5.\n\n\nDray, S., R. Pélissier, P. Couteron, M.-J. Fortin, P. Legendre, P. R. Peres-Neto, E. Bellier, et al. 2012. “Community Ecology in the Age of Multivariate Multiscale Spatial Analysis.” Ecological Monographs 82 (3): 257–75. https://doi.org/10.1890/11-1183.1.\n\n\nGotway, C. A., and L. J. Young. 2002. “Combining Incompatible Spatial Data.” Journal of the American Statistical Association 97: 632–48.\n\n\nKendall, M. G. 1939. “The Geographical Distribution of Crop Productivity in England.” Journal of the Royal Statistical Society 102 (1): 21–62. http://www.jstor.org/stable/2980138.\n\n\nMarcon, Eric, and Florence Puech. 2017. “A Typology of Distance-Based Measures of Spatial Concentration.” Regional Science and Urban Economics 62: 56–67. https://doi.org/10.1016/j.regsciurbeco.2016.10.004.\n\n\n———. 2023. “Mapping Distributions in Non‑homogeneous Space with Distance‑based Methods.” Journal of Spatial Econometrics 4 (13): 1–16. https://doi.org/10.1007/s43071-023-00042-1.\n\n\nMarcon, Eric, Stéphane Traissac, Florence Puech, and Gabriel Lang. 2015. “Tools to Characterize Point Patterns: Dbmss for r.” Journal of Statistical Software, Code Snippets 67 (3): 1–15. https://doi.org/10.18637/jss.v067.c03.\n\n\nMcMillen, Daniel P. 2003. “Spatial Autocorrelation or Model Misspecification?” International Regional Science Review 26: 208–17.\n\n\nOlsson, Gunnar. 1970. “Explanation, Prediction, and Meaning Variance: An Assessment of Distance Interaction Models.” Economic Geography 46: 223–33. http://www.jstor.org/stable/143140.\n\n\nOpenshaw, S., and P. J. Taylor. 1979. “A Million or so Correlation Coefficients: Three Experiments on the Modifiable Area Unit Problem.” In Statistical Applications in the Spatial Sciences, edited by N. Wrigley, 127–44. London: Pion.\n\n\nPebesma, Edzer, and Roger Bivand. 2023. Spatial Data Science with Applications in R. Boca Raton, FL: CRC Press.\n\n\nRipley, Brian D. 1988. Statistical Inference for Spatial Processes. Cambridge: Cambridge University Press.\n\n\nSchabenberger, O., and C. A. Gotway. 2005. Statistical Methods for Spatial Data Analysis. Boca Raton/London: Chapman & Hall/CRC.\n\n\nStephan, Frederick F. 1934. “Sampling Errors and Interpretations of Social Data Ordered in Time and Space.” Journal of the American Statistical Association 29 (185): 165–66.\n\n\nStudent. 1914. “The Elimination of Spurious Correlation Due to Position in Time or Space.” Biometrika 10 (1): 179–80.\n\n\nTobler, Waldo R. 1970. “A Computer Movie Simulating Urban Growth in the Detroit Region.” Economic Geography 46: 234–40.\n\n\nTylor, Edward B. 1889. “On a Method of Investigating the Development of Institutions; Applied to Laws of Marriage and Descent.” The Journal of the Anthropological Institute of Great Britain and Ireland 18: 245–72. http://www.jstor.org/stable/2842423.\n\n\nWilson, Alan G. 2000. Complex Spatial Systems: The Modelling Foundations of Urban and Regional Analysis. Harlow: Prentice Hall.\n\n\n———. 2002. “Complex Spatial Systems: Challenges for Modellers.” Mathematical and Computer Modelling 36: 379–87.\n\n\n———. 2012. The Science of Cities and Regions: Lectures on Mathematical Model Design. Dordrecht: Springer.\n\n\nYule, G. Udny, and M. G. Kendall. 1958. An Introduction to the Theory of Statistics. 14th ed. London: Charles Griffin.",
    "crumbs": [
      "<span class='chapter-number'>1</span>  <span class='chapter-title'>Introducing Spatial Econometrics</span>"
    ]
  },
  {
    "objectID": "02_talk.html",
    "href": "02_talk.html",
    "title": "2  Spatial data",
    "section": "",
    "text": "2.1 Spatial data basics\nSpatial data are observations on variables, be they categorical, ordinal or continuous. The observations are associated with a position in space, where space is often represented as (sets of) coordinate tuplets on a map; spatial data are also found in bioinformatics and medical imaging, but here we are concerned with geographical spatial data.\nGeographical spatial data take two forms: spatial vectors and spatial rasters. Spatial vector objects are most often represented by geometries of sets of pairs of coordinates known as eastings and northings, or longitude and latitude, forming points, lines or polygons; three-dimensional spatial vectors are not often used but may be provided by data sources. Spatial raster objects are regular square or rectangular grids of cells, most like digital images. Spatial rasters are fixed to a spatial point of origin and the locations of cells can be found from the point of origin by stepping out from the origin cell and summing the distances crossing intervening calls measured by the size or resolution of the cells. Rasters have one or more bands, and may also be termed spatial data cubes, structured by two or three spatial dimensions (three if height/depth is included) and a time dimension in addition to bands containing sensor measurements.\nWhile spatial raster objects include attribute data - observations on variables taken at the location of each cell, spatial vector objects do not have to do so. Observations on variables of interest are linked to geometries through a common key or identifier. The key linking the observations with the spatial vector geometries may often be a standard code published and updated by a government statistical office. Not infrequently, the data are acquired or downloaded including the key, and the geometries of the spatial objects are acquired or downloaded separately, to be merged by the observation keys afterwards. Noting the timestamp specifying the validity of geometries and keys is always sensible, as both keys and geometries change over time. We will return to the representation of time in spatial panel objects, where the geometries are invariant but variables of interest are observed over successive time periods.\nFor the present, spatial data will be taken as-is; we will return to reading and writing spatial data from and to files in Section Section 3.3. The comprehensive R archive network (CRAN) provides software packages and short summaries called task views listing packages useful for particular tasks. The Spatial task view (https://cran.r-project.org/view=Spatial) lists packages accessing or providing specific data sources of interest. Here we will use three such packages: chilemapas with administrative boundaries for Chile, and rgugik for Poland, elevatr for spatial raster elevation data, and osmdata for OpenStreetMap information. The representation of the spatial vector data is handled by the sf package:\nSys.setenv(\"PROJ_NETWORK\"=\"ON\")\nlibrary(sf)\n\nLinking to GEOS 3.12.1, GDAL 3.8.4, PROJ 9.3.1; sf_use_s2() is TRUE\nlibrary(chilemapas)\nmapa_comunas |&gt; data.frame() |&gt; \n  st_as_sf(sf_column_name=\"geometry\") -&gt; mc_sf\nmc_sf\n\nSimple feature collection with 345 features and 3 fields\nGeometry type: MULTIPOLYGON\nDimension:     XY\nBounding box:  xmin: -109.4499 ymin: -56.52511 xmax: -66.41617 ymax: -17.49778\nGeodetic CRS:  SIRGAS 2000\nFirst 10 features:\n   codigo_comuna codigo_provincia codigo_region                       geometry\n1          01401              014            01 MULTIPOLYGON (((-68.86081 -...\n2          01403              014            01 MULTIPOLYGON (((-68.65113 -...\n3          01405              014            01 MULTIPOLYGON (((-68.65113 -...\n4          01402              014            01 MULTIPOLYGON (((-69.31789 -...\n5          01404              014            01 MULTIPOLYGON (((-69.39615 -...\n6          01107              011            01 MULTIPOLYGON (((-70.1095 -2...\n7          01101              011            01 MULTIPOLYGON (((-70.09894 -...\n8          02104              021            02 MULTIPOLYGON (((-68.98863 -...\n9          02101              021            02 MULTIPOLYGON (((-70.60654 -...\n10         02201              022            02 MULTIPOLYGON (((-67.94302 -...\nThe mapa_comunas data object stored in the chilemapas package is represented as a tibble and an sf object. Because most model fitting objects expect data as a data.frame not a tbl also known as a tibble, we coerce to data.frame and re-construct the sf object using the sf::st_as_sf method for data.frame objects. The disparity between data.frame and tbl objects is that when a single column of a data.frame is selected with the [ method, it becomes a vector by default, but the [ method on a single column of a tbl object returns a tbl by default. The geometry column is an sfc object, a list column of sfg objects, where sfg means “Simple Feature” geometry.\nst_geometry(mc_sf)\n\nGeometry set for 345 features \nGeometry type: MULTIPOLYGON\nDimension:     XY\nBounding box:  xmin: -109.4499 ymin: -56.52511 xmax: -66.41617 ymax: -17.49778\nGeodetic CRS:  SIRGAS 2000\nFirst 5 geometries:\n\n\nMULTIPOLYGON (((-68.86081 -21.28512, -68.92172 ...\n\n\nMULTIPOLYGON (((-68.65113 -19.77188, -68.81182 ...\n\n\nMULTIPOLYGON (((-68.65113 -19.77188, -68.63545 ...\n\n\nMULTIPOLYGON (((-69.31789 -19.13651, -69.2717 -...\n\n\nMULTIPOLYGON (((-69.39615 -19.06125, -69.40025 ...\nThe geometry column contains 345 multi-polygon objects, containing the boundaries of Chilean municipalities in 2017, clipped to the coastline. They are multi-polygons because at least some municipalities are composed of island and mainland parts. The short summary printed here also states that the geometries have a geodetic coordinate reference system (CRS), here specified as SIRGAS 2000. We return to coordinate reference systems in the next section Section 2.2, but note that area calculation is conducted on the specified ellipsoid using the s2 by default, not on the plane.\nLet us find the area of Región del Maule, region \"07\", of which Taule is the capital city, using the region key column in the sf object named mc_sf. First we subset the municipalities to the desired region, then union the municipalities in Región del Maule before finding the area of the region as a whole.\nmc_sf |&gt; subset(subset=codigo_region == \"07\") -&gt; maule_sf\nmaule_sf |&gt; st_union() |&gt; st_area() |&gt; units::set_units(\"km2\")\n\n30297.84 [km^2]\nThe result agrees adequately with 30,296.1 square kilometres given by Wikipedia, as the details of administrative boundaries and hence the computed area are compromises between detail and the size of the data object stored in the package. By default the results of length or area calculations for spherical coordinates are returned by s2 in metres or square metres, so we convert to square kilometres.\nsf objects pay attention to the support of variables, whether they may be classed as constant, aggregate, or identity. Constant variables are constant across the whole area of a polygon, for example a land use category. Aggregate variables may be counts, rates based on counts, or densities of counts by polygon area. Identity variables uniquely identify the geometries. In the case of the Región del Maule data set, no definitions have so far been provided, so when we change support from polygon to point by computing the spherical centroid, a warning is given (see Pebesma and Bivand 2023, 49–52). st_agr returns the current state of the factor (categorical object) for the non-geometry variables included in the sf object:\nst_agr(maule_sf)\n\n   codigo_comuna codigo_provincia    codigo_region \n            &lt;NA&gt;             &lt;NA&gt;             &lt;NA&gt; \nLevels: constant aggregate identity\n\nmaule_sf |&gt; st_centroid() -&gt; maule_sf_pt1\n\nWarning: st_centroid assumes attributes are constant over geometries\nWe can avoid the warning by taking the centroid of the geometries alone, of the sfc object rather than the sf object:\nmaule_sf |&gt; st_geometry() |&gt; st_centroid() -&gt; maule_sfc_pt2\nAlternatively, since there are few non-geometry columns in the data set, we can assign the appropriate values to them, so that since the change of support does not change the meaning of the variables, no warning is given:\nmaule_sf |&gt; \n  st_set_agr(c(codigo_comuna=\"identity\",\n               codigo_provincia=\"identity\", \n               codigo_region=\"constant\")\n            ) -&gt; maule_sf_agr\nst_agr(maule_sf_agr)\n\n   codigo_comuna codigo_provincia    codigo_region \n        identity         identity         constant \nLevels: constant aggregate identity\n\nmaule_sf_agr |&gt; st_centroid() -&gt; maule_sf_pt3\nThe three remaining packages download spatial data from public sources rather than pre-packaging them for use. elevatr can be used to download global elevation data as a spatial raster; until version 1 of the package is released, it returns a \"RasterLayer\" as defined in the legacy raster package, but from 1.0 will return a \"SpatRaster\" defined in the terra package. Here we specify our area of interest by passing the sf spatial vector object for Región del Maule, and clip the output to the boundary of the region, setting negative values to missing:\nlibrary(elevatr)\n\nelevatr v0.99.0 NOTE: Version 0.99.0 of 'elevatr' uses 'sf' and 'terra'.  Use \nof the 'sp', 'raster', and underlying 'rgdal' packages by 'elevatr' is being \ndeprecated; however, get_elev_raster continues to return a RasterLayer.  This \nwill be dropped in future versions, so please plan accordingly.\n\nlibrary(terra)\n\nterra 1.7.71\n\nmaule_sf |&gt;  get_elev_raster(z = 7,\n clip = \"locations\", neg_to_na = TRUE) |&gt; \n rast() -&gt; maule_elev\n\nMosaicing & Projecting\n\n\nClipping DEM to locations\n\n\nNote: Elevation units are in meters.\n\nmaule_elev\n\nclass       : SpatRaster \ndimensions  : 371, 493, 1  (nrow, ncol, nlyr)\nresolution  : 0.005009617, 0.005009617  (x, y)\nextent      : -72.78435, -70.3146, -36.54143, -34.68287  (xmin, xmax, ymin, ymax)\ncoord. ref. : +proj=longlat +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +no_defs \nsource(s)   : memory\nname        : file110083d2fade6 \nmin value   :                 0 \nmax value   :              3936\nThe raster has one layer (band), with a square (geodetic) grid with a resolution of about 0.005 degrees, 18.03 arc seconds in both dimensions, 371 rows and 493 columns.\nLet us now access OpenStreetMap data using osmdata (Padgham et al. 2017), first subsetting to the city of Talca, the capital of Región del Maule. To set up a query, we need to build an OpenStreetMap Overpass query using a bounding box of our area of interest. Since it can be difficult to know what kinds of data have been contributed, we add the \"names\" feature, pulling in everything in the rectangle defined in degrees of longitude and latitude - obviously the top and bottom of the rectangle are actually curves, because the rectangle is on the surface of an ellipsoid. Having created the query talca_q, we can extract the data for all features with names:\nmaule_sf |&gt; subset(subset = codigo_comuna==\"07101\") -&gt; talca_sf\nlibrary(osmdata)\n\nData (c) OpenStreetMap contributors, ODbL 1.0. https://www.openstreetmap.org/copyright\n\ntalca_sf |&gt; st_bbox() |&gt; opq() |&gt;\n add_osm_feature(key = \"names\") -&gt; talca_q\ntalca_q |&gt; osmdata_sf() -&gt; talca_osm_sf\ntalca_osm_sf\n\nObject of class 'osmdata' with:\n                 $bbox : -35.5310255,-71.723806,-35.3118342,-71.4925696\n        $overpass_call : The call submitted to the overpass API\n                 $meta : metadata including timestamp and version numbers\n           $osm_points : 'sf' Simple Features Collection with 134548 points\n            $osm_lines : 'sf' Simple Features Collection with 14580 linestrings\n         $osm_polygons : 'sf' Simple Features Collection with 1090 polygons\n       $osm_multilines : 'sf' Simple Features Collection with 20 multilinestrings\n    $osm_multipolygons : 'sf' Simple Features Collection with 22 multipolygons\nThe output object is a list of components, some of which are sf objects. If we take the point objects, we can attempt to subset to those said to offer take-away service, that is those for which the takeaway variable is not coded NA - missing.\ntalca_osm_sf$osm_points -&gt; talca_pts\ntalca_pts |&gt; subset(subset = !is.na(takeaway), \n select = c(osm_id, name, amenity, cuisine,\n  takeaway, geometry)) -&gt; talca_takeaways\ntalca_takeaways\n\nSimple feature collection with 11 features and 5 fields\nGeometry type: POINT\nDimension:     XY\nBounding box:  xmin: -71.68909 ymin: -35.44643 xmax: -71.62727 ymax: -35.42225\nGeodetic CRS:  WGS 84\nFirst 10 features:\n               osm_id                 name    amenity        cuisine takeaway\n1237856768 1237856768              Rossini       cafe       sandwich      yes\n1264154772 1264154772            Telepizza  fast_food          pizza      yes\n2853291904 2853291904             La Cleta restaurant           &lt;NA&gt;      yes\n2853679104 2853679104          3 Estrellas        pub       sandwich      yes\n2858522001 2858522001 Cafetería Riquíssimo restaurant       regional      yes\n3377351170 3377351170             Me Gustó  fast_food         burger      yes\n3699062703 3699062703       Talca Sandwich  fast_food         burger      yes\n3766018631 3766018631           El Chilote restaurant fish_and_chips      yes\n7233542316 7233542316           McDonald's  fast_food         burger      yes\n7862158443 7862158443          Papa John's  fast_food          pizza      yes\n                              geometry\n1237856768 POINT (-71.66275 -35.42618)\n1264154772 POINT (-71.63046 -35.43272)\n2853291904 POINT (-71.66563 -35.42866)\n2853679104 POINT (-71.65372 -35.42822)\n2858522001 POINT (-71.66378 -35.42624)\n3377351170 POINT (-71.68909 -35.44643)\n3699062703 POINT (-71.68062 -35.43947)\n3766018631 POINT (-71.67028 -35.42225)\n7233542316 POINT (-71.65486 -35.42561)\n7862158443 POINT (-71.68665 -35.44302)\nThere only appear to be 11 such establishments, but perhaps these are the ones whose locations grateful clients (or ambitious proprietors) have contributed to OpenStreetMap.\nThe rgugik package (Dyba and Nowosad 2021) does not bundle the municipality boundaries of Poland as chilemapas did for Chile, but downloads them from the Polish Head Office of Geodesy and Cartography (GUGIK) online. The object returned from a query to the boundaries of the Gdańsk county administrative unit is an sf object with a single variable, the identification key.\nlibrary(rgugik)\ngd_sf &lt;- borders_get(county = \"Gdańsk\")\ngd_sf\n\nSimple feature collection with 1 feature and 1 field\nGeometry type: MULTIPOLYGON\nDimension:     XY\nBounding box:  xmin: 462961.1 ymin: 712372.4 xmax: 496776.7 ymax: 731607.8\nProjected CRS: ETRF2000-PL / CS92\n  TERYT                           geom\n1  2261 MULTIPOLYGON (((465078.9 73...\nAgain, we can use the sf object to access elevation data, here returned with about 88 metre resolution, as the input object has a projected coordinate reference system:\ngd_sf |&gt;  get_elev_raster(z = 9,\n clip = \"locations\", neg_to_na = TRUE) |&gt; rast() -&gt; gd_elev\n\nMosaicing & Projecting\n\n\nClipping DEM to locations\n\n\nNote: Elevation units are in meters.\n\ngd_elev\n\nclass       : SpatRaster \ndimensions  : 216, 379, 1  (nrow, ncol, nlyr)\nresolution  : 89.09542, 89.09542  (x, y)\nextent      : 462973.9, 496741.1, 712362.5, 731607.1  (xmin, xmax, ymin, ymax)\ncoord. ref. : +proj=tmerc +lat_0=0 +lon_0=19 +k=0.9993 +x_0=500000 +y_0=-5300000 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs \nsource(s)   : memory\nname        : file110082adba552 \nmin value   :                 0 \nmax value   :               177\nAs we just observed, gd_sf has a projected coordinate reference system, so needs to be transformed to a geodetic coordinate reference system before the creation of an Openpass query, here for \"amenity\" features:\ngd_sf |&gt; st_transform(crs = \"OGC:CRS84\") |&gt; st_bbox() |&gt;\n opq() |&gt; add_osm_feature(key = \"amenity\") -&gt; gd_q\ngd_q |&gt; osmdata_sf() -&gt; gd_osm_sf\ngd_osm_sf\n\nObject of class 'osmdata' with:\n                 $bbox : 54.274974489,18.429497095,54.447218154,18.9503794130001\n        $overpass_call : The call submitted to the overpass API\n                 $meta : metadata including timestamp and version numbers\n           $osm_points : 'sf' Simple Features Collection with 64129 points\n            $osm_lines : 'sf' Simple Features Collection with 30 linestrings\n         $osm_polygons : 'sf' Simple Features Collection with 5946 polygons\n       $osm_multilines : 'sf' Simple Features Collection with 1 multilinestrings\n    $osm_multipolygons : 'sf' Simple Features Collection with 19 multipolygons\nOnce again we extract the locations of registered take-away outlets, of which many more seem to have been contributed to OpenStreetMap than in the case of the bounding box surrounding the city of Talca:\ngd_osm_sf$osm_points -&gt; gd_pts\ngd_pts |&gt; subset(subset = !is.na(takeaway),\n select = c(osm_id, name, amenity, cuisine,\n  takeaway, geometry)) -&gt; gd_takeaways\ngd_takeaways\n\nSimple feature collection with 160 features and 5 fields\nGeometry type: POINT\nDimension:     XY\nBounding box:  xmin: 18.45562 ymin: 54.30241 xmax: 18.71603 ymax: 54.44475\nGeodetic CRS:  WGS 84\nFirst 10 features:\n               osm_id                    name    amenity           cuisine\n473433244   473433244              McDonald's  fast_food            burger\n473433245   473433245                     KFC  fast_food           chicken\n478756186   478756186              McDonald's  fast_food            burger\n746496055   746496055                   Costa       cafe       coffee_shop\n747182709   747182709                     KFC  fast_food           chicken\n1538112296 1538112296 Ping Pong ramen & sushi restaurant asian;ramen;sushi\n1693970318 1693970318                     KFC  fast_food           chicken\n1763555507 1763555507          Zielona Papuga restaurant          regional\n1777255606 1777255606          Piwnica Rajców restaurant              &lt;NA&gt;\n1783311488 1783311488             Kreska Mąki  fast_food             pizza\n           takeaway                  geometry\n473433244       yes  POINT (18.6005 54.38275)\n473433245       yes  POINT (18.60085 54.3827)\n478756186       yes POINT (18.58742 54.35775)\n746496055       yes  POINT (18.6487 54.34943)\n747182709       yes  POINT (18.6452 54.35604)\n1538112296      yes  POINT (18.5671 54.41832)\n1693970318      yes POINT (18.57906 54.35757)\n1763555507       no  POINT (18.6172 54.37657)\n1777255606       no POINT (18.65326 54.34866)\n1783311488      yes  POINT (18.58812 54.3596)",
    "crumbs": [
      "<span class='chapter-number'>2</span>  <span class='chapter-title'>Spatial data</span>"
    ]
  },
  {
    "objectID": "02_talk.html#sec-sd-crs",
    "href": "02_talk.html#sec-sd-crs",
    "title": "2  Spatial data",
    "section": "2.2 Coordinate reference systems",
    "text": "2.2 Coordinate reference systems\nSince 2019, the representation of coordinate reference systems (CRS) have stabilised in the well-known text format known as WKT2-2019, which is an international standard. The representation supports both two and three dimensional structures, and as implemented in open geospatial software (PROJ) uses definitions stored in a regularly updated database bundled with the software. The database also contains tables defining transformations between CRS, now often based on open access transformation grid files downloaded on-the-fly if required. In parts of the world subject to rapid tectonic movement (the old city centre of Talca, Chile was badly damaged by an earthquake in 2010), CRS change frequently if more by centimetres than by metres.\n\nst_crs(talca_sf)\n\nCoordinate Reference System:\n  User input: EPSG:4674 \n  wkt:\nGEOGCRS[\"SIRGAS 2000\",\n    DATUM[\"Sistema de Referencia Geocentrico para las AmericaS 2000\",\n        ELLIPSOID[\"GRS 1980\",6378137,298.257222101,\n            LENGTHUNIT[\"metre\",1]]],\n    PRIMEM[\"Greenwich\",0,\n        ANGLEUNIT[\"degree\",0.0174532925199433]],\n    CS[ellipsoidal,2],\n        AXIS[\"geodetic latitude (Lat)\",north,\n            ORDER[1],\n            ANGLEUNIT[\"degree\",0.0174532925199433]],\n        AXIS[\"geodetic longitude (Lon)\",east,\n            ORDER[2],\n            ANGLEUNIT[\"degree\",0.0174532925199433]],\n    USAGE[\n        SCOPE[\"unknown\"],\n        AREA[\"Latin America - SIRGAS 2000 by country\"],\n        BBOX[-59.87,-122.19,32.72,-25.28]],\n    ID[\"EPSG\",4674]]\n\n\nThe definition used for stored objects in the chilemapas package is the geographical CRS in decimal degrees called \"SIRGAS 2000\" based on the \"GRS 1980\" ellipsoid - geodetic reference system of 1980. The provided data have as is often the case swapped axes compared to the CRS definition. Most geographical information systems keep to x, y, that is easting, northing or longitude, latitude axis order. Before version 1.0, elevatr reverts to the legacy PROJ4 string representation seen in the summaries above.\nosmdata and OpenStreetMap appear to assume that all modern geographical coordinate reference systems use \"EPSG:4326\" as is said to apply to consumer global positioning systems (GPS) devices. This is somewhat accurate, but there is no fixed definition. The definition is usually updated locally for each major tectonic plate, so the WKT2-2019 representation of the CRS used here is as a datum ensemble, with at best two metre accuracy, often worse, as we are noe fourty years on from where the tectonic plates were when \"WGS 84 was agreed in 1984. Some surveyors have argued that all coordinate tuples should be timestamped, in order to permit the tracking of the movement of points across the earth’s surface and their vertical change as well.\n\nst_crs(talca_takeaways)\n\nCoordinate Reference System:\n  User input: EPSG:4326 \n  wkt:\nGEOGCRS[\"WGS 84\",\n    ENSEMBLE[\"World Geodetic System 1984 ensemble\",\n        MEMBER[\"World Geodetic System 1984 (Transit)\"],\n        MEMBER[\"World Geodetic System 1984 (G730)\"],\n        MEMBER[\"World Geodetic System 1984 (G873)\"],\n        MEMBER[\"World Geodetic System 1984 (G1150)\"],\n        MEMBER[\"World Geodetic System 1984 (G1674)\"],\n        MEMBER[\"World Geodetic System 1984 (G1762)\"],\n        ELLIPSOID[\"WGS 84\",6378137,298.257223563,\n            LENGTHUNIT[\"metre\",1]],\n        ENSEMBLEACCURACY[2.0]],\n    PRIMEM[\"Greenwich\",0,\n        ANGLEUNIT[\"degree\",0.0174532925199433]],\n    CS[ellipsoidal,2],\n        AXIS[\"geodetic latitude (Lat)\",north,\n            ORDER[1],\n            ANGLEUNIT[\"degree\",0.0174532925199433]],\n        AXIS[\"geodetic longitude (Lon)\",east,\n            ORDER[2],\n            ANGLEUNIT[\"degree\",0.0174532925199433]],\n    USAGE[\n        SCOPE[\"Horizontal component of 3D system.\"],\n        AREA[\"World.\"],\n        BBOX[-90,-180,90,180]],\n    ID[\"EPSG\",4326]]\n\n\nSo while the \"SIRGAS 2000\" object and the \"WGS 84 refer approximately to the same representation, some sf predicates and operations on geometries may see them as differing, as for example checking that the Talca take-aways found in the bounding box do lie within the municipality boundaries:\n\ntry(st_within(talca_takeaways, talca_sf))\n\nError in st_geos_binop(\"within\", x, y, sparse = sparse, prepared = prepared,  : \n  st_crs(x) == st_crs(y) is not TRUE\n\n\nSince we know that both are based on the\"GRS 1980\" ellipsoid, we can overwrite the CRS of the OpenStreetMap take-away outlets location output to bring it into agreement with \"SIRGAS 2000\", resulting in finding that all the outlets all lie within the municipality boundaries:\n\ntalca_sf |&gt; st_crs() -&gt; sirgas2000\ntalca_takeaways |&gt; st_set_crs(sirgas2000) |&gt;\n st_within(talca_sf) |&gt; unlist() |&gt; as.logical()\n\nWarning: st_crs&lt;- : replacing crs does not reproject data; use st_transform for\nthat\n\n\n [1] TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE\n\n\nAlves Costa et al. (2023) document current status for the development of SIRGAS, and helpfully show how an increase in ground GPS/GNSS (Global Navigation Satellite Systems from all providers) station density helps track terrestrial movement, which in parts of Chile exceeds 20mm per year. While the movement of the earth’s crust is one source of inaccuracy, another is measurement error, and yet another computational error from repeated use of trigonometrical functions and approximated transformation coefficients. A lack of clarity in defining CRS can lead to the wrong assignation of for example points to polygons.\nThe Universal Transverse Mercator projection (zone 19 south) is often used for central Chile, and this specific version uses the same \"SIRGAS 2000\" datum as the input data objects from chilemapas:\n\nst_crs(\"EPSG:31979\")\n\nCoordinate Reference System:\n  User input: EPSG:31979 \n  wkt:\nPROJCRS[\"SIRGAS 2000 / UTM zone 19S\",\n    BASEGEOGCRS[\"SIRGAS 2000\",\n        DATUM[\"Sistema de Referencia Geocentrico para las AmericaS 2000\",\n            ELLIPSOID[\"GRS 1980\",6378137,298.257222101,\n                LENGTHUNIT[\"metre\",1]]],\n        PRIMEM[\"Greenwich\",0,\n            ANGLEUNIT[\"degree\",0.0174532925199433]],\n        ID[\"EPSG\",4674]],\n    CONVERSION[\"UTM zone 19S\",\n        METHOD[\"Transverse Mercator\",\n            ID[\"EPSG\",9807]],\n        PARAMETER[\"Latitude of natural origin\",0,\n            ANGLEUNIT[\"degree\",0.0174532925199433],\n            ID[\"EPSG\",8801]],\n        PARAMETER[\"Longitude of natural origin\",-69,\n            ANGLEUNIT[\"degree\",0.0174532925199433],\n            ID[\"EPSG\",8802]],\n        PARAMETER[\"Scale factor at natural origin\",0.9996,\n            SCALEUNIT[\"unity\",1],\n            ID[\"EPSG\",8805]],\n        PARAMETER[\"False easting\",500000,\n            LENGTHUNIT[\"metre\",1],\n            ID[\"EPSG\",8806]],\n        PARAMETER[\"False northing\",10000000,\n            LENGTHUNIT[\"metre\",1],\n            ID[\"EPSG\",8807]]],\n    CS[Cartesian,2],\n        AXIS[\"(E)\",east,\n            ORDER[1],\n            LENGTHUNIT[\"metre\",1]],\n        AXIS[\"(N)\",north,\n            ORDER[2],\n            LENGTHUNIT[\"metre\",1]],\n    USAGE[\n        SCOPE[\"Engineering survey, topographic mapping.\"],\n        AREA[\"Brazil - between 72°W and 66°W, northern and southern hemispheres. In remainder of South America - between 72°W and 66°W, southern hemisphere, onshore and offshore.\"],\n        BBOX[-59.87,-72,2.15,-66]],\n    ID[\"EPSG\",31979]]\n\n\nIf we check to see which candidate coordinate operations are available, we see that in fact projection accuracy is as good as possible, because the datum definitions of the two CRS are the same:\n\nsf_proj_network(TRUE)\n\n[1] \"https://cdn.proj.org\"\n\nsf_proj_pipelines(\"EPSG:4674\", \"EPSG:31979\")\n\nCandidate coordinate operations found:  1 \nStrict containment:     FALSE \nAxis order auth compl:  FALSE \nSource:  EPSG:4674 \nTarget:  EPSG:31979 \nBest instantiable operation has accuracy: 0 m\nDescription: axis order change (2D) + UTM zone 19S \nDefinition:  +proj=pipeline +step +proj=unitconvert +xy_in=deg +xy_out=rad\n             +step +proj=utm +zone=19 +south +ellps=GRS80\n\n\nIf we replace the target CRS with \"SIRGAS-Chile 2021 UTM 19S\", sf_proj_pipelines still only finds one candidate, but because no datum transformation from \"SIRGAS 2000\" to \"SIRGAS-Chile 2021\" is found in the database, we must accept unknown ballpark accuracy:\n\nsf_proj_pipelines(\"EPSG:4674\", \"EPSG:20049\")\n\nCandidate coordinate operations found:  1 \nStrict containment:     FALSE \nAxis order auth compl:  FALSE \nSource:  EPSG:4674 \nTarget:  EPSG:20049 \nBest instantiable operation has only ballpark accuracy \nDescription: axis order change (2D) + Ballpark geographic offset from SIRGAS\n             2000 to SIRGAS-Chile 2021 + UTM zone 19S\nDefinition:  +proj=pipeline +step +proj=unitconvert +xy_in=deg +xy_out=rad\n             +step +proj=utm +zone=19 +south +ellps=GRS80\n\n\nMany national and international mapping agencies have provided open access transformation grids that PROJ can use on-the-fly (https://cdn.proj.org/), but neither Chile not SIRGAS have contributed any such grid so far. Grids are more accurate than three or seven parameter transformations because they allow local crustal deformations to be applied, rather than averaged over the whole area of application. Accuracy is now much more important as GPS/GNSS has become established in navigation, precision farming, construction, etc.\nLet us repeat the measurement of the area of Región del Maule after projection to \"UTM 19S\"\n\nmaule_sf |&gt; st_union() |&gt; st_transform(crs = \"EPSG:31979\") |&gt;\n st_area() |&gt; units::set_units(\"km2\")\n\n30314.34 [km^2]\n\n\nThe area is now more than 16 square kilometres greater than the area from Wikipedia, and the area calculated by s2 on the surface of the earth. All projections distort the rounded surface of the earth by squeezing the centre of the area of interest and stretching the edges to force it into planar form, so depending on the statutory regulations, all measured areas are approximate in one way or another.\nLet us now move to the CRS of the boundary of the county of Gdańsk:\n\nst_crs(gd_sf)\n\nCoordinate Reference System:\n  User input: EPSG:2180 \n  wkt:\nPROJCRS[\"ETRF2000-PL / CS92\",\n    BASEGEOGCRS[\"ETRF2000-PL\",\n        DATUM[\"ETRF2000 Poland\",\n            ELLIPSOID[\"GRS 1980\",6378137,298.257222101,\n                LENGTHUNIT[\"metre\",1]]],\n        PRIMEM[\"Greenwich\",0,\n            ANGLEUNIT[\"degree\",0.0174532925199433]],\n        ID[\"EPSG\",9702]],\n    CONVERSION[\"Poland CS92\",\n        METHOD[\"Transverse Mercator\",\n            ID[\"EPSG\",9807]],\n        PARAMETER[\"Latitude of natural origin\",0,\n            ANGLEUNIT[\"degree\",0.0174532925199433],\n            ID[\"EPSG\",8801]],\n        PARAMETER[\"Longitude of natural origin\",19,\n            ANGLEUNIT[\"degree\",0.0174532925199433],\n            ID[\"EPSG\",8802]],\n        PARAMETER[\"Scale factor at natural origin\",0.9993,\n            SCALEUNIT[\"unity\",1],\n            ID[\"EPSG\",8805]],\n        PARAMETER[\"False easting\",500000,\n            LENGTHUNIT[\"metre\",1],\n            ID[\"EPSG\",8806]],\n        PARAMETER[\"False northing\",-5300000,\n            LENGTHUNIT[\"metre\",1],\n            ID[\"EPSG\",8807]]],\n    CS[Cartesian,2],\n        AXIS[\"northing (x)\",north,\n            ORDER[1],\n            LENGTHUNIT[\"metre\",1]],\n        AXIS[\"easting (y)\",east,\n            ORDER[2],\n            LENGTHUNIT[\"metre\",1]],\n    USAGE[\n        SCOPE[\"Topographic mapping (medium and small scale).\"],\n        AREA[\"Poland - onshore and offshore.\"],\n        BBOX[49,14.14,55.93,24.15]],\n    ID[\"EPSG\",2180]]\n\n\nPoland currently uses the European Terrestrial Reference Frame (ETRF) and lies on a tectonic plate with little deformation activity, although the plate itself is moving up to 20mm a year. The projection \"ETRF2000-PL / CS92\" was adopted following the dissolution of the Warsaw Pact - mapping everywhere is driven at base by the needs of military operations.\nThe CRS of the take-away outlets is as for Talca:\n\nst_crs(gd_takeaways)\n\nCoordinate Reference System:\n  User input: EPSG:4326 \n  wkt:\nGEOGCRS[\"WGS 84\",\n    ENSEMBLE[\"World Geodetic System 1984 ensemble\",\n        MEMBER[\"World Geodetic System 1984 (Transit)\"],\n        MEMBER[\"World Geodetic System 1984 (G730)\"],\n        MEMBER[\"World Geodetic System 1984 (G873)\"],\n        MEMBER[\"World Geodetic System 1984 (G1150)\"],\n        MEMBER[\"World Geodetic System 1984 (G1674)\"],\n        MEMBER[\"World Geodetic System 1984 (G1762)\"],\n        ELLIPSOID[\"WGS 84\",6378137,298.257223563,\n            LENGTHUNIT[\"metre\",1]],\n        ENSEMBLEACCURACY[2.0]],\n    PRIMEM[\"Greenwich\",0,\n        ANGLEUNIT[\"degree\",0.0174532925199433]],\n    CS[ellipsoidal,2],\n        AXIS[\"geodetic latitude (Lat)\",north,\n            ORDER[1],\n            ANGLEUNIT[\"degree\",0.0174532925199433]],\n        AXIS[\"geodetic longitude (Lon)\",east,\n            ORDER[2],\n            ANGLEUNIT[\"degree\",0.0174532925199433]],\n    USAGE[\n        SCOPE[\"Horizontal component of 3D system.\"],\n        AREA[\"World.\"],\n        BBOX[-90,-180,90,180]],\n    ID[\"EPSG\",4326]]\n\n\nand the transformation pipeline from \"ETRF2000-PL / CS92\" to \"WGS 84\" has an accuracy of 1 metre:\n\nsf_proj_pipelines(\"EPSG:2180\", \"EPSG:4326\")\n\nCandidate coordinate operations found:  2 \nStrict containment:     FALSE \nAxis order auth compl:  FALSE \nSource:  EPSG:2180 \nTarget:  EPSG:4326 \nBest instantiable operation has accuracy: 1 m\nDescription: axis order change (2D) + Inverse of Poland CS92 + ETRF2000-PL\n             to WGS 84 (1) + axis order change (2D)\nDefinition:  +proj=pipeline +step +inv +proj=tmerc +lat_0=0 +lon_0=19\n             +k=0.9993 +x_0=500000 +y_0=-5300000 +ellps=GRS80\n             +step +proj=unitconvert +xy_in=rad +xy_out=deg\n\n\nSince none of these projections/transformations have required datum transformation, let us use the example of \"OSGB36 / British National Grid\" to \"WGS 84\". We can see that the \"Ordnance Survey of Great Britain 1936\" datum uses a different ellipsoid: \"Airy 1830\" from \"GRS 1980\":\n\nst_crs(\"EPSG:27700\")\n\nCoordinate Reference System:\n  User input: EPSG:27700 \n  wkt:\nPROJCRS[\"OSGB36 / British National Grid\",\n    BASEGEOGCRS[\"OSGB36\",\n        DATUM[\"Ordnance Survey of Great Britain 1936\",\n            ELLIPSOID[\"Airy 1830\",6377563.396,299.3249646,\n                LENGTHUNIT[\"metre\",1]]],\n        PRIMEM[\"Greenwich\",0,\n            ANGLEUNIT[\"degree\",0.0174532925199433]],\n        ID[\"EPSG\",4277]],\n    CONVERSION[\"British National Grid\",\n        METHOD[\"Transverse Mercator\",\n            ID[\"EPSG\",9807]],\n        PARAMETER[\"Latitude of natural origin\",49,\n            ANGLEUNIT[\"degree\",0.0174532925199433],\n            ID[\"EPSG\",8801]],\n        PARAMETER[\"Longitude of natural origin\",-2,\n            ANGLEUNIT[\"degree\",0.0174532925199433],\n            ID[\"EPSG\",8802]],\n        PARAMETER[\"Scale factor at natural origin\",0.9996012717,\n            SCALEUNIT[\"unity\",1],\n            ID[\"EPSG\",8805]],\n        PARAMETER[\"False easting\",400000,\n            LENGTHUNIT[\"metre\",1],\n            ID[\"EPSG\",8806]],\n        PARAMETER[\"False northing\",-100000,\n            LENGTHUNIT[\"metre\",1],\n            ID[\"EPSG\",8807]]],\n    CS[Cartesian,2],\n        AXIS[\"(E)\",east,\n            ORDER[1],\n            LENGTHUNIT[\"metre\",1]],\n        AXIS[\"(N)\",north,\n            ORDER[2],\n            LENGTHUNIT[\"metre\",1]],\n    USAGE[\n        SCOPE[\"Engineering survey, topographic mapping.\"],\n        AREA[\"United Kingdom (UK) - offshore to boundary of UKCS within 49°45'N to 61°N and 9°W to 2°E; onshore Great Britain (England, Wales and Scotland). Isle of Man onshore.\"],\n        BBOX[49.75,-9.01,61.01,2.01]],\n    ID[\"EPSG\",27700]]\n\n\nIf we then query the database to find the most accurate transformation with enabled access to transformation grids, we can achieve 1 metre:\n\nsf_proj_pipelines(\"EPSG:27700\", \"EPSG:4326\")\n\nCandidate coordinate operations found:  9 \nStrict containment:     FALSE \nAxis order auth compl:  FALSE \nSource:  EPSG:27700 \nTarget:  EPSG:4326 \nBest instantiable operation has accuracy: 1 m\nDescription: Inverse of British National Grid + OSGB36 to WGS 84 (9) + axis\n             order change (2D)\nDefinition:  +proj=pipeline +step +inv +proj=tmerc +lat_0=49 +lon_0=-2\n             +k=0.9996012717 +x_0=400000 +y_0=-100000\n             +ellps=airy +step +proj=hgridshift\n             +grids=uk_os_OSTN15_NTv2_OSGBtoETRS.tif +step\n             +proj=unitconvert +xy_in=rad +xy_out=deg\n\n\nThe parts of the grid file uk_os_OSTN15_NTv2_OSGBtoETRS.tif needed for the data in question can be downloaded automatically on-the-fly if PROJ network access is enabled, and cached locally for any software using PROJ for handling CRS; the grid file offsets are shown in Figure 2.4, page 25 of Pebesma and Bivand (2023).\n\n\n\n\nAlves Costa, Sonia M., Laura Sánchez, Diego Piñón, José A. Tarrio Mosquera, Gabriel Guimarães, Demián D. Gómez, Hermann Drewes, et al. 2023. “Status of the SIRGAS Reference Frame: Recent Developments and New Challenges.” In International Association of Geodesy Symposia, 1–13. Berlin, Heidelberg: Springer Berlin Heidelberg. https://doi.org/10.1007/1345_2023_227.\n\n\nBivand, Roger. 2022. “Analytical Environments.” In Handbook of Spatial Analysis in the Social Sciences, edited by Sergio J. Rey and Rachel Franklin, 36–63. Camberley, UK: Edward Elgar. https://hdl.handle.net/11250/3065981.\n\n\nDyba, Krzysztof, and Jakub Nowosad. 2021. “Rgugik: Search and Retrieve Spatial Data from the Polish Head Office of Geodesy and Cartography in r.” Journal of Open Source Software 6 (59): 2948. https://doi.org/10.21105/joss.02948.\n\n\nLovelace, Robin, Jakub Nowosad, and Jannes Muenchow. 2019. Geocomputation with R. CRC Press.https://r.geocompx.org/ .\n\n\nPadgham, Mark, Bob Rudis, Robin Lovelace, and Maëlle Salmon. 2017. “Osmdata.” Journal of Open Source Software 2 (14): 305. https://doi.org/10.21105/joss.00305.\n\n\nPebesma, Edzer, and Roger Bivand. 2023. Spatial Data Science with Applications in R. Boca Raton, FL: CRC Press.\n\n\nRey, Sergio, Dani Arribas-Bel, and Levi J. Wolf. 2023. Geographic Data Science with Python. Boca Raton, FL: CRC Press. https://geographicdata.science.",
    "crumbs": [
      "<span class='chapter-number'>2</span>  <span class='chapter-title'>Spatial data</span>"
    ]
  },
  {
    "objectID": "03_talk.html",
    "href": "03_talk.html",
    "title": "3  Working with spatial data",
    "section": "",
    "text": "3.1 Merging spatial data\nAs was mentioned above in section Section 2.1, spatial vector geometries are most often furnished with identification keys, permitting other data using the same key or index identifiers to be added correctly. In Poland, they have been known as \"TERYT\", and are fairly stable over time, though border changes can occur, with new key values appearing and old values ceasing to be used, leading to breaks of series. The rgugik package contains a data object listing these keys together with unit names, but matching on names can be troublesome. First we will subset this object to the Pomeranian voivodeship:\nlibrary(rgugik)\nlibrary(sf)\n\nLinking to GEOS 3.12.1, GDAL 3.9.0beta1, PROJ 9.4.0; sf_use_s2() is TRUE\n\nsubstring(commune_names$TERYT, 1, 2) -&gt; vpom\ncommune_names |&gt; subset(subset = vpom == \"22\") -&gt; pom0\nthen retrieve the boundaries of municipalities in Pomerania using \"TERYT\" rather than using the names of municipalities, which are duplicated in other voivodeships:\nborders_get(TERYT = pom0$TERYT) -&gt; pom\nMerging the pom object containing the \"TERYT\" keys and municipality names, with pom_sf, including the \"TERYT\" keys and municipality boundaries is easy, as the keys are both character objects - this matters because some keys may start with 0, zero, and be wrongly read as integers, dropping leading zeros. The key for this voivodeship is \"22\", so this problem is not encountered here, but often occurs. Should an identifying key with leading zeros be read as integer, it can be restored using base::formatC after checking the required string width:\nID &lt;- as.integer(\"0012345\") \nstr(ID)\n\n int 12345\n\nformatC(ID, format=\"d\", width=7, flag=\"0\")\n\n[1] \"0012345\"\nNote that the \"TERYT\" key values returned in the pom_sf object include an underscore between the six digit territorial code and the trailing digit expressing the type of municipality.\ndim(pom)\n\n[1] 123   2\n\npom |&gt; sapply(class) |&gt; str()\n\nList of 2\n $ TERYT: chr \"character\"\n $ geom : chr [1:2] \"sfc_MULTIPOLYGON\" \"sfc\"\n\nstr(pom$TERYT)\n\n chr [1:123] \"226401_1\" \"221101_1\" \"221106_2\" \"220605_2\" \"221207_2\" ...\n\nstr(pom0)\n\nClasses 'tbl_df', 'tbl' and 'data.frame':   123 obs. of  2 variables:\n $ NAME : chr  \"Sopot\" \"Hel\" \"Krokowa\" \"Liniewo\" ...\n $ TERYT: chr  \"2264011\" \"2211011\" \"2211062\" \"2206052\" ...\nThe underscore needs to be removed before finally checking that they match:\npom$TERYT &lt;- sub(\"_\", \"\", pom$TERYT)\nany(is.na(match(pom$TERYT, pom0$TERYT)))\n\n[1] FALSE\nFinally, the merging operation may be carried out:\npom |&gt; merge(pom0, by = \"TERYT\") -&gt; pom1 \npom1\n\nSimple feature collection with 123 features and 2 fields\nGeometry type: MULTIPOLYGON\nDimension:     XY\nBounding box:  xmin: 350809.9 ymin: 626314.8 xmax: 542048.1 ymax: 775019.1\nProjected CRS: ETRF2000-PL / CS92\nFirst 10 features:\n     TERYT            NAME                       geometry\n1  2201012     Borzytuchom MULTIPOLYGON (((392568.1 69...\n2  2201023           Bytów MULTIPOLYGON (((399745.2 68...\n3  2201032 Czarna Dąbrówka MULTIPOLYGON (((415365.5 72...\n4  2201042     Kołczygłowy MULTIPOLYGON (((382369 6921...\n5  2201052         Lipnica MULTIPOLYGON (((392500.3 67...\n6  2201063         Miastko MULTIPOLYGON (((366331.6 67...\n7  2201072        Parchowo MULTIPOLYGON (((414238.3 69...\n8  2201082     Studzienice MULTIPOLYGON (((405862.1 68...\n9  2201092     Trzebielino MULTIPOLYGON (((376562.5 69...\n10 2201102        Tuchomie MULTIPOLYGON (((384623.5 68...",
    "crumbs": [
      "<span class='chapter-number'>3</span>  <span class='chapter-title'>Working with spatial data</span>"
    ]
  },
  {
    "objectID": "03_talk.html#sec-sd-merge",
    "href": "03_talk.html#sec-sd-merge",
    "title": "3  Working with spatial data",
    "section": "",
    "text": "3.1.1 Using files from Poland’s Local Data Bank (BDL)\nHaving methodically made a first merge, we can move forward with three files at the municipality level from Statistics Poland’s local data bank. These were exported as comma (or semicolon) separated value (CSV) files on February 15, 2024 - dates matter, as online data banks update their contents as inaccuracies are detected. Currently, no package provides direct access to this data bank, and for moderate data volumes, registration is required. The first file is semicolon separated, and contains population data by age group and sex (category K3, group G7, subgroup P2577) for the end of the second half-year 2022:\n\npop22 &lt;- read.csv(\"Datasets/sd/LUDN_2577_2022.csv\", sep=\";\")\n\nAs with most such data, the column names need adjustment. On reading, reserved characters in R are replaced by dots, and for further work, shorter column names are helpful. Current R versions support multibyte characters across all platforms, but some files with single-byte characters can be encountered, in which case judicious use of base::iconv may be needed.\n\nsapply(pop22, class)\n\n                                                                                 Kod \n                                                                           \"integer\" \n                                                                               Nazwa \n                                                                         \"character\" \n                   w.wieku.przedprodukcyjnym...14.lat.i.mniej.mężczyźni.2022..osoba. \n                                                                           \"integer\" \n                     w.wieku.przedprodukcyjnym...14.lat.i.mniej.kobiety.2022..osoba. \n                                                                           \"integer\" \nw.wieku.produkcyjnym..15.59.lat.kobiety..15.64.lata.mężczyźni.mężczyźni.2022..osoba. \n                                                                           \"integer\" \n  w.wieku.produkcyjnym..15.59.lat.kobiety..15.64.lata.mężczyźni.kobiety.2022..osoba. \n                                                                           \"integer\" \n                                       w.wieku.poprodukcyjnym.mężczyźni.2022..osoba. \n                                                                           \"integer\" \n                                         w.wieku.poprodukcyjnym.kobiety.2022..osoba. \n                                                                           \"integer\" \n                                                                                   X \n                                                                           \"logical\" \n\npop22$Kod &lt;- as.character(pop22$Kod)\nnames(pop22)[3:8] &lt;- c(\"m_u15\", \"f_u15\",\n \"m_15_64\", \"f_15_59\", \"m_o65\", \"k_o60\")\npop22$type &lt;- factor(substring(pop22$Kod, 7, 7),\n levels = c(\"1\", \"2\", \"3\"),\n labels = c(\"urban\", \"rural\", \"urban_rural\"))\nnames(pop22)\n\n [1] \"Kod\"     \"Nazwa\"   \"m_u15\"   \"f_u15\"   \"m_15_64\" \"f_15_59\" \"m_o65\"  \n [8] \"k_o60\"   \"X\"       \"type\"   \n\n\nThe key column was read as integer, so needs correcting; otherwise the remaining columns seem to be formatted acceptably. A new column is created as a factor showing the type of municipality, as a factor In addition, we The \"X\" column contains no data, and is dropped from the merging operation. We could overwrite the cumulating object on merge; here we choose to create a new object at each merge. The key is called \"TERYT\" in pom_sf and \"Kod\" in pop92, specified with by.x and by.y arguments:\n\npom1 |&gt; merge(pop22[, -9], by.x = \"TERYT\",\n by.y = \"Kod\") -&gt; pom2\npom2\n\nSimple feature collection with 123 features and 10 fields\nGeometry type: MULTIPOLYGON\nDimension:     XY\nBounding box:  xmin: 350809.9 ymin: 626314.8 xmax: 542048.1 ymax: 775019.1\nProjected CRS: ETRF2000-PL / CS92\nFirst 10 features:\n     TERYT            NAME               Nazwa m_u15 f_u15 m_15_64 f_15_59\n1  2201012     Borzytuchom     Borzytuchom (2)   406   387    1181    1039\n2  2201023           Bytów           Bytów (3)  2306  2162    8236    7373\n3  2201032 Czarna Dąbrówka Czarna Dąbrówka (2)   610   596    1859    1556\n4  2201042     Kołczygłowy     Kołczygłowy (2)   387   308    1425    1203\n5  2201052         Lipnica         Lipnica (2)   531   449    1702    1463\n6  2201063         Miastko         Miastko (3)  1424  1331    6058    5021\n7  2201072        Parchowo        Parchowo (2)   416   382    1237    1106\n8  2201082     Studzienice     Studzienice (2)   346   352    1206    1066\n9  2201092     Trzebielino     Trzebielino (2)   350   299    1213     998\n10 2201102        Tuchomie        Tuchomie (2)   400   366    1462    1265\n   m_o65 k_o60        type                       geometry\n1    172   301       rural MULTIPOLYGON (((392568.1 69...\n2   1794  3250 urban_rural MULTIPOLYGON (((399745.2 68...\n3    406   657       rural MULTIPOLYGON (((415365.5 72...\n4    293   464       rural MULTIPOLYGON (((382369 6921...\n5    389   611       rural MULTIPOLYGON (((392500.3 67...\n6   1430  2773 urban_rural MULTIPOLYGON (((366331.6 67...\n7    243   414       rural MULTIPOLYGON (((414238.3 69...\n8    249   406       rural MULTIPOLYGON (((405862.1 68...\n9    250   446       rural MULTIPOLYGON (((376562.5 69...\n10   270   420       rural MULTIPOLYGON (((384623.5 68...\n\n\nHaving added the population group counts by sex for the Pomeranian municipalities, we create a new column \"pop\" summing the total population at year end 2022. We then calculate municipality areas, and divide population by area (in square kilometres) to get the population density:\n\npom2 |&gt; st_drop_geometry() |&gt; subset(select = 4:9) |&gt;\n apply(1, function(x) sum(x)) -&gt; pom2$pop\npom2 |&gt; st_area() |&gt;\n units::set_units(\"km2\") -&gt; pom2$area_km2\npom2 |&gt; st_drop_geometry() |&gt;\n subset(select = c(pop, area_km2)) |&gt;\n apply(1, function(x) x[1]/x[2]) -&gt; pom2$density\n pom2\n\nSimple feature collection with 123 features and 13 fields\nGeometry type: MULTIPOLYGON\nDimension:     XY\nBounding box:  xmin: 350809.9 ymin: 626314.8 xmax: 542048.1 ymax: 775019.1\nProjected CRS: ETRF2000-PL / CS92\nFirst 10 features:\n     TERYT            NAME               Nazwa m_u15 f_u15 m_15_64 f_15_59\n1  2201012     Borzytuchom     Borzytuchom (2)   406   387    1181    1039\n2  2201023           Bytów           Bytów (3)  2306  2162    8236    7373\n3  2201032 Czarna Dąbrówka Czarna Dąbrówka (2)   610   596    1859    1556\n4  2201042     Kołczygłowy     Kołczygłowy (2)   387   308    1425    1203\n5  2201052         Lipnica         Lipnica (2)   531   449    1702    1463\n6  2201063         Miastko         Miastko (3)  1424  1331    6058    5021\n7  2201072        Parchowo        Parchowo (2)   416   382    1237    1106\n8  2201082     Studzienice     Studzienice (2)   346   352    1206    1066\n9  2201092     Trzebielino     Trzebielino (2)   350   299    1213     998\n10 2201102        Tuchomie        Tuchomie (2)   400   366    1462    1265\n   m_o65 k_o60        type                       geometry   pop        area_km2\n1    172   301       rural MULTIPOLYGON (((392568.1 69...  3486 108.5179 [km^2]\n2   1794  3250 urban_rural MULTIPOLYGON (((399745.2 68... 25121 196.6898 [km^2]\n3    406   657       rural MULTIPOLYGON (((415365.5 72...  5684 297.6368 [km^2]\n4    293   464       rural MULTIPOLYGON (((382369 6921...  4080 169.9070 [km^2]\n5    389   611       rural MULTIPOLYGON (((392500.3 67...  5145 308.6255 [km^2]\n6   1430  2773 urban_rural MULTIPOLYGON (((366331.6 67... 18037 466.1825 [km^2]\n7    243   414       rural MULTIPOLYGON (((414238.3 69...  3798 131.0944 [km^2]\n8    249   406       rural MULTIPOLYGON (((405862.1 68...  3625 176.0147 [km^2]\n9    250   446       rural MULTIPOLYGON (((376562.5 69...  3556 225.0631 [km^2]\n10   270   420       rural MULTIPOLYGON (((384623.5 68...  4183 110.0614 [km^2]\n     density\n1   32.12374\n2  127.71885\n3   19.09710\n4   24.01314\n5   16.67069\n6   38.69085\n7   28.97149\n8   20.59487\n9   15.80001\n10  38.00605\n\n\nThe next file contains counts of farms from the Agricultural census reporting farm income from the farm (category K34, group G637, subgroup P4139). While this file was exported from the local data bank in the same way as the previous one, it is comma-separated:\n\nag20 &lt;- read.csv(\"Datasets/sd/POWS_4139_2020.csv\", sep=\",\")\n\nAgain, column names require simplification, but here there is no spurious \"X\" column - we just drop the municipality name from the merge:\n\nag20$Kod &lt;- as.character(ag20$Kod)\nnames(ag20)[3:7] &lt;- c(\"farm\", \"non_farm_business\",\n \"non_farm_wages\", \"pension\", \"other_non_wage\")\npom2 |&gt; merge(ag20[,-2], by.x = \"TERYT\",\n by.y = \"Kod\") -&gt; pom3\n\nFinally, and because the agricultural census data are counts of farms, we need counts of inhabited dwellings from the population census 2021 (category K31, group G645, subgroup P4383), especially for urban municipalities; the merging process follows the lines of those above:\n\ncen21 &lt;- read.csv(\"Datasets/sd/NARO_4383_2021.csv\", sep=\";\")\n\n\ncen21$Kod &lt;- as.character(cen21$Kod)\nnames(cen21)[3] &lt;- \"dwellings\"\npom3 |&gt; merge(cen21[, -c(2, 4)], by.x = \"TERYT\",\n by.y = \"Kod\") -&gt; pom4\nnames(pom4)\n\n [1] \"TERYT\"             \"NAME\"              \"Nazwa\"            \n [4] \"m_u15\"             \"f_u15\"             \"m_15_64\"          \n [7] \"f_15_59\"           \"m_o65\"             \"k_o60\"            \n[10] \"type\"              \"pop\"               \"area_km2\"         \n[13] \"density\"           \"farm\"              \"non_farm_business\"\n[16] \"non_farm_wages\"    \"pension\"           \"other_non_wage\"   \n[19] \"dwellings\"         \"geometry\"         \n\n\nIn conclusion, for completeness, let us assign aggregation levels to the newly merged values:\n\nagrs &lt;- factor(c(rep(\"identity\", 3), rep(\"aggregate\", 6),\n \"identity\", rep(\"aggregate\", 9)),\n levels=c(\"constant\", \"aggregate\", \"identity\"))\nnames(agrs) &lt;- names(st_drop_geometry(pom4))\npom4 |&gt; st_set_agr(agrs) -&gt; pom5\n\n\n\n3.1.2 Using API from Poland’s Local Data Bank (BDL)\nThe bdl package offers a limited Application Programming Interface (API) to Poland’s Local Data Bank (BDL), limited chiefly by the very tight limits on queries per time interval. Details can be found in the BDL API manual. This means that the user should think through carefully the queries required, and should be familiar with the categories and observational units (local government units and time in years) used. These give very fine-grained access to the underlying data, very similar in structure to that of other providers of official statistics. It is also recommended that a private API key be acquired and used (here kept in a local environment variable to prevent its display online breaking the privacy requirement of the data provider):\n\nlibrary(bdl)\nBDL_key &lt;- Sys.getenv(\"BDL_key_RSB\")\noptions(bdl.api_private_key=BDL_key)\n\nIn order to proceed, we need first to determine the level code for voivodeship units, querying BDL for defined levels, and storing level values for voivodeships and municipalities:\n\n(levs &lt;- get_levels(lang=\"en\"))\n\n# A tibble: 8 × 2\n     id name                             \n  &lt;int&gt; &lt;chr&gt;                            \n1     0 Poziom Polski                    \n2     1 Poziom Makroregionów             \n3     2 Poziom Województw                \n4     3 Poziom Regionów                  \n5     4 Poziom Podregionów               \n6     5 Poziom Powiatów                  \n7     6 Poziom Gmin                      \n8     7 Poziom miejscowości statystycznej\n\nlevs |&gt; as.data.frame() |&gt;\n subset(name==\"Poziom Województw\", select=id, drop=TRUE) -&gt; wlev \nlevs |&gt; as.data.frame() |&gt;\n subset(name==\"Poziom Gmin\", select=id, drop=TRUE) -&gt; glev \n\nGiven the voivodeship level, we can find the 12-character identifier for the Pomeranian voivodeship; BDL uses 12 characters rather tha 7 used in TERYT above, simply interjecting identifiers for other level units (TERYT is characters 3:4 and 8:12):\n\n(units_lev &lt;- get_units(level=wlev, lang=\"en\"))\n\nWarning: Unit metadata has changed during searched year interval. Check\ndescription using `unit_info()` or `unit_locality_info()` for localities.\n\n\n# A tibble: 16 × 5\n   id           name                parentId     level unitHasChanged\n   &lt;chr&gt;        &lt;chr&gt;               &lt;chr&gt;        &lt;int&gt; &lt;lgl&gt;         \n 1 011200000000 MAŁOPOLSKIE         010000000000     2 TRUE          \n 2 012400000000 ŚLĄSKIE             010000000000     2 TRUE          \n 3 020800000000 LUBUSKIE            020000000000     2 FALSE         \n 4 023000000000 WIELKOPOLSKIE       020000000000     2 FALSE         \n 5 023200000000 ZACHODNIOPOMORSKIE  020000000000     2 FALSE         \n 6 030200000000 DOLNOŚLĄSKIE        030000000000     2 FALSE         \n 7 031600000000 OPOLSKIE            030000000000     2 FALSE         \n 8 040400000000 KUJAWSKO-POMORSKIE  040000000000     2 FALSE         \n 9 042200000000 POMORSKIE           040000000000     2 FALSE         \n10 042800000000 WARMIŃSKO-MAZURSKIE 040000000000     2 FALSE         \n11 051000000000 ŁÓDZKIE             050000000000     2 FALSE         \n12 052600000000 ŚWIĘTOKRZYSKIE      050000000000     2 FALSE         \n13 060600000000 LUBELSKIE           060000000000     2 FALSE         \n14 061800000000 PODKARPACKIE        060000000000     2 TRUE          \n15 062000000000 PODLASKIE           060000000000     2 FALSE         \n16 071400000000 MAZOWIECKIE         070000000000     2 FALSE         \n\nunits_lev |&gt; as.data.frame() |&gt;\n subset(name==\"POMORSKIE\", select=id, drop=TRUE) -&gt; pom_id\n\nLet us see which municipalities belonged to Pomerania in 2020:\n\npom_gminy &lt;- get_units(parentId=pom_id, level=glev, year=2020)\n\nWarning: Unit metadata has changed during searched year interval. Check\ndescription using `unit_info()` or `unit_locality_info()` for localities.\n\nnrow(pom_gminy)\n\n[1] 175\n\n\nIt turns out that some municipalities had seen changes, including changes in categorisation into urban, rural and urban-rural, and some reported here are parts classed as 4 or 5, rather than 1, 2 or 3. If we see a warning indicating that something may not be as we assume, we need more detailed information, returning objects for each municipality ID. The returned object is a list showing the years for which the ID is valid, and the category that it belonged to in those years. We create logical variables expressing whether the municipality ID is valid for our period of interest (2020-2022), and whether the category is 1, 2 or 3:\n\ngminy_details &lt;- sapply(pom_gminy$id, unit_info)\nnow &lt;- sapply(gminy_details, function(x)\n all(2020:2022 %in% x$years))\nkind123 &lt;- sapply(gminy_details, function(x)\n as.integer(x$kind) &lt; 4L)\nnk &lt;- now & kind123\npom_gminy0 &lt;- gminy_details[nk]\npom_gminy &lt;- do.call(\"rbind\", lapply(pom_gminy0, \n function(x) data.frame(x[c(1, 2, 5)])))\nnrow(pom_gminy)\n\n[1] 123\n\n\nFinally we use the logical variables to subset the specification of the municipalities, retaining ID, name and its category as urban, rural or urban-rural.\nThe capital letters K, G and P are hierarchical, expressing the high-level categories of data topics, medium-level groups of data topics within each category, and sub-groups of data topics within each group. We can list the categories in BDL:\n\nget_subjects(lang=\"en\")\n\n# A tibble: 33 × 5\n   id    name                                       hasVariables children levels\n   &lt;chr&gt; &lt;chr&gt;                                      &lt;lgl&gt;        &lt;list&gt;   &lt;list&gt;\n 1 K1    TERRITORIAL DIVISION                       FALSE        &lt;chr&gt;    &lt;int&gt; \n 2 K2    LOCAL GOVERNMENT                           FALSE        &lt;chr&gt;    &lt;int&gt; \n 3 K3    POPULATION                                 FALSE        &lt;chr&gt;    &lt;int&gt; \n 4 K4    LABOUR MARKET                              FALSE        &lt;chr&gt;    &lt;int&gt; \n 5 K6    AGRICULTURE                                FALSE        &lt;chr&gt;    &lt;int&gt; \n 6 K8    TRANSPORT AND COMMUNICATION                FALSE        &lt;chr&gt;    &lt;int&gt; \n 7 K9    ENVIRONMENTAL PROTECTION                   FALSE        &lt;chr&gt;    &lt;int&gt; \n 8 K10   SCIENCE AND TECHNOLOGY. INFORMATION SOCIE… FALSE        &lt;chr&gt;    &lt;int&gt; \n 9 K11   HOUSING ECONOMY AND MUNICIPAL INFRASTRUCT… FALSE        &lt;chr&gt;    &lt;int&gt; \n10 K12   INDUSTRY AND CONSTRUCTION                  FALSE        &lt;chr&gt;    &lt;int&gt; \n# ℹ 23 more rows\n\n\nSince we are interested in K3 population, among other things, we can list its contents:\n\nget_subjects(\"K3\", lang=\"en\")\n\n# A tibble: 7 × 6\n  id    parentId name                               hasVariables children levels\n  &lt;chr&gt; &lt;chr&gt;    &lt;chr&gt;                              &lt;lgl&gt;        &lt;list&gt;   &lt;list&gt;\n1 G7    K3       POPULATION                         FALSE        &lt;chr&gt;    &lt;int&gt; \n2 G8    K3       INTERNAL AND FOREIGN MIGRATIONS    FALSE        &lt;chr&gt;    &lt;int&gt; \n3 G10   K3       PRIVATE HOUSEHOLDS                 FALSE        &lt;chr&gt;    &lt;int&gt; \n4 G534  K3       BIRTHS AND DEATHS                  FALSE        &lt;chr&gt;    &lt;int&gt; \n5 G535  K3       MARRIAGES, DIVORCES AND SEPARATIO… FALSE        &lt;chr&gt;    &lt;int&gt; \n6 G564  K3       ARCHIVAL DATA                      FALSE        &lt;chr&gt;    &lt;int&gt; \n7 G655  K3       POPULATION PROJECTION 2023-2060    FALSE        &lt;chr&gt;    &lt;int&gt; \n\n\nand go deeper to G7 to see that to access population counts in pre-working, working, and post-working age groups are given in P2577:\n\nget_subjects(\"G7\", lang=\"en\")\n\n# A tibble: 20 × 6\n   id    parentId name                              hasVariables children levels\n   &lt;chr&gt; &lt;chr&gt;    &lt;chr&gt;                             &lt;lgl&gt;        &lt;list&gt;   &lt;list&gt;\n 1 P1336 G7       Population by place of residence… TRUE         &lt;list&gt;   &lt;int&gt; \n 2 P1341 G7       Population by singular age and s… TRUE         &lt;list&gt;   &lt;int&gt; \n 3 P1342 G7       Population at pre-working (up to… TRUE         &lt;list&gt;   &lt;int&gt; \n 4 P2137 G7       Population by sex and age group   TRUE         &lt;list&gt;   &lt;int&gt; \n 5 P2425 G7       The population density and indic… TRUE         &lt;list&gt;   &lt;int&gt; \n 6 P2426 G7       Demographic dependency ratio      TRUE         &lt;list&gt;   &lt;int&gt; \n 7 P2427 G7       The share of the population by t… TRUE         &lt;list&gt;   &lt;int&gt; \n 8 P2462 G7       Population by sex (half-yearly d… TRUE         &lt;list&gt;   &lt;int&gt; \n 9 P2463 G7       Urban population in % of total p… TRUE         &lt;list&gt;   &lt;int&gt; \n10 P2577 G7       Population at pre-working (up to… TRUE         &lt;list&gt;   &lt;int&gt; \n11 P2730 G7       Life expectancy                   TRUE         &lt;list&gt;   &lt;int&gt; \n12 P2914 G7       Population in municipalities wit… TRUE         &lt;list&gt;   &lt;int&gt; \n13 P3361 G7       Population at pre-working (up to… TRUE         &lt;list&gt;   &lt;int&gt; \n14 P3429 G7       Femininity ratio                  TRUE         &lt;list&gt;   &lt;int&gt; \n15 P3447 G7       Population by functionality age … TRUE         &lt;list&gt;   &lt;int&gt; \n16 P3472 G7       Population by singular age and s… TRUE         &lt;list&gt;   &lt;int&gt; \n17 P3813 G7       Median age of population by sex … TRUE         &lt;list&gt;   &lt;int&gt; \n18 P3814 G7       Median age of population by sex   TRUE         &lt;list&gt;   &lt;int&gt; \n19 P3895 G7       Healthy life expectancy           TRUE         &lt;list&gt;   &lt;int&gt; \n20 P3991 G7       Usual residence population at pr… TRUE         &lt;list&gt;   &lt;int&gt; \n\n\nFrom sub-group, we next extract the table of variables, then saving the variable IDs to use for the query; we keep the descriptive table because it gives us the name of each variable in the table:\n\n(pop_persons &lt;- get_variables(\"P2577\", lang=\"en\"))\n\n# A tibble: 12 × 7\n      id subjectId n1                  n2    level measureUnitId measureUnitName\n   &lt;int&gt; &lt;chr&gt;     &lt;chr&gt;               &lt;chr&gt; &lt;int&gt;         &lt;int&gt; &lt;chr&gt;          \n 1 72283 P2577     at pre-working age… fema…     6            26 person         \n 2 72284 P2577     at working age: 15… fema…     6            26 person         \n 3 72285 P2577     at post-working age fema…     6            26 person         \n 4 72286 P2577     total               males     6            26 person         \n 5 72287 P2577     at pre-working age… males     6            26 person         \n 6 72288 P2577     at working age: 15… males     6            26 person         \n 7 72289 P2577     at post-working age males     6            26 person         \n 8 72290 P2577     total               total     6            26 person         \n 9 72291 P2577     at pre-working age… total     6            26 person         \n10 72292 P2577     at working age: 15… total     6            26 person         \n11 72293 P2577     at post-working age total     6            26 person         \n12 72294 P2577     total               fema…     6            26 person         \n\npop_pre_post_ids &lt;- as.character(pop_persons$id)\n\nIterating over the vector of variable IDs, we extract the single variables for multiple units for the required year - omitting the year reports all years. The get_data_by_variable call is one query, so using it rather than get_data_by_unit iterating over units is advantageous since the query count per unit time is policed vigourously, but instead of reporting only for 123 units, the call includes superfluous units:\n\nres_pop &lt;- vector(mode=\"list\", length=length(pop_pre_post_ids))\nnames(res_pop) &lt;- pop_pre_post_ids\nfor (i in seq(along=pop_pre_post_ids)) res_pop[[i]] &lt;- try(\n    get_data_by_variable(unitParentId=pom_id, level=glev,\n     varId = pop_pre_post_ids[i], year=2021)\n    )\nres_pop &lt;- lapply(res_pop, function(x) x[match(pom_gminy$id, x$id),])\n\nThe attrId values can indicate the need to replace the value reported with NA, as some 0 values are set as such because of confidentiality constraints; the attributes have these interpretations:\n\nget_attributes(lang=\"en\")\n\n# A tibble: 18 × 4\n      id name    symbol description                                             \n   &lt;int&gt; &lt;chr&gt;   &lt;chr&gt;  &lt;chr&gt;                                                   \n 1     0 0       \" \"    \"\"                                                      \n 2     1 value   \" \"    \"\"                                                      \n 3     3 value   \"k\"    \"Aggregate may be incomplete\"                           \n 4     4 . lub 0 \"x\"    \"Data not available, classified data (statistical confi…\n 5     7 0       \"a\"    \"Value less then approved presentation format\"          \n 6     9 value   \"s\"    \"Preliminary estimates\"                                 \n 7    11 value   \"M\"    \"Methodological changes\"                                \n 8    13 value   \"K\"    \"Methodological changes, aggregate may be incomplete\"   \n 9    14 . lub 0 \"X\"    \"Methodological changes, data not available, classified…\n10    15 -       \" \"    \"The '-' sign means no information due to: changes in t…\n11    17 0       \"A\"    \"Methodological changes, value less then approved prese…\n12    20 value   \"v\"    \"Low-precision data\"                                    \n13    21 value   \"v\"    \"Low-precision data\"                                    \n14    50 - or 0  \"n\"    \"Data is not available yet, will be available\"          \n15    91 . lub 0 \"x\"    \"Data not available, classified data (statistical confi…\n16    94 0       \"z\"    \"Significant value, the zero result of non-zero input d…\n17    97 value   \"p\"    \"Including data for the powiat and the city with powiat…\n18    98 0       \"Z\"    \"Methodological changes, significant value, the zero re…\n\n\nIn the case of the population data, all the values are valid as read. res_pop is a list of objects, one object per queried variable, so we extract the attrId vectors from each object and combine them with unlist, all taking the value 1, counts measured in persons. The zero value if present would be a measured zero count:\n\ntable(unlist(lapply(res_pop, \"[\", \"attrId\")))\n\n\n   1 \n1476 \n\n\nNext we need to disambiguate the object variable names val using the variable IDs, select only the unit ID and value columns, merge the multiple objects in the list, and drop repeated copies of the unit IDs to yield a data frame with a unit ID column and population count columns:\n\nres_pop1 &lt;- lapply(1:length(res_pop), function(i) {\n    names(res_pop[[i]])[4] &lt;- paste0(\"v_\", pop_pre_post_ids[i], sep=\"\")\n    as.data.frame(res_pop[[i]][, c(1, 4)])})\nres_pop2 &lt;- do.call(\"data.frame\", res_pop1)\nres_pop3 &lt;- res_pop2[, -(grep(\"id\\\\.\", names(res_pop2)))]\n\nMoving on to the sources of income for farm households from the 2020 Agricultural Census, we can drop the year argument, as observation time is given by the data source. First the top-level category contains these variable groups:\n\nget_subjects(\"K34\", lang=\"en\")\n\n# A tibble: 10 × 6\n   id    parentId name                              hasVariables children levels\n   &lt;chr&gt; &lt;chr&gt;    &lt;chr&gt;                             &lt;lgl&gt;        &lt;list&gt;   &lt;list&gt;\n 1 G281  K34      AGRICULTURAL CENSUS 1996 - AREA,… FALSE        &lt;chr&gt;    &lt;int&gt; \n 2 G285  K34      AGRICULTURAL CENSUS 1996 - INFRA… FALSE        &lt;chr&gt;    &lt;int&gt; \n 3 G290  K34      AGRICULTURAL CENSUS 1996 - ECONO… FALSE        &lt;chr&gt;    &lt;int&gt; \n 4 G298  K34      AGRICULTURAL CENSUS 1996 - INDIV… FALSE        &lt;chr&gt;    &lt;int&gt; \n 5 G320  K34      AGRICULTURAL CENSUS 2002 - BY HO… FALSE        &lt;chr&gt;    &lt;int&gt; \n 6 G321  K34      AGRICULTURAL CENSUS 2002 - BY RE… FALSE        &lt;chr&gt;    &lt;int&gt; \n 7 G476  K34      AGRICULTURAL CENSUS 2010 - BY HO… FALSE        &lt;chr&gt;    &lt;int&gt; \n 8 G484  K34      AGRICULTURAL CENSUS 2010 - BY RE… FALSE        &lt;chr&gt;    &lt;int&gt; \n 9 G636  K34      AGRICULTURAL CENSUS 2020 - BY RE… FALSE        &lt;chr&gt;    &lt;int&gt; \n10 G637  K34      AGRICULTURAL CENSUS 2020 - BY HO… FALSE        &lt;chr&gt;    &lt;int&gt; \n\n\nand group G637 contains these sub-groups:\n\nget_subjects(\"G637\", lang=\"en\")\n\n# A tibble: 25 × 6\n   id    parentId name                              hasVariables children levels\n   &lt;chr&gt; &lt;chr&gt;    &lt;chr&gt;                             &lt;lgl&gt;        &lt;list&gt;   &lt;list&gt;\n 1 P4079 G637     Labour input of holders and thei… TRUE         &lt;list&gt;   &lt;int&gt; \n 2 P4081 G637     Employed persons on agricultural… TRUE         &lt;list&gt;   &lt;int&gt; \n 3 P4083 G637     Labour input of persons employed… TRUE         &lt;list&gt;   &lt;int&gt; \n 4 P4137 G637     Farms by area groups of agricult… TRUE         &lt;list&gt;   &lt;int&gt; \n 5 P4138 G637     Average area of farm              TRUE         &lt;list&gt;   &lt;int&gt; \n 6 P4139 G637     Households with incomes by vario… TRUE         &lt;list&gt;   &lt;int&gt; \n 7 P4140 G637     Area of farms by area groups of … TRUE         &lt;list&gt;   &lt;int&gt; \n 8 P4141 G637     Area of agricultural land by are… TRUE         &lt;list&gt;   &lt;int&gt; \n 9 P4142 G637     Farms and area of agricultural l… TRUE         &lt;list&gt;   &lt;int&gt; \n10 P4143 G637     Treatments with plant protection… TRUE         &lt;list&gt;   &lt;int&gt; \n# ℹ 15 more rows\n\n\npointing to P4139:\n\n(agrinc &lt;- get_variables(\"P4139\", lang=\"en\"))\n\n# A tibble: 5 × 6\n       id subjectId n1                       level measureUnitId measureUnitName\n    &lt;int&gt; &lt;chr&gt;     &lt;chr&gt;                    &lt;int&gt;         &lt;int&gt; &lt;chr&gt;          \n1 1633229 P4139     with income from agricu…     6            37 hh             \n2 1633230 P4139     with income from non-ag…     6            37 hh             \n3 1633231 P4139     with income from paid e…     6            37 hh             \n4 1633232 P4139     with income from retire…     6            37 hh             \n5 1633233 P4139     with income from other …     6            37 hh             \n\nagrinc_ids &lt;- as.character(agrinc$id)\n\nRepeating the step from annual population counts, we can retrieve the recorded values by variable ID, and drop the observation unit IDs not included in our valid set:\n\nres_agr &lt;- vector(mode=\"list\", length=length(agrinc_ids))\nnames(res_agr) &lt;- agrinc_ids\nfor (i in seq(along=agrinc_ids)) res_agr[[i]] &lt;- try(\n    get_data_by_variable(unitParentId=pom_id, level=glev,\n     varId = agrinc_ids[i]))\nres_agr &lt;- lapply(res_agr, function(x) x[match(pom_gminy$id, x$id),])\n\nIn this case, however, we see that the attrId 91 is present, probably indicating that the household count was too small to be revealed without the risk of confidentiality being breached:\n\ntable(unlist(lapply(res_agr, \"[\", \"attrId\")))\n\n\n  0   1  91 \n  1 585  29 \n\n\nThe val columns contain zero for these cases, which need to be updated to reflect the fact that the data are missing:\n\nsapply(res_agr, function(x) x$val[x$attrId &gt; 1])\n\n$`1633229`\n[1] 0 0\n\n$`1633230`\n[1] 0 0 0 0 0\n\n$`1633231`\n[1] 0 0 0 0 0 0\n\n$`1633232`\n[1] 0 0\n\n$`1633233`\n [1] 0 0 0 0 0 0 0 0 0 0 0 0 0 0\n\n\nThis can be done using is.na for the logical condition that attrId &gt; 1, or another choice if other attrId values are present that can be accepted, for example preliminary data:\n\nres_agr0 &lt;- lapply(res_agr, function(x)\n {is.na(x$val) &lt;- x$attrId &gt; 1; x})\nsapply(res_agr0, function(x) x$val[x$attrId &gt; 1])\n\n$`1633229`\n[1] NA NA\n\n$`1633230`\n[1] NA NA NA NA NA\n\n$`1633231`\n[1] NA NA NA NA NA NA\n\n$`1633232`\n[1] NA NA\n\n$`1633233`\n [1] NA NA NA NA NA NA NA NA NA NA NA NA NA NA\n\n\nFrom here we proceed as before to generate an output object with obervation unit rows, and observation unit ID and variable ID columns:\n\nres_agr1 &lt;- lapply(1:length(res_agr0), function(i) {\n    names(res_agr0[[i]])[4] &lt;- paste0(\"v_\", agrinc_ids[i], sep=\"\")\n    as.data.frame(res_agr0[[i]][, c(1, 4)])})\nres_agr2 &lt;- do.call(\"data.frame\", res_agr1)\nres_agr3 &lt;- res_agr2[, -(grep(\"id\\\\.\", names(res_agr2)))]\nstr(res_agr3)\n\n'data.frame':   123 obs. of  6 variables:\n $ id       : chr  \"042214004011\" \"042214004022\" \"042214004032\" \"042214004042\" ...\n $ v_1633229: int  33 253 137 424 296 202 229 353 430 816 ...\n $ v_1633230: int  10 33 28 106 57 34 70 72 84 149 ...\n $ v_1633231: int  16 95 53 136 154 81 40 133 158 373 ...\n $ v_1633232: int  5 54 47 142 82 40 39 77 115 245 ...\n $ v_1633233: int  NA 36 NA 73 27 18 15 67 125 172 ...\n\n\nFinally, the variable from the 2021 Population Census giving the number of dwellings per observation unit is needed to give a basis for the agricultural incomes by household data set; first we look at category K31:\n\nget_subjects(\"K31\", lang=\"en\")[16:21,]\n\n# A tibble: 6 × 6\n  id    parentId name                               hasVariables children levels\n  &lt;chr&gt; &lt;chr&gt;    &lt;chr&gt;                              &lt;lgl&gt;        &lt;list&gt;   &lt;list&gt;\n1 G640  K31      CENSUS 2021 - POPULATION           FALSE        &lt;chr&gt;    &lt;int&gt; \n2 G642  K31      CENSUS 2021 - POPULATION - PRELIM… FALSE        &lt;chr&gt;    &lt;int&gt; \n3 G644  K31      CENSUS 2021 - BUILDINGS            FALSE        &lt;chr&gt;    &lt;int&gt; \n4 G645  K31      CENSUS 2021 - DWELLINGS            FALSE        &lt;chr&gt;    &lt;int&gt; \n5 G651  K31      CENSUS 2021 - HOUSEHOLDS AND FAMI… FALSE        &lt;chr&gt;    &lt;int&gt; \n6 G652  K31      CENSUS 2021 - ECONOMIC ACTIVITY O… FALSE        &lt;chr&gt;    &lt;int&gt; \n\n\nFrom this, we see group G645:\n\nget_subjects(\"G645\", lang=\"en\")\n\n# A tibble: 21 × 6\n   id    parentId name                              hasVariables children levels\n   &lt;chr&gt; &lt;chr&gt;    &lt;chr&gt;                             &lt;lgl&gt;        &lt;list&gt;   &lt;list&gt;\n 1 P4207 G645     Dwellings in total and by occupa… TRUE         &lt;list&gt;   &lt;int&gt; \n 2 P4369 G645     Inhabited dwelings by usable flo… TRUE         &lt;list&gt;   &lt;int&gt; \n 3 P4373 G645     Inhabited dwellings by usable fl… TRUE         &lt;list&gt;   &lt;int&gt; \n 4 P4374 G645     Inhabited dwellings by number of… TRUE         &lt;list&gt;   &lt;int&gt; \n 5 P4375 G645     Inhabited dwellings by number of… TRUE         &lt;list&gt;   &lt;int&gt; \n 6 P4376 G645     Inhabited dwellings by room numb… TRUE         &lt;list&gt;   &lt;int&gt; \n 7 P4378 G645     Inhabited dwellings by availabil… TRUE         &lt;list&gt;   &lt;int&gt; \n 8 P4379 G645     Inhabited dwellings by availabil… TRUE         &lt;list&gt;   &lt;int&gt; \n 9 P4380 G645     Inhabited dwellings by availabil… TRUE         &lt;list&gt;   &lt;int&gt; \n10 P4383 G645     Inhabited dwellings, total        TRUE         &lt;list&gt;   &lt;int&gt; \n# ℹ 11 more rows\n\n\nand choose sub-group P4383:\n\n(dwell_hh &lt;- get_variables(\"P4383\", lang=\"en\"))\n\n# A tibble: 3 × 6\n       id subjectId n1                       level measureUnitId measureUnitName\n    &lt;int&gt; &lt;chr&gt;     &lt;chr&gt;                    &lt;int&gt;         &lt;int&gt; &lt;chr&gt;          \n1 1723485 P4383     dwellings, total             6             1 -              \n2 1723486 P4383     useful floor area of a …     6            16 m2             \n3 1723487 P4383     population in inhabited…     6            26 person         \n\ndwell_hh_ids &lt;- as.character(dwell_hh$id)\n\ndownloading as before and dropping the observation unit IDs identified as invalid for our purposes (wrong year, not urban, rural or urban-rural municipalities):\n\nres_hh &lt;- vector(mode=\"list\", length=length(dwell_hh_ids))\nnames(res_hh) &lt;- dwell_hh_ids\nfor (i in seq(along=dwell_hh_ids)) res_hh[[i]] &lt;- try(\n    get_data_by_variable(unitParentId=pom_id, level=glev,\n     varId = dwell_hh_ids[i]))\nres_hh &lt;- lapply(res_hh, function(x) x[match(pom_gminy$id, x$id),])\n\nThere are no missing data observations:\n\ntable(unlist(lapply(res_hh, \"[\", \"attrId\")))\n\n\n  1 \n369 \n\n\nso we go on as before without the need to insert missing values:\n\nres_hh1 &lt;- lapply(1:length(res_hh), function(i) {\n    names(res_hh[[i]])[4] &lt;- paste0(\"v_\", dwell_hh_ids[i], sep=\"\");\n    as.data.frame(res_hh[[i]][, c(1, 4)])})\nres_hh2 &lt;- do.call(\"data.frame\", res_hh1)\nres_hh3 &lt;- res_hh2[, -(grep(\"id\\\\.\", names(res_hh2)))]\n\nHaving downloaded the data we have chosen, we merge the sub-group queries into a single object, adding a a TERYT column:\n\ndata_df &lt;- merge(res_pop3, res_agr3, by=\"id\")\ndata_df &lt;- merge(data_df, res_hh3, by=\"id\")\ndata_df$TERYT &lt;- paste(substr(data_df$id, 3, 4), substr(data_df$id, 8, 12), sep=\"\")\nstr(data_df)\n\n'data.frame':   123 obs. of  22 variables:\n $ id       : chr  \"042214004011\" \"042214004022\" \"042214004032\" \"042214004042\" ...\n $ v_72283  : int  2759 638 2024 4121 548 1017 420 1050 873 3348 ...\n $ v_72284  : int  9756 2031 6435 11444 1779 3241 1211 3502 2263 9896 ...\n $ v_72285  : int  3966 750 1955 3085 670 1131 428 1200 765 4168 ...\n $ v_72286  : int  15310 3359 10054 18159 3037 5292 2186 5846 3893 16863 ...\n $ v_72287  : int  2919 603 2092 4216 568 1111 406 1145 929 3469 ...\n $ v_72288  : int  10409 2359 6830 12190 2064 3592 1539 4045 2484 11164 ...\n $ v_72289  : int  1982 397 1132 1753 405 589 241 656 480 2230 ...\n $ v_72290  : int  31791 6778 20468 36809 6034 10681 4245 11598 7794 34275 ...\n $ v_72291  : int  5678 1241 4116 8337 1116 2128 826 2195 1802 6817 ...\n $ v_72292  : int  20165 4390 13265 23634 3843 6833 2750 7547 4747 21060 ...\n $ v_72293  : int  5948 1147 3087 4838 1075 1720 669 1856 1245 6398 ...\n $ v_72294  : int  16481 3419 10414 18650 2997 5389 2059 5752 3901 17412 ...\n $ v_1633229: int  33 253 137 424 296 202 229 353 430 816 ...\n $ v_1633230: int  10 33 28 106 57 34 70 72 84 149 ...\n $ v_1633231: int  16 95 53 136 154 81 40 133 158 373 ...\n $ v_1633232: int  5 54 47 142 82 40 39 77 115 245 ...\n $ v_1633233: int  NA 36 NA 73 27 18 15 67 125 172 ...\n $ v_1723485: int  11372 1849 6560 11526 1568 2917 1049 2986 1756 9723 ...\n $ v_1723486: int  779357 172182 647390 1114767 161160 312182 104031 303251 223462 928292 ...\n $ v_1723487: int  31067 6599 19799 35362 5861 10384 4121 11134 7622 33481 ...\n $ TERYT    : chr  \"2204011\" \"2204022\" \"2204032\" \"2204042\" ...\n\n\nWe complete by merging the municipality boundaries with the imported data using TERYT as the ID key:\n\npom1 |&gt; merge(data_df, by=\"TERYT\") -&gt; pom4_bdl\npom4_bdl\n\nSimple feature collection with 123 features and 23 fields\nGeometry type: MULTIPOLYGON\nDimension:     XY\nBounding box:  xmin: 350809.9 ymin: 626314.8 xmax: 542048.1 ymax: 775019.1\nProjected CRS: ETRF2000-PL / CS92\nFirst 10 features:\n     TERYT            NAME           id v_72283 v_72284 v_72285 v_72286 v_72287\n1  2201012     Borzytuchom 042214101012     359    1013     300    1720     395\n2  2201023           Bytów 042214101023    2223    7435    3218   12416    2346\n3  2201032 Czarna Dąbrówka 042214101032     593    1572     639    2899     615\n4  2201042     Kołczygłowy 042214101042     330    1206     460    2118     398\n5  2201052         Lipnica 042214101052     448    1476     605    2628     530\n6  2201063         Miastko 042214101063    1390    5088    2728    8998    1468\n7  2201072        Parchowo 042214101072     385    1110     407    1900     429\n8  2201082     Studzienice 042214101082     374    1053     400    1805     340\n9  2201092     Trzebielino 042214101092     299    1007     436    1801     350\n10 2201102        Tuchomie 042214101102     366    1251     407    2124     408\n   v_72288 v_72289 v_72290 v_72291 v_72292 v_72293 v_72294 v_1633229 v_1633230\n1     1160     165    3392     754    2173     465    1672       186        33\n2     8354    1716   25292    4569   15789    4934   12876       578       141\n3     1901     383    5703    1208    3473    1022    2804       419        78\n4     1443     277    4114     728    2649     737    1996       218        33\n5     1723     375    5157     978    3199     980    2529       620       102\n6     6158    1372   18204    2858   11246    4100    9206       496       122\n7     1241     230    3802     814    2351     637    1902       318        57\n8     1219     246    3632     714    2272     646    1827       242        48\n9     1213     238    3543     649    2220     674    1742       160        25\n10    1454     262    4148     774    2705     669    2024       348        66\n   v_1633231 v_1633232 v_1633233 v_1723485 v_1723486 v_1723487\n1        103        40        26       838     84052      3311\n2        302       171       111      7789    619100     24949\n3        181        96        34      1500    124464      5704\n4        112        65        46      1070     92368      4136\n5        243       157       124      1229    139202      5102\n6        212       160        42      5897    433669     18246\n7        151        99       100       874     88588      3672\n8        111        68        29       951    103605      3593\n9         68        46        12       988     80840      3509\n10       170       103       117      1068    100217      4128\n                         geometry\n1  MULTIPOLYGON (((392568.1 69...\n2  MULTIPOLYGON (((399745.2 68...\n3  MULTIPOLYGON (((415365.5 72...\n4  MULTIPOLYGON (((382369 6921...\n5  MULTIPOLYGON (((392500.3 67...\n6  MULTIPOLYGON (((366331.6 67...\n7  MULTIPOLYGON (((414238.3 69...\n8  MULTIPOLYGON (((405862.1 68...\n9  MULTIPOLYGON (((376562.5 69...\n10 MULTIPOLYGON (((384623.5 68...",
    "crumbs": [
      "<span class='chapter-number'>3</span>  <span class='chapter-title'>Working with spatial data</span>"
    ]
  },
  {
    "objectID": "03_talk.html#sec-sd-vis",
    "href": "03_talk.html#sec-sd-vis",
    "title": "3  Working with spatial data",
    "section": "3.2 Visualising spatial data",
    "text": "3.2 Visualising spatial data\nFor many purposes, maps themselves are spatial data. Observations are located in space as points, lines or polygons, and their placing yields useful contextual information when plotted. Using the plot methods on terra and sf, we can display the elevation raster as a background, and show the municipality boundaries with their ID keys:\n\nlibrary(elevatr)\n\nelevatr v0.99.0 NOTE: Version 0.99.0 of 'elevatr' uses 'sf' and 'terra'.  Use \nof the 'sp', 'raster', and underlying 'rgdal' packages by 'elevatr' is being \ndeprecated; however, get_elev_raster continues to return a RasterLayer.  This \nwill be dropped in future versions, so please plan accordingly.\n\nlibrary(terra)\n\nterra 1.7.71\n\nmaule_sf |&gt;  get_elev_raster(z = 7,\n clip = \"locations\", neg_to_na = TRUE) |&gt; \n rast() -&gt; maule_elev\n\nMosaicing & Projecting\n\n\nClipping DEM to locations\n\n\nNote: Elevation units are in meters.\n\nplot(maule_elev, col=rev(hcl.colors(50, \"Dark Mint\")))\nplot(st_geometry(maule_sf), add=TRUE)\ntext(st_coordinates(st_centroid(st_geometry(maule_sf))),\n label=maule_sf$codigo_comuna)\n\n\n\n\nElevation of Región del Maule, municipalities (base graphics plot methods)\n\n\n\n\nmapsf provides fairly flexible map creation functionality for overlaying layers of map information on a graphics output device, following the same order as above, but permitting the improvement of label positioning. Above, we set the palette to be used for elevation to \"Dark Mint\", which is the default for mapsf::mf_raster:\n\nlibrary(mapsf)\nmf_raster(maule_elev, leg_pos=\"bottomleft\",\n leg_title=\"elevation (m)\", leg_horiz=TRUE,\n leg_size=0.8, leg_val_rnd=0)\nmf_map(st_geometry(maule_sf), add=TRUE, lwd=2,\n border=\"grey60\", col=\"transparent\")\nmf_label(maule_sf, var=\"codigo_comuna\", overlap=FALSE,\n halo=2)\n\n\n\n\nElevation of Región del Maule, municipalities (base graphics mapsf functions)\n\n\n\n\ntmap is about to be upgraded, and is very concise in expressing map construction by adding successive layers to the output graphic with the + operator:\n\nlibrary(tmap)\n\nBreaking News: tmap 3.x is retiring. Please test v4, e.g. with\nremotes::install_github('r-tmap/tmap')\n\ntm_shape(maule_elev) + tm_raster(n=15,\n palette=rev(hcl.colors(7, \"Dark Mint\"))) +\n tm_shape(maule_sf) + tm_borders() +\n tm_text(\"codigo_comuna\")\n\n\n\n\nElevation of Región del Maule, municipalities (trellis graphics tmap functions)\n\n\n\n\nUsing the simplest approach, we can plot the positions of the take-away outlets registered for Talca city in OpenStreetMap, and see that they are very clustered within the boundary of the municipality:\n\nplot(st_geometry(talca_sf))\nplot(st_geometry(talca_takeaways), pch=4, col=3,\n cex=2, lwd=2, add=TRUE)\n\n\n\n\nLocation of take-away outlets in Talca\n\n\n\n\nSince it would be very useful to obtain more locational context, we can use mapview to view the take-away outlets on a web map background, so that we can interact with the point locations. The mapview methods convert the object to be displayed to \"OGC:WGS84\" if necessary, then to Web Mercator for display:\n\nlibrary(mapview)\nmapview(talca_takeaways)\n\n\n\nInteractive map of take-away outlets in Talca\n\n\nMoving to the data set for municipalities in the Polish voivodeship of Pomerania, we can attempt to show the density variable on an interactive map:\n\nlibrary(mapview)\nmapview(pom5, zcol=\"density\")\n\n\n\nInteractive map of Pomeramia municipalities from rgugik, population density per square kilometre\n\n\nAs may be seen in the interactive map, the municipality boundaries do match the Baltic sea coastline quite well, but the jurisdiction of the municipalities extends to some coastal waters in the Gulf of Gdańsk and Zalew Wiślany; we did after all download administrative municipality boundaries using rgugik. We need to find another source of boundaries that agree with the coastline, and then need to take the intersection of the two sets od polygons, leaving only areas present in both. giscoR provides access to boundaries for European NUTS regions, in geographical coordinates by default. We then need to transform to the Transverse Mercator projection used for the download from rgugik before carrying out the intersection:\n\nlibrary(giscoR)\npom_gisco &lt;- gisco_get_nuts(year=\"2021\", resolution=\"01\",\n spatialtype=\"RG\", nuts_id=\"PL63\")\npom_gisco_tm &lt;- st_transform(pom_gisco, \"EPSG:2180\")\npom6 &lt;- st_intersection(pom5, pom_gisco_tm)\n\nWarning: attribute variables are assumed to be spatially constant throughout\nall geometries\n\n\nOn occasion, topological operations on two objects like st_intersection fail because the two geometries have different coordinate reference systems, in which case, st_transform should be used first to bring them into agreement. If in any topological operation or predicate (such as a query like st_intersects), it is found that a geometry is invalid, for example the self-intersection of a polygon boundary, use st_make_valid on the invalid object. It can be the case that the geometry cannot be repaired, as some data providers do not check the provided geometries for validity. Since an intersection operation can yield points and lines as well as polygons, we can check the input and output geometries and re-establish their original geometry types; in this case only polygons and multipolygons were output:\n\npom5 |&gt; st_geometry_type() |&gt; table() -&gt; tab5; tab5[tab5&gt;0]\n\nMULTIPOLYGON \n         123 \n\npom6 |&gt; st_geometry_type() |&gt; table() -&gt; tab6; tab6[tab6&gt;0]\n\n\n     POLYGON MULTIPOLYGON \n         119            4 \n\npom6 |&gt; st_cast(\"MULTIPOLYGON\") -&gt; pom6\n\nSince the areas of some municipalities have now changed, we need to re-caluclate both areas and densities:\n\npom6 |&gt; st_area() |&gt;\n units::set_units(\"km2\") -&gt; pom6$area_km2\npom6 |&gt; st_drop_geometry() |&gt;\n subset(select = c(pop, area_km2)) |&gt;\n apply(1, function(x) x[1]/x[2]) -&gt; pom6$density\n\nAs can be seen from the figure below, the graphical representation is now more legible; coastlines and boundaries are typically read as contextual location information.\n\nmapview(pom6, zcol=\"density\")\n\n\n\nInteractive map of Pomeramia municipalities from rgugik, corrected population density per square kilometre\n\n\nTwo minor points before we move on, first that the distribution of the variable which we want to map does matter. The population density of Pomeranian municipalities is far from being symmetric, as this density plot shows:\n\nplot(density(pom6$density))\n\n\n\n\nDensity plot of population density, Census 2021, Pomeranian municipalities\n\n\n\n\nIn this case, in thematic cartography we should create class intervals for display using quantiles or other suitable methods. mapsf provides a geometric progression \"geom\" method for creating class intervals for skewed variables:\n\nmf_map(pom6, var=\"density\", type=\"choro\", breaks=\"geom\",\n nbreaks=7)\n\n\n\n\nPopulation density, Census 2021, Pomeranian municipalities\n\n\n\n\nThe choice of breaks style does matter for communicating the important traits of the variable in question in thematic cartography, here as a choropleth map.\nThe second display problem is associated with showing the kind of classes implied by the data. For a categorical variable and few classes, the classes are taken from the categories, and unlike the examples above using sequential palettes, this uses a qualitative palette:\n\nmf_map(pom6, var=\"type\", type=\"typo\")\n\n\n\n\nMunicipality type, Pomeranian municipalities\n\n\n\n\nWhen the variable is crosses a specified mid-point, like regression residuals, a sequential palette is not appropriate, and a diverging palette should be chosen. tmap::tm_fill attempts to make reasonable choices in this situation; here the deviance of the proportion of the municipality population less than 16 years old from its mean:\n\npom6$young &lt;- 100*(pom6$m_u15 + pom6$f_u15)/pom6$pop\npom6$young_res &lt;- residuals(lm(young ~ 1, data=pom6))\n\n\ntm_shape(pom6) + tm_fill(\"young_res\", style=\"quantile\",\n n=11, midpoint=0, palette=\"RdBu\") + tm_borders()\n\n\n\n\nProportion of population under 16 years of age, residuals from the mean, Pomeranian municipalities, 2022",
    "crumbs": [
      "<span class='chapter-number'>3</span>  <span class='chapter-title'>Working with spatial data</span>"
    ]
  },
  {
    "objectID": "03_talk.html#sec-sd-io",
    "href": "03_talk.html#sec-sd-io",
    "title": "3  Working with spatial data",
    "section": "3.3 Reading and writing spatial data",
    "text": "3.3 Reading and writing spatial data\nFor the present, we will only consider the reading and writing of spatial vector data using functions from sf: st_read and st_write. Further, while it is still regretably the case that many organisations still use the \"ESRI Shapefile\" (actually most often a bundle of at least four files) for sharing data, the GeoPackage format, \"GPKG\", should be preferred because it represents CRS properly, does not restrict field (variable) names to 10 characters, does use multibyte characters, and does store numerical fields in binary rather than text format. For commonly used formats, the format-specifiic driver is chosen from the file extension:\n\nfn &lt;- paste0(io_dir, \"/pom6.gpkg\")\nif (file.exists(fn)) tull &lt;- file.remove(fn)\ntry(st_write(pom6, fn))\n\nWriting layer `pom6' to data source `Input_output/pom6.gpkg' using driver `GPKG'\nCreating field FID failed.\nError in eval(expr, envir, enclos) : Layer creation failed.\n\n\nUnfortunately, our intersection of the GISCO voivodeship outline added a number of variables to the data set, including one called \"FID\" , which is a reserved word for many spatial data formats, meaning “Feature IDentifier”, and must be an integer. Now it is a character vector, so we replace it by a compliant integer vector with unique values; we could also have dropped it:\n\nstr(pom6$FID)\n\n chr [1:123] \"PL63\" \"PL63\" \"PL63\" \"PL63\" \"PL63\" \"PL63\" \"PL63\" \"PL63\" \"PL63\" ...\n\npom6$FID &lt;- 1:nrow(pom6)\nst_write(pom6, dsn=fn)\n\nWriting layer `pom6' to data source `Input_output/pom6.gpkg' using driver `GPKG'\nWriting 123 features with 31 fields and geometry type Multi Polygon.\n\n\nTo read, st_read will try to identify the format and use the appropriate driver automatically; if the data source containd multiple layers, the first will be read by default:\n\npom6a &lt;- st_read(dsn=fn)\n\nReading layer `pom6' from data source \n  `/home/rsb/und/PG_AGII_2sem/Input_output/pom6.gpkg' using driver `GPKG'\nSimple feature collection with 123 features and 30 fields\nGeometry type: MULTIPOLYGON\nDimension:     XY\nBounding box:  xmin: 350923.1 ymin: 626314.8 xmax: 542027.9 ymax: 774909.2\nProjected CRS: ETRF2000-PL / CS92\n\n\nWhen we do a simple check to see if output and input are identical - and find that they are not:\n\nisTRUE(all.equal(st_geometry(pom6), st_geometry(pom6a)))\n\n[1] FALSE\n\n\nWhen written to the external format, the order of the columns changes, as the geometry column is moved to the end on reading. This re-orders the columns, which contain the same information as before but the order differs:\n\nnames(pom6)\n\n [1] \"TERYT\"             \"NAME\"              \"Nazwa\"            \n [4] \"m_u15\"             \"f_u15\"             \"m_15_64\"          \n [7] \"f_15_59\"           \"m_o65\"             \"k_o60\"            \n[10] \"type\"              \"pop\"               \"area_km2\"         \n[13] \"density\"           \"farm\"              \"non_farm_business\"\n[16] \"non_farm_wages\"    \"pension\"           \"other_non_wage\"   \n[19] \"dwellings\"         \"COAST_TYPE\"        \"FID\"              \n[22] \"MOUNT_TYPE\"        \"NAME_LATN\"         \"CNTR_CODE\"        \n[25] \"NUTS_ID\"           \"LEVL_CODE\"         \"URBN_TYPE\"        \n[28] \"NUTS_NAME\"         \"geo\"               \"geometry\"         \n[31] \"young\"             \"young_res\"        \n\nnames(pom6a)\n\n [1] \"TERYT\"             \"NAME\"              \"Nazwa\"            \n [4] \"m_u15\"             \"f_u15\"             \"m_15_64\"          \n [7] \"f_15_59\"           \"m_o65\"             \"k_o60\"            \n[10] \"type\"              \"pop\"               \"area_km2\"         \n[13] \"density\"           \"farm\"              \"non_farm_business\"\n[16] \"non_farm_wages\"    \"pension\"           \"other_non_wage\"   \n[19] \"dwellings\"         \"COAST_TYPE\"        \"MOUNT_TYPE\"       \n[22] \"NAME_LATN\"         \"CNTR_CODE\"         \"NUTS_ID\"          \n[25] \"LEVL_CODE\"         \"URBN_TYPE\"         \"NUTS_NAME\"        \n[28] \"geo\"               \"young\"             \"young_res\"        \n[31] \"geom\"             \n\n\nIn addition, the \"area_km2\" column loses its units definition, and the \"type\" column becomes a character vector, not a factor. Such differences are trivial and to be expected, but imply that if an object is to shared with collaborators, any shared script should use the object as read from file, especially if column order rather than column names are used in analysis. After reading, we can restore the representation of the columns before starting work:\n\npom6a$type &lt;- factor(pom6a$type)\npom6a$area_km2 &lt;- units::set_units(pom6a$area_km2, \"km2\")",
    "crumbs": [
      "<span class='chapter-number'>3</span>  <span class='chapter-title'>Working with spatial data</span>"
    ]
  },
  {
    "objectID": "04_talk.html",
    "href": "04_talk.html",
    "title": "4  Creating spatial weights objects",
    "section": "",
    "text": "4.1 Using spdep to create neighbour and weights objects\nChapter 14 of Pebesma and Bivand (2023) provides a fairly up-to-date account of how one may construct \"nb\" neighbour objects, and from these \"listw\" weights objects. In the following chapters, these objects will be used extensively in modelling, and will often be referred to as spatial weights matrices. While their description in terms of linear algebra as matrices is reasonable, their representation as dense n by n matrices is much less reasonable, as in most cases, only a very few elements of such a matrix are non-zero. This means that sparse representations are certainly preferable in terms of storage and efficiency, and repeated multiplication by zero is simply wasteful. \"nb\" neighbour objects, and \"listw\" weights objects are sparse representations, where the \"nb\" object records which objects j are neighbours of i for each i, and \"listw\" objects add in the weights assigned to each such i-j relationship.\nWe will use the spdep package to construct neighbour objects for the 123 Pomeranian municipalities. Since we have the boundaries of the municipalities, we can see which municipalities share boundary segments, known as rook contiguity; we add identifiers to the output object, now only to show it can be done, but later for use in out-of-sample prediction among other uses:\nlibrary(sf)\n\nLinking to GEOS 3.12.1, GDAL 3.8.4, PROJ 9.3.1; sf_use_s2() is TRUE\n\nlibrary(spdep)\n\nLoading required package: spData\n\n(pom6a |&gt; poly2nb(queen=FALSE,\n row.names=pom6a$TERYT) -&gt; pom_rook_nb)\n\nNeighbour list object:\nNumber of regions: 123 \nNumber of nonzero links: 504 \nPercentage nonzero weights: 3.33135 \nAverage number of links: 4.097561 \n2 regions with no links:\n2206011 2212053\n7 disjoint connected subgraphs\nIf we slacken our definition of contiguity to simply sharing one boundary point, to queen contiguity, we see that the problems detected here of two no-neighbour municipalities and seven disjoint subgraphs remain:\n(pom6a |&gt; poly2nb(queen=TRUE,\n row.names=pom6a$TERYT) -&gt; pom_queen_nb)\n\nNeighbour list object:\nNumber of regions: 123 \nNumber of nonzero links: 504 \nPercentage nonzero weights: 3.33135 \nAverage number of links: 4.097561 \n2 regions with no links:\n2206011 2212053\n7 disjoint connected subgraphs\nOne possible reason for such problems is that boundaries provided by public agencies are accurate enough for their purposes, but where shared boundary points are not exactly identical. If we pass a very small distance, here one-hundredth of a millimetre, as a snap distance, the problems are resolved:\n(pom6a |&gt; poly2nb(queen=FALSE, row.names=pom6a$TERYT,\n snap=0.00001) -&gt; pom_rook_nb)\n\nNeighbour list object:\nNumber of regions: 123 \nNumber of nonzero links: 614 \nPercentage nonzero weights: 4.058431 \nAverage number of links: 4.99187 \n\n(pom6a |&gt; poly2nb(queen=TRUE, row.names=pom6a$TERYT,\n snap=0.00001) -&gt; pom_queen_nb)\n\nNeighbour list object:\nNumber of regions: 123 \nNumber of nonzero links: 614 \nPercentage nonzero weights: 4.058431 \nAverage number of links: 4.99187\nWe can also see that in this case the rook and queen definitions lead to the same neighbour object; differences are more often seen in US tracts or counties with grid-like boundaries where four entities meet at a single point.\nBy definition, contiguity neighbours, like distance threshold neighbours are symmetric, that is if i is a neighbour of j, j must be a neighbour of i. This is only rarely the case when defining neighbours as the k-nearest points. Asymmetric neigbours lead to directed graphs, which can also be handled, but which need subsequent numerical special treatment. There may be substantive reasons for choosing asymmetric neighbours, but it is probably a good idea to spell out the reasons clearly.\nIt is important to establish whether no-neighbour entities really have no neighbours because in matrix terms they lead to columns and rows with only zero values. Some methods become poorly defined if observations “drop out” of analysis in this way. For similar reasons, the detection of disjoint subgraphs, that is parts of the neighbour object that are unconnected from other parts of the object, jeopardises the outcome of modelling, as spatial processes cannot travel across the whole graph. The graph we have found now can be plotted, using st_point_on_surface internally to provide points to represent the polygons:\ngeom &lt;- st_geometry(pom6a) \nplot(geom, border=\"grey\")\nplot(pom_queen_nb, geom, add=TRUE)\n\n\n\n\nQueen neighbour object, Pomeranian municipalities, 2022\nWhen choosing the five nearest neighbours as the neighbour criterion, with distance measured to suit the coordinate reference system of the point geometries, the outcome is most often asymmetric:\n(geom |&gt; st_point_on_surface() |&gt; knearneigh(k=5) |&gt;\n knn2nb(row.names=pom6a$TERYT) -&gt; pom_k5_nb)\n\nNeighbour list object:\nNumber of regions: 123 \nNumber of nonzero links: 615 \nPercentage nonzero weights: 4.065041 \nAverage number of links: 5 \nNon-symmetric neighbours list\nplot(geom, border=\"grey\")\nplot(pom_k5_nb, geom, add=TRUE)\n\n\n\n\nFive nearest neighbour object, Pomeranian municipalities, 2022\nAs the figure above shows, open coastal water is crossed by links between neighbours defined in this way. For the point support Gdańsk take-away outlets and five nearest neighbours, asymmetry is expected, but as with many distance measures, this case does raise the question of whether to measure distance in a distance metric or perhaps a time metric, because crossing a busy street takes more time than walking or cycling along a street:\n(gd_takeaways|&gt; knearneigh(k=5) |&gt;\n knn2nb(row.names=gd_takeaways$osm_id) -&gt; gd_k5_nb)\n\nNeighbour list object:\nNumber of regions: 160 \nNumber of nonzero links: 800 \nPercentage nonzero weights: 3.125 \nAverage number of links: 5 \n7 disjoint connected subgraphs\nNon-symmetric neighbours list\ngd_k5_nb |&gt; nb2lines(coords=st_geometry(gd_takeaways)\n ) -&gt; gd_k5_nb_sf\nAs the figure below shows, the outlets are tightly clustered into disjoint subgraphs, but on more careful consideration, the outlets are multi-function, also serving drop-in customers. An outlet only offering take-away service might be located best near peak demand conditioned by the cost of property rental and transport accessibility, but most seem to sell to multiple markets: take-away, eat in restaurant, and delivery to customer. Maybe some compete on price, but cuisine may be a differentiator as well.\nlibrary(mapview)\nmapview(gd_takeaways) + mapview(gd_k5_nb_sf, color=\"red4\")\n\n\n\nFive nearest neighbour object, Gdańsk take-away outlets, OpenStreetMap\nHaving shown some methods for constructing neighbour objects, we can briefly mention the assignment of weights to the neighbour links:\npom_queen_nb |&gt; nb2listw(style=\"W\") -&gt; pom_queen_lw\nsummary(pom_queen_lw)\n\nCharacteristics of weights list object:\nNeighbour list object:\nNumber of regions: 123 \nNumber of nonzero links: 614 \nPercentage nonzero weights: 4.058431 \nAverage number of links: 4.99187 \nLink number distribution:\n\n 1  2  3  4  5  6  7  8  9 10 \n 7 10 12 14 30 22 16  8  3  1 \n7 least connected regions:\n2203011 2206011 2210011 2211011 2211031 2212011 2213031 with 1 link\n1 most connected region:\n2206042 with 10 links\n\nWeights style: W \nWeights constants summary:\n    n    nn  S0      S1       S2\nW 123 15129 123 57.8465 522.8508\nThe output of the summary method shows the same details as for the nb object, adding a tabulation by neighbour count, the weights style \"W\", meaning that the weights are standardised so that the sum of weights for each observation is unity:\npom_queen_lw$weights |&gt; sapply(sum) |&gt; unique()\n\n[1] 1\nIn some modelling settings, the \"B\" binary zero-one style is preferred, and there are a number of alternative ways of specifying weights. Finally, if the neighbour object contains no-neighbour entities, the zero.policy argument to nb2listw may be used to indicate that zero weights are acceptable - the obvious alternatives are to exclude such entities, or to add neighbour links so that all entities have neigbours.",
    "crumbs": [
      "<span class='chapter-number'>4</span>  <span class='chapter-title'>Creating spatial weights objects</span>"
    ]
  },
  {
    "objectID": "04_talk.html#english-garbage-data-set-and-weights-construction",
    "href": "04_talk.html#english-garbage-data-set-and-weights-construction",
    "title": "4  Creating spatial weights objects",
    "section": "4.2 English garbage data set and weights construction",
    "text": "4.2 English garbage data set and weights construction\nFrom the seventh lecture, we shall be using a data set from Bivand and Szymanski (1997) and Bivand and Szymanski (2000), extending results in SZYMANSKI and WILKINS (1993), SYMANSKI (1996) and Bello and Szymanski (1996). The question posed in the research reported in these articles is whether the costs of garbage collection in English local authority districts (which had a statutory obligation to collect garbage) were reduced when compulsory competitive tendering was introduced. Not all districts introduced compulsory competitive tendering at the same time, and some had not begun when data collection ceased. Of 366 districts, only 324 had completed at this point, and the data used relate to these districts. Since compulsory competitive tendering was implemented in different years, the data set reports real district net expenditure on garbage collection for the year before the implementation of compulsory competitive tendering (pre-CCT), and the year after (post-CCT).\nAs mentioned in Bivand and Szymanski (2000), the observations are agents, their boundaries do not change during the study period, and as entities they meet reasonable behavioural expectations. Revelli (2003), Brueckner (2003), Revelli (2006), Revelli and Tovmo (2007) and others engage with a literature including Case, Hines, and Rosen (1993) and Besley and Case (1995) concerning strategic interactions, of which yardstick competition may play a part. In Bivand and Szymanski (1997), the identification of residual spatial autocorrelation in the results given by@bello+szymanski:96 was used to develop a spatial yardstick competition framework, in which districts without compulsory competitive tendering were more likely to be influenced by the behaviour of their proximate neighbours than by general market conditions.\nThe data used in Bivand and Szymanski (2000) have been matched with simplified boundaries for English districts, and may be read in the usual way:\n\nlibrary(sf)\neng324 &lt;- st_read(\"Datasets/cross section/garbage/eng324s.gpkg\")\n\nReading layer `eng324s' from data source \n  `/home/rsb/und/PG_AGII_2sem/Datasets/cross section/garbage/eng324s.gpkg' \n  using driver `GPKG'\nSimple feature collection with 324 features and 34 fields\nGeometry type: MULTIPOLYGON\nDimension:     XY\nBounding box:  xmin: 134199 ymin: 11551 xmax: 655604 ymax: 657534\nProjected CRS: OSGB36 / British National Grid\n\n\nShowing which districts implemented compulsory competitive tendering and whether they awarded the contract to an outside bidder or to thir direct service organisation also shows the gaps, that is districts that had not implemented the policy by the end of data collection:\n\nlibrary(mapview)\nmapview(eng324, zcol=\"f_dso\")\n\n\n\nDirect service organisation chosen, compulsory competitive tendering, English districts\n\n\nNaturally, the gaps lead to difficulties in creating a viable neighbour object:\n\nlibrary(spdep)\n(pnb &lt;- poly2nb(eng324, queen=TRUE, row.names=eng324$NAME))\n\nNeighbour list object:\nNumber of regions: 324 \nNumber of nonzero links: 1440 \nPercentage nonzero weights: 1.371742 \nAverage number of links: 4.444444 \n3 regions with no links:\nHEREFORD KENSINGTON & CHELSEA STEVENAGE\n6 disjoint connected subgraphs\n\n\nThree disticts have no neighbours, and there are 6 disjoint subgraphs. We can use k-nearest neighbours with small k to patch in the missing links, and make them symmetric:\n\ncrds &lt;- st_centroid(st_geometry(eng324))\nk2 &lt;- knn2nb(knearneigh(crds, k=2), row.names=eng324$NAME)\n(unb &lt;- make.sym.nb(union.nb(pnb, k2)))\n\nNeighbour list object:\nNumber of regions: 324 \nNumber of nonzero links: 1584 \nPercentage nonzero weights: 1.508916 \nAverage number of links: 4.888889 \n\n\n\npnb_sf &lt;- nb2lines(pnb, coords=crds)\nk2_sf &lt;- nb2lines(setdiff.nb(intersect.nb(pnb, k2), k2),\n coords=crds)\nmapview(eng324, alpha.regions=0.15) +\n mapview(pnb_sf, color=\"blue3\") +\n mapview(k2_sf, color=\"red4\")\n\n\n\nContiguity neighbours and added k-nearest neighbours, 324 Englist districts\n\n\nWe can also read the original neighbour object modified by hand for Bivand and Szymanski (1997):\n\n(orignb &lt;- read.gal(\"Datasets/cross section/garbage/eng324_orig.gal\"))\n\nNeighbour list object:\nNumber of regions: 324 \nNumber of nonzero links: 1570 \nPercentage nonzero weights: 1.49558 \nAverage number of links: 4.845679 \n\nattr(orignb, \"region.id\") &lt;- attr(unb, \"region.id\")\n\n\norignb_sf &lt;- nb2lines(orignb, coords=crds)\nmapview(eng324, alpha.regions=0.15) +\n mapview(orignb_sf, color=\"green4\")\n\n\n\nOriginal simple graph, 324 English districts\n\n\nNow we have a basis for work later on involving a data set used in published articles some time ago, but still relevant, as the entities are well-founded, and we have a micro-economic model for spillovers between entities.\n\n\n\n\nBello, Hakeem, and Stefan Szymanski. 1996. “COMPULSORY COMPETITIVE TENDERING FOR PUBLIC SERVICES IN THE UK: THE CASE OF REFUSE COLLECTION.” Journal of Business Finance & Accounting 23 (5-6): 881–903. https://doi.org/10.1111/j.1468-5957.1996.tb01157.x.\n\n\nBesley, Timothy, and Anne Case. 1995. “Incumbent Behavior: Vote-Seeking, Tax-Setting, and Yardstick Competition.” American Economic Review 85 (1): 25.\n\n\nBivand, Roger, and Stefan Szymanski. 1997. “Spatial Dependence Through Local Yardstick Competition: Theory and Testing.” Economics Letters 55: 257–65.\n\n\n———. 2000. “Modelling the Spatial Impact of the Introduction of Compulsory Competitive Tendering.” Regional Science and Urban Economics 30: 203–19.\n\n\nBrueckner, Jan K. 2003. “Strategic Interaction Among Governments: An Overview of Empirical Studies.” International Regional Science Review 26: 175–88.\n\n\nCase, Anne C., James R. Hines, and Harvey S. Rosen. 1993. “Budget Spillovers and Fiscal Policy Interdependence: Evidence from the States.” Journal of Public Economics 52 (3): 285–307. https://doi.org/10.1016/0047-2727(93)90036-S.\n\n\nPebesma, Edzer, and Roger Bivand. 2023. Spatial Data Science with Applications in R. Boca Raton, FL: CRC Press.\n\n\nRevelli, Federico. 2003. “Reaction or Interaction? Spatial Process Identification in Multi-Tiered Government Structures.” Journal of Urban Economics 53: 29–53.\n\n\n———. 2006. “Performance Rating and Yardstick Competition in Social Service Provision.” Journal of Public Economics 90: 459–75.\n\n\nRevelli, Federico, and Per Tovmo. 2007. “Revealed Yardstick Competition: Local Government Efficiency Patterns in Norway.” Journal of Urban Economics 62: 121–34.\n\n\nSYMANSKI, STEFAN. 1996. “The Impact of Compulsory Competitive Tendering on Refuse Collection Services.” Fiscal Studies 17 (3): 1–19. https://doi.org/https://doi.org/10.1111/j.1475-5890.1996.tb00491.x.\n\n\nSZYMANSKI, STEFAN, and SEAN WILKINS. 1993. “Cheap Rubbish? Competitive Tendering and Contracting Out in Refuse Collection – 1981–88.” Fiscal Studies 14 (3): 109–30. https://doi.org/https://doi.org/10.1111/j.1475-5890.1993.tb00489.x.",
    "crumbs": [
      "<span class='chapter-number'>4</span>  <span class='chapter-title'>Creating spatial weights objects</span>"
    ]
  },
  {
    "objectID": "05_talk.html",
    "href": "05_talk.html",
    "title": "5  Antecedents",
    "section": "",
    "text": "Spatial econometrics may be seen in a number of different ways, as misguided, as an inward-looking endeavour for the specially interested, but these views are rarely placed in their context. In this section, we will sketch the antecedents of spatial econometrics, both providing views on the research context when it came into being, and on changes in econometrics over time. Grasping spatial econometrics today without insight into its antecedents is unnecessarily difficult, so taking time to explore how ideas came into being and developed is well-spent. \nIn the same way that Fujita, Krugman, and Venables (1999) begin their study of the spatial economy by looking at the antecedents of their subject, it is helpful to place spatial econometrics in its temporal and academic context. This context is sufficiently different from the contemporary setting that it may be hard to grasp the background for many of the features of spatial econometrics that came into being during its earlier years. Indeed, the ranges of topics that were studied in economics in the 1960’s and 1970’s differ markedly from those in focus today. If we can sketch the context within which spatial econometrics was created, and its methods developed, we should be able to illuminate choices made then which influence our understanding and application of spatial econometric methods. \nCritics of the practice of spatial econometrics, such as Gibbons and Overman (2012), appear to overlook these antecedents, and consequently judge the potential of the field on a partial, perhaps anachronistic, understanding, viewing phenomena with a history in ahistorical way. Since we are attempting to provide an introduction to applied spatial econometrics, we need to throw light on the original motivations and concerns of the first scholars engaged in the field. Anselin (2010b) indicates clearly and repeatedly (Anselin 1988, 2006, 2010a) that we should acknowledge Spatial Econometrics by Paelinck and Klaassen (1979) of the Netherlands Economic Institute as our starting point, and so celebrated thirty years of spatial econometrics in 2009. This firm confirmation of the importance of Jean Paelinck’s contributions as scholar and community-builder is fully justified. We should then turn to the motivations given in Paelinck and Klaassen (1979) to indicate which contextual factors were of importance at that time, and the breadth of the academic communities with which they were in contact. \nIn a recent short commentary, Paelinck (2013, 11) recalled his conviction, expressed in 1967, that\n\nearly econometric exercises … relating only variables posessing the same regional index … were inadequate to represent the correct spatial workings of the economy, which would then be reflected in the policy outcomes.\n\nA year before, Paelinck (2012, 36) pointed to salient isomorphisms linking spatial regression models, simultaneous equation models and input-output models; these were known of and discussed in the early formative period of spatial econometrics. We will return in subsequent chapters to the ways in which spatial regression models may be specified, but for now, a simple presentation of these isomorphisms as perceived in the early period is sufficient: \n\\begin{equation*}\n{\\mathbf y} = {\\mathbf A}{\\mathbf y} + {\\mathbf X}{\\mathbf b} + {\\mathbf \\varepsilon}\\end{equation*}\n is a spatial regression model where {\\mathbf A} is a matrix expressing the mutual first order spatial dependencies between regions — the similarity of this form and the Koyck distributed lag model is striking (Koyck 1954; Klein 1958; Griliches 1967); \n\\begin{equation*}\n{\\mathbf A}{\\mathbf y} + {\\mathbf X}{\\mathbf b} = {\\mathbf \\varepsilon}\n\\end{equation*}\n is a simultaneous equation model where {\\mathbf A} is a matrix expressing the dependencies between the equations; and: \n\\begin{equation*}\n{\\mathbf y} = {\\mathbf A}{\\mathbf y} + {\\mathbf f}\n\\end{equation*} is an input-output model where {\\mathbf A} is a matrix of sectoral input-output coefficients, and {\\mathbf f} is final demand. \nInput-output models, simultaneous equation models, and the importance of policy outcomes were all known intimately at the Netherlands Economic Institute at this time, and elsewhere among applied economists. The isomporhisms flowed from the known to the unknown, from the stuff of contemporary research and policy advice to doubts about the calibration of aspatial models, and on to what became termed spatial econometrics. If we compare these topics with those described for Regional Science by Boyce (2004), we can see the outlines of research priorities at the time: including urban and regional models for planning, regional and interregional input-output models, transport and location models. During the 1960s and 1970s, many of these models were enhanced, matching needs for policy advice, to cover environmental questions, adding natural resources as inputs and pollution to outputs. Paelinck’s co-author in a key paper in spatial econometrics (Hordijk and Paelinck 1976), went on to work in environmental management and research. \nReading Paelinck and Klaassen (1979, viii), we see that the programme of research into the space economy undertaken at the Netherlands Economic Institute led first to the publication of Paelinck and Nijkamp (1975), and then to Klaassen, Paelinck, and Wagenaar (1979), published in the same year as Spatial Econometrics. All three books were published in the same series and appear to reflect the core concerns of economists at the Institute doing research on regionalised national macro-economic models. The direct link to Jan Tinbergen is evident in the account of the context of economic research in the Netherlands given by Theil (1964, 49). If we take Paelinck at his word, he and his colleagues were aware that an aspatial regionalisation of national accounts, of input-output models, or transport models, might prejudice policy advice and outcomes through inadequate and inappropriate calibration. \nKlaassen, Paelinck, and Wagenaar (1979) is mainly concerned with model construction, while about a third of Paelinck and Nijkamp (1975) is devoted to input-output analysis. Both books show sustained concern for aggregate economic measurement, especially of national accounts data, intersectoral transactions, and many other topics. Considerable attention is also paid to the data collection units, be they sectors or regions. The need to attempt to define regions that match the underlying economic realities was recognised clearly, and a key part of Paelinck and Nijkamp (1975) is devoted to regionalisation, and the distinction between functional regions and homogenous regional classifications is made. In the motivation for spatial econometric models given in Paelinck and Klaassen (1979, 2–3), consumption and investment in a region are modelled as depending on income both in the region itself and in its contiguous neighbours, termed a “spatial income-generating model.” It became important to be able to calibrate planning models of this kind to provide indications of the possible outcomes of alternative policy choices, hence the need for spatial econometrics. \nEconomic planning was widespread in Europe at the time, and was also central in the development of Regional Science, in particular input-output models; as Boyce (2004) recounts, Walter Isard worked closely with Wassily Leontief. Operational and planning motivations for applied economics were unquestioned, as economists in the post-war period saw their role, beyond educating young economists, as providing rational foundations for economic policy. It is worth noting that Jean Paelinck participated actively in the Association de Science Régionale De Langue Française, becoming president in 1973–1976. The first president of the association was François Perroux, who had founded it with Walter Isard in 1961 (Bailly, Derycke, and Torre 2012). \nUntil the 1980s, it was not at all unusual to publish original results in other languages than English. French spatial economic research, for example Ponsard (1983), while making little impact in Anglophone countries, was widely used in teaching and research elsewhere (Billot and Thisse 1992). They contrast, though, the “word wizardry of François Perroux with the rigour of Claude Ponsard” Billot and Thisse (1992, 194), echoing the views expressed by Drèze (1964, 3–4) with regard to the work of Perroux. Even if we accept that “word wizardry” deserves more rigour and recasting in normative and empirically testable forms, it is also part of the context within which spatial econometrics came into being. A reading of Perroux (1950, a lecture given at Harvard University) is worthwhile, because it not only gives the reader a vignette of the context in the post-war period, but also provides a discussion of economic space, as opposed to “banal, unreflected space, mere position”, that has largely disappeared from our considerations. \nThe title of the journal: Regional and Urban Economics, Operational Methods, founded by Jean Paelinck in 1971, and which was renamed as Regional Science and Urban Economics in 1975. Boyce (2004, 43), points to the perceived importance of “operational methods”, a version of the term “operational theory and method” used in the title of Paelinck and Nijkamp (1975). Spatial econometrics does not seem to have come into being as a set of estimation techniques as such, as perhaps we might think today, but rather as an approach addressing open research questions both in space economy and in the enhancement of interregional models to be used in offering policy advice. \nWere motivations of this kind common during the 1960s and early 1970s? Not only was the spread of Regional Science extensive and firmly established (Boyce 2004), but public bodies were concerned to regionalise economic measurement and policy advice (see, for example Graham and Romans 1971). In Britain, Environment and Planning was started in 1969 with Alan Wilson as founding editor and published by Pion; he was assistant director at the Centre for Environmental Studies at this time before moving to the University of Leeds. In a recently published lecture series, Wilson (2012, 35–36) cites Paelinck and Nijkamp (1975) as giving principles for contributions from economics to urban and regional analysis (see also Wilson 2000, 34). The papers presented at annual Regional Science meetings were published in a series by Pion; the first number in the series included contributions by Granger (1969) and Cliff and Ord (1969). \nIn a contribution to a panel session at the 2006 annual meeting of the American Association of Geographers (co-panelists Luc Anselin and Daniel Griffith), Keith Ord pointed to the continued relevance of Granger’s remarks at the meeting almost fourty years earlier (Ord 2010, 168–69); we will return to these concerns below. As noted by Bivand (2008, 1–5), communities of researchers working in and near mathematical and theoretical geography was more integrated in the pre-internet and pre-photocopier age than one might expect, with duplicated working papers prepared using stencils circulating rapidly between collaborating academic centres. Knowledge of the preliminary results of other researchers then fed through into rapid innovation in an exciting climate for those with access to these meetings and working papers.\nThere was considerable overlap between quantitative geography and regional science, so that work like Cliff and Ord (1969) is cited by Hordijk (1974), and was certainly known at the Netherlands Economic Institute several years earlier. Although it has not been possible to find out who participated in the August 1968 conference of the British and Irish Section of the Regional Science Association at which Cliff and Ord (1969) was read, it was not unusual for members of other sections to be present, and to return home with bundles of duplicated papers. Up to the 1990s, presenters at conferences handed out copies of their papers, and conference participants posted home parcels of these hand-outs, indexed using the conference programme. \nLeslie Hepple was among the more thorough scholars working on the underpinnings of spatial econometrics prior to the publication of Paelinck and Klaassen (1979). His wide-ranging review Hepple (1974) is cited by Bartels and Hordijk (1977), again demonstrating the close links between those working in this field. We will be returning to the review paper, and to Hepple (1976), which studies methods of estimation for spatial econometrics models in some depth, building on and extending Ord (1975). \nHepple (1974), like Cliff and Ord (1973), saw no distinction between spatial statistics and the antecedents to spatial econometrics. Obviously, spatial econometrics was strongly influenced by the research tasks undertaken by regional and urban economists and regional scientists. As Griffith and Paelinck (2007, 211) point out, spatial statistics and spatial econometrics continue to share most topics of interests, with each also possessing shorter lists of topics that have been of less concern to the other. They advocate a “non-standard” spatial econometrics, which is inclusive to wider concerns. It seems appropriate in this context to mention the somewhat heterodox position taken by McMillen (2010), who draws attention to the crucial issue of functional form, which he argues may well lie behind observed spatial autocorrelation; we will return to this in later chapters. \n\n\n\n\nAnselin, Luc. 1988. Spatial Econometrics: Methods and Models. Dordrecht: Kluwer Academic Publishers.\n\n\n———. 2006. “Spatial Econometrics.” In Palgrave Handbook on Econometrics: Econometric Theory, edited by T. C. Mills and K. Patterson, 901–69. Basingstoke: Palgrave Macmillan.\n\n\n———. 2010a. “Spatial Econometrics.” In The SAGE Handbook of Spatial Analysis, edited by A. Stewart Fotheringham and Peter A. Rogerson, 255–75. London: SAGE Publications Ltd.\n\n\n———. 2010b. “Thirty Years of Spatial Econometrics.” Papers in Regional Science 89: 3–25.\n\n\nBailly, Antoine, Pierre-Henri Derycke, and André Torre. 2012. “50 Ans de Science Régionale Francophone.” l’Association de Science Régionale de Langue Française. http://www.asrdlf.org/telechargements/50ansASRDLF.pdf.\n\n\nBartels, Cornelis P. A., and Leen Hordijk. 1977. “On the Power of the Generalized Moran Contiguity Coefficient in Testing for Spatial Autocorrelation Among Regression Disturbances.” Regional Science and Urban Economics 7: 83–101.\n\n\nBillot, Antoine, and Jacques-Francois Thisse. 1992. “Claude Ponsard (1927-1990): A Biographical Essay.” Annals of Regional Science 26: 191–98.\n\n\nBivand, Roger. 2008. “Implementing Representations of Space in Economic Geography.” Journal of Regional Science 48: 1–27.\n\n\nBoyce, David. 2004. “A Short History of the Field of Regional Science.” Papers in Regional Science 83: 31–57.\n\n\nCliff, Andrew D., and J. Keith Ord. 1969. “The Problem of Spatial Autocorrelation.” In Studies in Regional Science, edited by A. J. Scott, 25–55. London Papers in Regional Science. London: Pion.\n\n\n———. 1973. Spatial Autocorrelation. London: Pion.\n\n\nDrèze, Jacques H. 1964. “Some Postwar Contributions of French Economists to Theory and Public Policy: With Special Emphasis on Problems of Resource Allocation.” The American Economic Review 54 (4): 2–64.\n\n\nFujita, Masahisa, Paul Krugman, and Anthony J. Venables. 1999. The Spatial Economy. Cambridge, MA: MIT Press.\n\n\nGibbons, Stephen, and Henry G. Overman. 2012. “Mostly Pointless Spatial Econometrics?” Journal of Regional Science 52: 172–91.\n\n\nGraham, Robert E., and J. Thomas Romans. 1971. “Regional Economic Accounting in the u.s. Office of Business Economics — an Appraisal.” Review of Income and Wealth 17: 1–34.\n\n\nGranger, Clive W. J. 1969. “Spatial Data and Time Series Analysis.” In Studies in Regional Science, edited by A. J. Scott, 1–25. London Papers in Regional Science 1. London: Pion.\n\n\nGriffith, Daniel A., and Jean H. P. Paelinck. 2007. “An Equation by Any Other Name Is Still the Same: On Spatial Econometrics and Spatial Statistics.” Annals of Regional Science 41: 209–27.\n\n\nGriliches, Zvi. 1967. “Distributed Lags: A Survey.” Econometrica 35: 16–49.\n\n\nHepple, Leslie W. 1974. “The Impact of Stochastic Process Theory Upon Spatial Analysis in Human Geography.” Progress in Geography 6: 89–142.\n\n\n———. 1976. “A Maximum Likelihood Model for Econometric Estimation with Spatial Series.” In Theory and Practice in Regional Science, edited by I. Masser, 90–104. London Papers in Regional Science. London: Pion.\n\n\nHordijk, Leen. 1974. “Spatial Correlation in the Disturbances of a Linear Interregional Model.” Regional and Urban Economics 4: 117–40.\n\n\nHordijk, Leen, and Jean H. P. Paelinck. 1976. “Some Principles and Results in Spatial Econometrics.” Recherches Economiques de Louvain 42: 175–97.\n\n\nKlaassen, Leo H., Jean H. P. Paelinck, and Sjoerd Wagenaar. 1979. Spatial Systems. Farnborough: Saxon House.\n\n\nKlein, L. R. 1958. “The Estimation of Distributed Lags.” Econometrica 26: 553–65.\n\n\nKoyck, L. M. 1954. Distributed Lags and Znoestment Analysis. Amsterdam: North-Holland.\n\n\nMcMillen, Daniel P. 2010. “Issues in Spatial Data Analysis.” Journal of Regional Science 50: 119–41.\n\n\nOrd, J. Keith. 1975. “Estimation Methods for Models of Spatial Interaction.” Journal of the American Statistical Association 70: 120–26.\n\n\n———. 2010. “Spatial Autocorrelation: A Statistician’s Reflections.” In Perspectives on Spatial Data Analysis, edited by L. Anselin and S. J. Rey, 165–80. Berlin: Springer-Verlag.\n\n\nPaelinck, Jean H. P. 2012. “Specification and Identification in Spatial Econometric Models.” Estadística Española 54: 35–52.\n\n\n———. 2013. “Some Challenges for Spatial Econometricians.” In Spatial Econometrics and Regional Economic Analysis, edited by Bogdan Suchecki, 292:11–20. Acta Universitas Lodziensis, Folia Oeconomica. Wydawnictwa Uniwersytetu Łódzkiego.\n\n\nPaelinck, Jean H. P., and Leo H. Klaassen. 1979. Spatial Econometrics. Farnborough: Saxon House.\n\n\nPaelinck, Jean H. P., and Peter Nijkamp. 1975. Operational Theory and Method in Regional Economics. Farnborough: Saxon House.\n\n\nPerroux, François. 1950. “Economic Space: Theory and Applications.” Quarterly Journal of Economics 64: 89–104.\n\n\nPonsard, Claude. 1983. History of Spatial Economic Theory. Berlin: Springer-Verlag.\n\n\nTheil, H. 1964. “Some Developments of Economic Thought in the Netherlands.” The American Economic Review 54: pp. 34–55.\n\n\nWilson, Alan G. 2000. Complex Spatial Systems: The Modelling Foundations of Urban and Regional Analysis. Harlow: Prentice Hall.\n\n\n———. 2012. The Science of Cities and Regions: Lectures on Mathematical Model Design. Dordrecht: Springer.",
    "crumbs": [
      "<span class='chapter-number'>5</span>  <span class='chapter-title'>Antecedents</span>"
    ]
  },
  {
    "objectID": "06_talk.html",
    "href": "06_talk.html",
    "title": "6  Economic and social research questions using spatial data",
    "section": "",
    "text": "In their critical appraisal of spatial econometrics, Gibbons and Overman (2012) state that:\n\nIn many (micro) economic fields—particularly development, education, environment, labor, health, and public finance—empirical work is increasingly concerned with questions about causality … If we increase an individual’s years of education, what happens to their wages? If we decrease class sizes, what happens to student grades? These questions are fundamentally of the type ‘if we change x, what do we expect to happen to y.’ Just as with economics more generally, such questions are fundamental to our understanding of spatial economics (Gibbons and Overman 2012, 172–73).\n\nIn the years preceding their description of spatial econometrics risking becoming mostly pointless, practicioners had been realising that interpretation of model output was not as simple as had been assumed. In aspatial models, there is no spatial spillover to consider, and in time-series models, only past observations can influence the present. However, in spatial autoregressive models using for example the average of neighbours’ values of the dependent variable as an explanatory variable, the coefficient of the spatially lagged dependent variable interacts with the coefficients of the independent variables (Kelejian, Tavlas, and Hondroyiannis 2006; LeSage and Fischer 2008; Ward and Gleditsch 2008; LeSage and Pace 2009). The correct interpretation of the estimated coefficients of models using spatial data is, naturally, central to exploring “‘if we change x, what do we expect to happen to y.’” See also Corrado and Fingleton (2012) for further discussion of the importance of thinking of spatial econometric models as tools for studying causality as understood at that time. \nA further, associated, bundle of strands of development in spatial econometrics following 2010 also involved causality. Delgado and Florax (2015) draw on Rubin (1974); Rubin (1978) to highlight the risk posed to the stable unit treatment value assumption (SUTVA) by unmodelled spatial dependency in the data. This key assumption for causal alaysis “implies that potential outcomes for person i are unrelated to the treatment status of other individuals” (Angrist, Imbens, and Rubin 1996). The assumption and the risk of its violation when spatial data is modelled aspatially is also discussed at that time by Koschinsky (2013) and Baylis and Ham (2015). \nWork by Delgado and Florax (2015) has been followed up by Bardaka, Delgado, and Florax (2018) and Bardaka, Delgado, and Florax (2019), showing practically how a difference-in-difference (DID) econometric design measuring the impact of change on a chosen dependent variable. Dubé et al. (2014) approach spatial difference-in-difference in a similar way, followed up in Dubé et al. (2017) and Dubé, AbdelHalim, and Devaux (2021). Bardaka, Delgado, and Florax (2018) express the two approaches:\n\nSpatial DID models have been proposed by Dubé et al. (2014) and Delgado and Florax (2015); Delgado and Florax (2015) focus on violations of SUTVA in the case of spillover eﬀects local to the treatment whereas Dubé et al. (2014) focus on global eﬀects (Bardaka, Delgado, and Florax 2018, 17).\n\nDubé et al. (2014) and work derived from this, such as Sunak and Madlener (2016) and Diao, Leonard, and Sing (2017), has been referred to directly and indirectly by an increasing number of applied studies, including Fang (2021), Jia, Shao, and Yang (2021), Qiu and Tong (2021), Liu et al. (2022), Chen et al. (2023), D. Gao and Wang (2023), Pan et al. (2023), Yu and Jin (2023) and Zeng, Blanco-González-Tejero, and Sendra (2023). Some refer to both spatial DID origins: Chagas, Azzoni, and Almeida (2016) and Qiu and Tong (2021), while some derive from Delgado and Florax (2015) alone: Han et al. (2018) and Kosfeld et al. (2021). It is clear that the demand for assessments of the consequences of for example infrastructure investments on house prices or environmental measures is enormous, so it is likely that such studies will continue to proliferate. Both Dubé et al. (2014) and Delgado and Florax (2015) presuppose that applied researchers using their approaches are adequately trained in spatial econometrics, so that these researchers are more than familiar with the spatial extensions to aspatial econometric techniques. These spatial extensions are the core of our book. \nBefore continuing to present the structure of this book, it is also sensible to cover three “breaking” topics related to causality in a spatial context. The first of the “breaking” topics extends regression discontinuity designs, from discussion in Gibbons, Machin, and Silva (2013) through Calonico, Cattaneo, and Titiunik (2014) and Keele and Titiunik (2015) to Butts (2023a) and Butts (2023b), with Cattaneo and Titiunik (2022) as an up-to-date general review. While neither Dubé et al. (2014) nor Delgado and Florax (2015) appear to be directly backed by software, software packages for R, Python and Stata for work by Sebastian Calonico, Matias D. Cattaneo and Rocío Titiunik is published; ongoing work by Kyle Butts is also available. \nThe second two “breaking” topics relate directly to Olsson (1970), in which he addressed the question of the extent to which prediction and explanation could be seen as symmetric. Summarising his findings, Olsson asserted that:\n\n… an adequate explanation may lead to a successful prediction, but … successful prediction is not the same as successful explanation. (Olsson 1970, 230)\n\nThis relates directly to: “‘if we change x, what do we expect to happen to y’”, which is more about explanation (and hence causality) than prediction. Many contemporary quantitative methods utilise predictive success to attempt to improve model fit, and having achieved predictive success try to re-construct the meaning of the output model in order to work back to explanation.\nSecondly, three important surveys of causality in spatial data analysis have appeared recently: Kolak and Anselin (2020), B. Gao et al. (2022), and Akbari, Winter, and Tomko (2023). All of these take up spatial challenges to the stable unit treatment value assumption, Kolak and Anselin (2020) with an example of the impact of changes in minimum legal drinking age laws on mortality for US states. B. Gao et al. (2022) point to the rapid extension of spatial statistics to other knowledge domains including bioinformatics, in which causal inference is clearly important. The main use cases considered by Akbari, Winter, and Tomko (2023) are in spatial cognition, including wayfinding processes and navigation systems, because these are so much broader in impact than program evaluations. Because Akbari, Winter, and Tomko (2023) is a literature review, it does not propose methods, but describes those available. They also comment that of the minority of articles included in the review that reported what software was used, the most commonly used software was R. Only 12 percent of the articles cited code needed to reproduce their results (see also Wolf 2023). They comment: \n\nThis low rate of accessibility to code is a big challenge that not only limits reproducibility of the reviewed papers, but also affects the portability and translation of approaches to other case studies in spatial causal inference. … In sum, in most of the reviewed research, there are no clear procedures related to reproducibility and validation. We can trust more the results of papers with straightforward approaches with a sufficient level of details. (Akbari, Winter, and Tomko 2023, 79)\n\nThe final “breaking” topic is the influence of spatial autocorrelation on machine learning, statistical learning, and convolutional neural networks. Kattenborn et al. (2022) study the impact of spatial autocorrelation on the training of convolutional neural networks for data acquired by drones, and find: \n\nOur results suggest that violating spatial independence between training and test data can severely inflate model apparent performance (up to almost 30%) and, hence, lead to an overly optimistic evaluation of the generalization of such models. (Kattenborn et al. 2022, 7)\n\nThis observation, that the violation of the assumption of spatial independence between training, validation and test data sets prejudices outcomes, has been recognised in much of spatial data science for years, at least from Brenning (2012). There is now an extensive literature both on the split between training and test data sets, and on the use of fitted models for prediction to areas that were un- or under-represented in the data used to fit the model (Meyer et al. 2018, 2019; Valavi et al. 2019; Schratz et al. 2019; Meyer and Pebesma 2021, 2022; Mila et al. 2022; Linnenbrink et al. 2023). These articles are accompanied by software permitting the reproduction of their findings and the application of suggested adaptations, replacing random permutations in machine learning model fitting and tuning by spatially-aware procedures. \nKopczewska (2022) summarises the current research position with regard to spatial data use in machine learning in this way: \n\nIt is clear from many studies that unaddressed spatial autocorrelation generates problems, such as overoptimistic fit of models, omitted information and/or biased (suboptimal) prediction. Thus, an up-to-date toolbox dealing with spatial autocorrelation should be used in all ML models in order to ensure methodological appropriateness. (Kopczewska 2022, 732)\n\nShe does, however, provide encouraging examples of the spatially-informed use of machine learning methods, and a concise overview of concepts and a listing of relevant R packages in two appendices (Kopczewska 2022, 735–49). \nWagner and Zeileis (2019) use model-based recursive partitioning handling the spatial dependencies by including the spatially lagged dependent variable in a spatial econometric model to study heterogeneous growth. Vidoli, Pignataro, and Benedetti (2022) approach heterogeneity through spatial regimes, as do Piras and Sarrias (2023); all three articles are backed by software. \nNikparvar and Thill (2021) give a broad review of machine learning methods and applications to spatial data, including attention to spatial autocorrelation, spatial scale and spatial heterogeneity. Credit (2022) considers the intersection of random forest models - a machine learning method aggregating the outout of many decision trees - and spatial econometrics models. In addition to the inclusion of the spatially lagged dependent variable (Wagner and Zeileis 2019), spatially lagged independent variables were considered. Yoshida, Murakami, and Seya (2022) compare a selection of spatially-aware machine learning approaches and a nearest-neighbour Gaussian process model for predicting apartment rents, following some of the suggestions made by Credit (2022); references to software are provided. \nConsideration of machine learning and the application of deep learning/neural networks overlaps in a fair number of cases, raising similar concerns about how the probable lack of independence between proximate observations in space will be handled. Ahmed et al. (2021) stress the need for interpretability and explainability in deep learning/neural networks (also known as artificial intelligence) as well as in machine learning, and explore model agnostic greedy explanations of model predictions; references to software are provided. \nZhang et al. (2022) and Deng, He, and Liu (2023) also focus on interpretability of machine learning methods for predicting crime risk; Deng, He, and Liu (2023) provide their complete data set. Zhu et al. (2023b; minor correction Zhu et al. 2023a) propose spatial regression graph convolutional neural networks for modelling and predicting multivariate spatial data, also considering what is known as feature selection (or engineering), which is related to interpretability; references to software are provided. \nLi et al. (2023), like Credit (2022), introduce the spatially lagged dependent variable (whether a manhole in an urban drainage system overflows or not) into a deep neural network model. Xiao, Song, and Wang (2023) and Wang and Song (2023) in two articles with overlapping authorships look more closely at integrating adaptations of classical spatial econometrics models - spatial autoregressive models - into deep neural network models, both making nonparametric additions to the classical models. \nThe literatures covering the interpretation of spatial econometric models, causality when the data used are spatial and so challenge standard econometric assumptions, and training/test set data splits affecting machine learning and artificial intelligence applications, are all burgeoning. It might be thought that the superficial mentioning of these questions in this section should direct us to focus attention in this book on emerging research opportunities. However, our reading of contributions to the current literature, taken with readings of the many other articles published since 2020 - Dubé et al. (2014) has been cited hundreds of times, mostly since 2020 - suggests that many authors would benefit substantially from a clearer grasp of the background to spatial econometric models, and many of their internal characteristcs. Hence, based in part on this motivation, we will now move to present the structure of this book.\n\n\n\n\nAhmed, Zia U., Kang Sun, Michael Shelly, and Lina Mu. 2021. “Explainable Artificial Intelligence (XAI) for Exploring Spatial Variability of Lung and Bronchus Cancer (LBC) Mortality Rates in the Contiguous USA.” Scientific Reports 11: 24090. https://doi.org/10.1038/s41598-021-03198-8.\n\n\nAkbari, Kamal, Stephan Winter, and Martin Tomko. 2023. “Spatial Causality: A Systematic Review on Spatial Causal Inference.” Geographical Analysis 55 (1): 56–89. https://doi.org/10.1111/gean.12312.\n\n\nAngrist, Joshua D., Guido W. Imbens, and Donald B. Rubin. 1996. “Identification of Causal Effects Using Instrumental Variables.” Journal of the American Statistical Association 91 (434): 444–72.\n\n\nBardaka, Eleni, Michael S. Delgado, and Raymond J. G. M. Florax. 2018. “Causal Identification of Transit-Induced Gentrification and Spatial Spillover Effects: The Case of the Denver Light Rail.” Journal of Transport Geography 71: 15–31. https://doi.org/10.1016/j.jtrangeo.2018.06.025.\n\n\n———. 2019. “A Spatial Multiple Treatment/Multiple Outcome Difference-in-Differences Model with an Application to Urban Rail Infrastructure and Gentrification.” Transportation Research Part A: Policy and Practice 121: 325–45. https://doi.org/10.1016/j.tra.2019.01.028.\n\n\nBaylis, Kathy, and Andrés Ham. 2015. “How Important Is Spatial Correlation in Randomized Controlled Trials?” https://ageconsearch.umn.edu/record/205586/.\n\n\nBrenning, Alexander. 2012. “Spatial Cross-Validation and Bootstrap for the Assessment of Prediction Rules in Remote Sensing: The r Package Sperrorest.” In 2012 IEEE International Geoscience and Remote Sensing Symposium, 5372–75. https://doi.org/10.1109/IGARSS.2012.6352393.\n\n\nButts, Kyle. 2023a. “Geographic Difference-in-Discontinuities.” Applied Economics Letters 30 (5): 615–19. https://doi.org/10.1080/13504851.2021.2005236.\n\n\n———. 2023b. “JUE Insight: Difference-in-Differences with Geocoded Microdata.” Journal of Urban Economics 133: 103493. https://doi.org/10.1016/j.jue.2022.103493.\n\n\nCalonico, Sebastian, Matias D. Cattaneo, and Rocio Titiunik. 2014. “Robust Nonparametric Confidence Intervals for Regression-Discontinuity Designs.” Econometrica 82 (6): 2295–2326. https://doi.org/10.3982/ECTA11757.\n\n\nCattaneo, Matias D., and Rocı́o Titiunik. 2022. “Regression Discontinuity Designs.” Annual Review of Economics 14 (1): 821–51. https://doi.org/10.1146/annurev-economics-051520-021409.\n\n\nChagas, André L. S., Carlos R. Azzoni, and Alexandre N. Almeida. 2016. “A Spatial Difference-in-Differences Analysis of the Impact of Sugarcane Production on Respiratory Diseases.” Regional Science and Urban Economics 59: 24–36. https://doi.org/10.1016/j.regsciurbeco.2016.04.002.\n\n\nChen, Jinyu, Wenjing Luo, Xiaohang Ren, and Tianqi Liu. 2023. “The Local-Neighborhood Effects of Low-Carbon City Pilots Program on PM2.5 in China: A Spatial Difference-in-Differences Analysis.” Science of The Total Environment 857: 159511. https://doi.org/10.1016/j.scitotenv.2022.159511.\n\n\nCorrado, Luisa, and Bernard Fingleton. 2012. “Where Is the Economics in Spatial Econometrics?” Journal of Regional Science 52: 210–39.\n\n\nCredit, Kevin. 2022. “Spatial Models or Random Forest? Evaluating the Use of Spatially Explicit Machine Learning Methods to Predict Employment Density Around New Transit Stations in Los Angeles.” Geographical Analysis 54 (1): 58–83. https://doi.org/10.1111/gean.12273.\n\n\nDelgado, Michael S., and Raymond J. G. M. Florax. 2015. “Difference-in-Differences Techniques for Spatial Data: Local Autocorrelation and Spatial Interaction.” Economics Letters 137: 123–26. https://doi.org/10.1016/j.econlet.2015.10.035.\n\n\nDeng, Yue, Rixing He, and Yang Liu. 2023. “Crime Risk Prediction Incorporating Geographical Spatiotemporal Dependency into Machine Learning Models.” Information Sciences 646: 119414. https://doi.org/10.1016/j.ins.2023.119414.\n\n\nDiao, Mi, Delon Leonard, and Tien Foo Sing. 2017. “Spatial-Difference-in-Differences Models for Impact of New Mass Rapid Transit Line on Private Housing Values.” Regional Science and Urban Economics 67: 64–77. https://doi.org/10.1016/j.regsciurbeco.2017.08.006.\n\n\nDubé, Jean, Maha AbdelHalim, and Nicolas Devaux. 2021. “Evaluating the Impact of Floods on Housing Price Using a Spatial Matching Difference-in-Differences (SM-DID) Approach.” Sustainability 13 (2). https://doi.org/10.3390/su13020804.\n\n\nDubé, Jean, Diègo Legros, Marius Thériault, and François Des Rosiers. 2014. “A Spatial Difference-in-Differences Estimator to Evaluate the Effect of Change in Public Mass Transit Systems on House Prices.” Transportation Research Part B: Methodological 64: 24–40. https://doi.org/10.1016/j.trb.2014.02.007.\n\n\n———. 2017. “Measuring and Interpreting Urban Externalities in Real-Estate Data: A Spatio-Temporal Difference-in-Differences (STDID) Estimator.” Buildings 7 (2). https://doi.org/10.3390/buildings7020051.\n\n\nFang, Jing. 2021. “Impacts of High-Speed Rail on Urban Smog Pollution in China: A Spatial Difference-in-Difference Approach.” Science of The Total Environment 777: 146153. https://doi.org/10.1016/j.scitotenv.2021.146153.\n\n\nGao, Bingbo, Jinfeng Wang, Alfred Stein, and Ziyue Chen. 2022. “Causal Inference in Spatial Statistics.” Spatial Statistics 50: 100621. https://doi.org/10.1016/j.spasta.2022.100621.\n\n\nGao, Da, and Guimei Wang. 2023. “Does the Opening of High-Speed Rails Improve Urban Carbon Efficiency? Evidence from a Spatial Difference-in-Difference Method.” Environmental Science and Pollution Research 30: 101873–87.\n\n\nGibbons, Stephen, Stephen Machin, and Olmo Silva. 2013. “Valuing School Quality Using Boundary Discontinuities.” Journal of Urban Economics 75: 15–28.\n\n\nGibbons, Stephen, and Henry G. Overman. 2012. “Mostly Pointless Spatial Econometrics?” Journal of Regional Science 52: 172–91.\n\n\nHan, Mengjie, Oana Mihaescu, Yujiao Li, and Niklas Rudholm. 2018. “Comparison and One-Stop Shopping After Big-Box Retail Entry: A Spatial Difference-in-Difference Analysis.” Journal of Retailing and Consumer Services 40: 175–87. https://doi.org/10.1016/j.jretconser.2017.10.003.\n\n\nJia, Ruining, Shuai Shao, and Lili Yang. 2021. “High-Speed Rail and CO2 Emissions in Urban China: A Spatial Difference-in-Differences Approach.” Energy Economics 99: 105271. https://doi.org/10.1016/j.eneco.2021.105271.\n\n\nKattenborn, Teja, Felix Schiefer, Julian Frey, Hannes Feilhauer, Miguel D. Mahecha, and Carsten F. Dormann. 2022. “Spatially Autocorrelated Training and Validation Samples Inflate Performance Assessment of Convolutional Neural Networks.” ISPRS Open Journal of Photogrammetry and Remote Sensing 5: 100018. https://doi.org/10.1016/j.ophoto.2022.100018.\n\n\nKeele, Luke J., and Rocío Titiunik. 2015. “Geographic Boundaries as Regression Discontinuities.” Political Analysis 23 (1): 127–55. https://doi.org/10.1093/pan/mpu014.\n\n\nKelejian, Harry H., G. Tavlas, and G. Hondroyiannis. 2006. “A Spatial Modelling Approach to Contagion Among Emerging Economies.” Open Economies Review 17: 423–41.\n\n\nKolak, Marynia, and Luc Anselin. 2020. “A Spatial Perspective on the Econometrics of Program Evaluation.” International Regional Science Review 43 (1-2): 128–53. https://doi.org/10.1177/0160017619869781.\n\n\nKopczewska, Katarzyna. 2022. “Spatial Machine Learning: New Opportunities for Regional Science.” The Annals of Regional Science 68 (3): 713–55. https://doi.org/10.1007/s00168-021-01101-x.\n\n\nKoschinsky, Julia. 2013. “The Case for Spatial Analysis in Evaluation to Reduce Health Inequities.” Evaluation and Program Planning 36 (1): 172–76. https://doi.org/10.1016/j.evalprogplan.2012.03.004.\n\n\nKosfeld, Reinhold, Timo Mitze, Johannes Rode, and Klaus Wälde. 2021. “The Covid-19 Containment Effects of Public Health Measures: A Spatial Difference-in-Differences Approach.” Journal of Regional Science 61 (4): 799–825. https://doi.org/10.1111/jors.12536.\n\n\nLeSage, James P., and Manfred M. Fischer. 2008. “Spatial Growth Regression: Model Specification, Estimation and Interpretation.” Spatial Economic Analysis 3: 275–304.\n\n\nLeSage, James P., and R. Kelley Pace. 2009. Introduction to Spatial Econometrics. Boca Raton FL: Chapman; Hall/CRC.\n\n\nLi, Heng, Chunxiao Zhang, Min Chen, Dingtao Shen, and Yunyun Niu. 2023. “Data-Driven Surrogate Modeling: Introducing Spatial Lag to Consider Spatial Autocorrelation of Flooding Within Urban Drainage Systems.” Environmental Modelling & Software 161: 105623. https://doi.org/10.1016/j.envsoft.2023.105623.\n\n\nLinnenbrink, J., C. Milà, M. Ludwig, and H. Meyer. 2023. “kNNDM: K-Fold Nearest Neighbour Distance Matching Cross-Validation for Map Accuracy Estimation.” EGUsphere 2023: 1–16. https://doi.org/10.5194/egusphere-2023-1308.\n\n\nLiu, Jun, Yu Qian, Shun-feng Song, and Rong-rong Duan. 2022. “Industrial Symbiotic Agglomeration and Green Economic Growth: A Spatial Difference-in-Differences Approach.” Journal of Cleaner Production 364: 132560. https://doi.org/10.1016/j.jclepro.2022.132560.\n\n\nMeyer, Hanna, and Edzer Pebesma. 2021. “Predicting into Unknown Space? Estimating the Area of Applicability of Spatial Prediction Models.” Methods in Ecology and Evolution 12 (9): 1620–33. https://doi.org/10.1111/2041-210X.13650.\n\n\n———. 2022. “Machine Learning-Based Global Maps of Ecological Variables and the Challenge of Assessing Them.” Nature Communincations 13. https://doi.org/ 10.1038/s41467-022-29838-9 .\n\n\nMeyer, Hanna, Christoph Reudenbach, Tomislav Hengl, Marwan Katurji, and Thomas Nauss. 2018. “Improving Performance of Spatio-Temporal Machine Learning Models Using Forward Feature Selection and Target-Oriented Validation.” Environmental Modelling & Software 101: 1–9. https://doi.org/10.1016/j.envsoft.2017.12.001.\n\n\nMeyer, Hanna, Christoph Reudenbach, Stephan Wöllauer, and Thomas Nauss. 2019. “Importance of Spatial Predictor Variable Selection in Machine Learning Applications – Moving from Data Reproduction to Spatial Prediction.” Ecological Modelling 411: 108815. https://doi.org/10.1016/j.ecolmodel.2019.108815.\n\n\nMila, Carles, Jorge Mateu, Edzer Pebesma, and Hanna Meyer. 2022. “Nearest Neighbour Distance Matching Leave-One-Out Cross-Validation for Map Validation.” Methods in Ecology and Evolution 13 (6): 1304–16. https://doi.org/10.1111/2041-210X.13851.\n\n\nNikparvar, Behnam, and Jean-Claude Thill. 2021. “Machine Learning of Spatial Data.” ISPRS International Journal of Geo-Information 10 (9). https://doi.org/10.3390/ijgi10090600.\n\n\nOlsson, Gunnar. 1970. “Explanation, Prediction, and Meaning Variance: An Assessment of Distance Interaction Models.” Economic Geography 46: 223–33. http://www.jstor.org/stable/143140.\n\n\nPan, Minjie, Weiyong Zou, Kangjuan Lv, and Xinlei Qian. 2023. “Can Environmental Protection Interview Policy Reduce Air Pollution? -a Spatial Difference-in-Differences Approach.” Applied Economics 55 (11): 1217–33. https://doi.org/10.1080/00036846.2022.2096869.\n\n\nPiras, Gianfranco, and Mauricio Sarrias. 2023. “Heterogeneous Spatial Models in r: Spatial Regimes Models.” Journal of Spatial Econometrics 4. https://doi.org/10.1007/s43071-023-00034-1.\n\n\nQiu, Feng, and Qingmeng Tong. 2021. “A Spatial Difference-in-Differences Approach to Evaluate the Impact of Light Rail Transit on Property Values.” Economic Modelling 99: 105496. https://doi.org/10.1016/j.econmod.2021.03.015.\n\n\nRubin, Donald B. 1974. “Estimating Causal Effects of Treatments in Randomized and Nonrandomized Studies.” Journal of Educational Psychology 66: 688–701. https://doi.org/10.1037/h0037350.\n\n\n———. 1978. “Bayesian Inference for Causal Effects: The Role of Randomization.” The Annals of Statistics 6 (1): 34–58.\n\n\nSchratz, Patrick, Jannes Muenchow, Eugenia Iturritxa, Jakob Richter, and Alexander Brenning. 2019. “Hyperparameter Tuning and Performance Assessment of Statistical and Machine-Learning Algorithms Using Spatial Data.” Ecological Modelling 406: 109–20. https://doi.org/10.1016/j.ecolmodel.2019.06.002.\n\n\nSunak, Yasin, and Reinhard Madlener. 2016. “The Impact of Wind Farm Visibility on Property Values: A Spatial Difference-in-Differences Analysis.” Energy Economics 55: 79–91. https://doi.org/10.1016/j.eneco.2015.12.025.\n\n\nValavi, Roozbeh, Jane Elith, José J. Lahoz-Monfort, and Gurutzeta Guillera-Arroita. 2019. “blockCV: An R Package for Generating Spatially or Environmentally Separated Folds for k-Fold Cross-Validation of Species Distribution Models.” Methods in Ecology and Evolution 10 (2): 225–32. https://doi.org/10.1111/2041-210X.13107.\n\n\nVidoli, Francesco, Giacomo Pignataro, and Roberto Benedetti. 2022. “Identification of Spatial Regimes of the Production Function of Italian Hospitals Through Spatially Constrained Cluster-Wise Regression.” Socio-Economic Planning Sciences 82: 101223. https://doi.org/10.1016/j.seps.2022.101223.\n\n\nWagner, Martin, and Achim Zeileis. 2019. “Heterogeneity and Spatial Dependence of Regional Growth in the EU: A Recursive Partitioning Approach.” German Economic Review 20 (1): 67–82. https://doi.org/10.1111/geer.12146.\n\n\nWang, Zhijian, and Yunquan Song. 2023. “Deep Learning for the Spatial Additive Autoregressive Model with Nonparametric Endogenous Effect.” Spatial Statistics 55: 100743. https://doi.org/10.1016/j.spasta.2023.100743.\n\n\nWard, M. D., and K. S. Gleditsch. 2008. Spatial Regression Models. Thousand Oaks, CA: Sage.\n\n\nWolf, Levi J. 2023. “Beyond Open Science: Data, Code, and Causality.” Environment and Planning B: Urban Analytics and City Science 50 (9): 2333–36. https://doi.org/10.1177/23998083231210180.\n\n\nXiao, Shuyue, Yunquan Song, and Zhijian Wang. 2023. “Nonparametric Spatial Autoregressive Model Using Deep Neural Networks.” Spatial Statistics 57: 100766. https://doi.org/10.1016/j.spasta.2023.100766.\n\n\nYoshida, Takahiro, Daisuke Murakami, and Hajime Seya. 2022. “Spatial Prediction of Apartment Rent Using Regression-Based and Machine Learning-Based Approaches with a Large Dataset.” Journal of Real Estate Finance & Economics, 1–28. https://doi.org/10.1007/s11146-022-09929-6.\n\n\nYu, Nannan, and Ying Jin. 2023. “The Unintended Economic Impact of High-Speed Rail on China’s Non-Core Cities: A Spatial-Difference-in-Differences Analysis.” Cities 143: 104618. https://doi.org/10.1016/j.cities.2023.104618.\n\n\nZeng, Juying, Cristina Blanco-González-Tejero, and F. Javier Sendra. 2023. “The Spatial Difference-in-Difference Measurement of Policy Effect of Environmental Protection Interview on Green Innovation.” Technological Forecasting and Social Change 191: 122511. https://doi.org/10.1016/j.techfore.2023.122511.\n\n\nZhang, Xu, Lin Liu, Minxuan Lan, Guangwen Song, Luzi Xiao, and Jianguo Chen. 2022. “Interpretable Machine Learning Models for Crime Prediction.” Computers, Environment and Urban Systems 94: 101789. https://doi.org/10.1016/j.compenvurbsys.2022.101789.\n\n\nZhu, Di, Yu Liu, Xin Yao, and Manfred M. Fischer. 2023a. “Correction to: Spatial Regression Graph Convolutional Neural Networks: A Deep Learning Paradigm for Spatial Multivariate Distributions.” GeoInformatica 27: 641–42. https://doi.org/10.1007/s10707-022-00461-6.\n\n\n———. 2023b. “Spatial Regression Graph Convolutional Neural Networks: A Deep Learning Paradigm for Spatial Multivariate Distributions.” GeoInformatica 26: 645–76. https://doi.org/10.1007/s10707-021-00454-x.",
    "crumbs": [
      "<span class='chapter-number'>6</span>  <span class='chapter-title'>Economic and social research questions using spatial data</span>"
    ]
  },
  {
    "objectID": "07_talk.html",
    "href": "07_talk.html",
    "title": "7  Tests of spatial autocorrelation, model specification",
    "section": "",
    "text": "7.1 Univariate tests of spatial autocorrelation\nlibrary(spdep)\n\nLoading required package: spData\n\n\nLoading required package: sf\n\n\nLinking to GEOS 3.12.1, GDAL 3.8.4, PROJ 9.3.1; sf_use_s2() is TRUE\n\nlw &lt;- nb2listw(unb, style=\"W\")\nmoran.test(eng324$realNetPre, listw=lw, randomisation=TRUE, alternative=\"two.sided\")\n\n\n    Moran I test under randomisation\n\ndata:  eng324$realNetPre  \nweights: lw    \n\nMoran I statistic standard deviate = 6.9357, p-value = 4.042e-12\nalternative hypothesis: two.sided\nsample estimates:\nMoran I statistic       Expectation          Variance \n      0.244871308      -0.003095975       0.001278221\nMoran’s I is given as (Cliff and Ord 1981, 17):\nI = \\frac{n \\sum_{(2)} w_{ij} z_i z_j}{S_0 \\sum_{i=1}^{n} z_i^2}\nwhere x_i, i=1, \\ldots, n are n observations on the numeric variable of interest, z_i = x_i - \\bar{x}, \\bar{x} = \\sum_{i=1}^{n} x_i / n, \\sum_{(2)} = \\stackrel{\\sum_{i=1}^{n} \\sum_{j=1}^{n}}{i \\neq j}, w_{ij} are the spatial weights, and S_0 = \\sum_{(2)} w_{ij}. A comparison of implementations of measures of spatial autocorrelation shows that a wide range of measures is available in R in a number of packages, chiefly in the spdep package, and that differences from other implementations can be attributed to design decisions (Bivand and Wong 2018). The spdep package also includes the only implementations of exact and Saddlepoint approximations to global Moran’s I (Tiefelsdorf 2002; Bivand, Müller, and Reder 2009).\nGlobal measures of spatial autocorrelation using spatial weights objects based on graphs of neighbours are, as we have seen, rather blunt tools, which for interpretation depend critically on a reasoned mean model of the variable in question. If the mean model is just the intercept, the global measures will respond to all kinds of mis-specification, not only spatial autocorrelation (Schabenberger and Gotway 2005; McMillen 2003).",
    "crumbs": [
      "<span class='chapter-number'>7</span>  <span class='chapter-title'>Tests of spatial autocorrelation, model specification</span>"
    ]
  },
  {
    "objectID": "07_talk.html#tests-of-residual-spatial-autocorrelation",
    "href": "07_talk.html#tests-of-residual-spatial-autocorrelation",
    "title": "7  Tests of spatial autocorrelation, model specification",
    "section": "7.2 Tests of residual spatial autocorrelation",
    "text": "7.2 Tests of residual spatial autocorrelation\nWhen the model is the null model, containing only the intercept, the univariate test moran.test on the residuals with randomisation=FALSE and the test on residuals lm.morantest are the same:\n\nlm_null &lt;- lm(realNetPre ~ 1, data=eng324)\nmoran.test(residuals(lm_null), listw=lw,\n randomisation=FALSE, alternative=\"two.sided\")\n\n\n    Moran I test under normality\n\ndata:  residuals(lm_null)  \nweights: lw    \n\nMoran I statistic standard deviate = 6.7433, p-value = 1.548e-11\nalternative hypothesis: two.sided\nsample estimates:\nMoran I statistic       Expectation          Variance \n      0.244871308      -0.003095975       0.001352204 \n\n\n\nlm.morantest(lm_null, listw=lw, alternative=\"two.sided\")\n\n\n    Global Moran I for regression residuals\n\ndata:  \nmodel: lm(formula = realNetPre ~ 1, data = eng324)\nweights: lw\n\nMoran I statistic standard deviate = 6.7433, p-value = 1.548e-11\nalternative hypothesis: two.sided\nsample estimates:\nObserved Moran I      Expectation         Variance \n     0.244871308     -0.003095975      0.001352204 \n\n\nIf we move to a model with independent variables, we will see that the inferences are not the same:\n\nform_pre &lt;- log(realNetPre) ~ log(units) + house +\n log(dens) + Metrop + log(realWgPre)\nlm_obj_pre &lt;- lm(form_pre, data=eng324)\nmoran.test(residuals(lm_obj_pre), listw=lw,\n randomisation=FALSE, alternative=\"two.sided\")\n\n\n    Moran I test under normality\n\ndata:  residuals(lm_obj_pre)  \nweights: lw    \n\nMoran I statistic standard deviate = 4.521, p-value = 6.156e-06\nalternative hypothesis: two.sided\nsample estimates:\nMoran I statistic       Expectation          Variance \n      0.163150227      -0.003095975       0.001352204 \n\n\n\nlm.morantest(lm_obj_pre, listw=lw, alternative=\"two.sided\")\n\n\n    Global Moran I for regression residuals\n\ndata:  \nmodel: lm(formula = form_pre, data = eng324)\nweights: lw\n\nMoran I statistic standard deviate = 4.7671, p-value = 1.869e-06\nalternative hypothesis: two.sided\nsample estimates:\nObserved Moran I      Expectation         Variance \n     0.163150227     -0.010433124      0.001325885 \n\n\nThis is because lm.morantest takes into account the structure of the regression model, as do lm.morantest.sad and lm.morantest.exact:\n\nlm.morantest.sad(lm_obj_pre, listw=lw, alternative=\"two.sided\")\n\n\n    Saddlepoint approximation for global Moran's I (Barndorff-Nielsen\n    formula)\n\ndata:  \nmodel:lm(formula = form_pre, data = eng324)\nweights: lw\n\nSaddlepoint approximation = 4.4651, p-value = 8.004e-06\nalternative hypothesis: two.sided\nsample estimates:\nObserved Moran I \n       0.1631502 \n\n\n\nlm.morantest.exact(lm_obj_pre, listw=lw, alternative=\"two.sided\")\n\n\n    Global Moran I statistic with exact p-value\n\ndata:  \nmodel:lm(formula = form_pre, data = eng324)\nweights: lw\n\nExact standard deviate = 4.4649, p-value = 8.01e-06\nalternative hypothesis: two.sided\nsample estimates:\n[1] 0.1631502\n\n\nIn all these cases, the measured value of Moran’s I is the same, but the inferences differ somewhat.",
    "crumbs": [
      "<span class='chapter-number'>7</span>  <span class='chapter-title'>Tests of spatial autocorrelation, model specification</span>"
    ]
  },
  {
    "objectID": "07_talk.html#model-specification",
    "href": "07_talk.html#model-specification",
    "title": "7  Tests of spatial autocorrelation, model specification",
    "section": "7.3 Model specification",
    "text": "7.3 Model specification\nA recent review of spatial regression in a spatial econometrics setting is given by Kelejian and Piras (2017); note that their usage is to call the spatial coefficient of the lagged response \\lambda and that of the lagged residuals \\rho, the reverse of other usage (Anselin 1988; J. P. LeSage and Pace 2009); here we use \\rho_{\\mathrm{Lag}} for the spatial coefficient in the spatial lag model, and \\rho_{\\mathrm{Err}} for the spatial error model. One interesting finding is that relatively dense spatial weights matrices may downweight model estimates, suggesting that sparser weights are preferable (Smith 2009). Another useful finding is that the presence of residual spatial autocorrelation need not bias the estimates of variance of regression coefficients, provided that the covariates themselves do not exhibit spatial autocorrelation (Smith and Lee 2012).\nIn trying to model these spatial processes, we may choose to model the spatial autocorrelation in the residual with a spatial error model (SEM).\n\n{\\mathbf y} = {\\mathbf X}{\\mathbf \\beta} + {\\mathbf u},\n\\qquad {\\mathbf u} = \\rho_{\\mathrm{Err}} {\\mathbf W} {\\mathbf u} + {\\mathbf \\varepsilon},\n\nwhere {\\mathbf y} is an (N \\times 1) vector of observations on a response variable taken at each of N locations, {\\mathbf X} is an (N \\times k) matrix of covariates, {\\mathbf \\beta} is a (k \\times 1) vector of parameters, {\\mathbf u} is an (N \\times 1) spatially autocorrelated disturbance vector, {\\mathbf \\varepsilon} is an (N \\times 1) vector of independent and identically distributed disturbances and \\rho_{\\mathrm{Err}} is a scalar spatial parameter.\nIf the processes in the covariates and the response match, we should find little difference between the coefficients of a least squares and a SEM, but very often they diverge, suggesting that a Hausman test for this condition should be employed (Pace and LeSage 2008). This may be related to earlier discussions of a spatial equivalent to the unit root and cointegration where spatial processes match (Fingleton 1999).\nA model with a spatial process in the response only is termed a spatial lag model (SLM, often SAR - spatial autoregressive) (J. P. LeSage and Pace 2009).\n\n{\\mathbf y} = \\rho_{\\mathrm{Lag}} {\\mathbf W}{\\mathbf y} + {\\mathbf X}{\\mathbf \\beta} + {\\mathbf \\varepsilon},\n where \\rho_{\\mathrm{Lag}} is a scalar spatial parameter.\nWork reviewed by Mur and Angulo (2006) on the Durbin model; the Durbin model adds the spatially lagged covariates to the covariates included in the spatial lag model, giving a spatial Durbin model (SDM) with different processes in the response and covariates:\n\n{\\mathbf y} = \\rho_{\\mathrm{Lag}} {\\mathbf W}{\\mathbf y} + {\\mathbf X}{\\mathbf \\beta} + {\\mathbf W}{\\mathbf X}{\\mathbf \\gamma} + {\\mathbf \\varepsilon},\n\nwhere {\\mathbf \\gamma} is a (k' \\times 1) vector of parameters. k' defines the subset of the intercept and covariates, often k' = k-1 when using row standardised spatial weights and omitting the spatially lagged intercept.\nThis permits the spatial processes to be viewed and tested for as a Common Factor (Burridge 1981; Bivand 1984). The inclusion of spatially lagged covariates lets us check whether the same spatial process is manifest in the response and the covariates (SEM), whether they are different processes, or whether no process is detected. The Common Factor is present when {\\mathbf \\gamma} = - \\rho_{\\mathrm{Lag}} {\\mathbf \\beta}:\n\n{\\mathbf y} = \\rho_{\\mathrm{Lag}} {\\mathbf W}{\\mathbf y} + {\\mathbf X}{\\mathbf \\beta} - \\rho_{\\mathrm{Lag}} {\\mathbf W}{\\mathbf X} {\\mathbf \\beta} + {\\mathbf \\varepsilon},\n\\qquad ({\\mathbf I} - \\rho_{\\mathrm{Lag}} {\\mathbf W}){\\mathbf y} = ({\\mathbf I} - \\rho_{\\mathrm{Lag}} {\\mathbf W}) {\\mathbf X}{\\mathbf \\beta} + {\\mathbf \\varepsilon},\n where {\\mathbf I} is the N \\times N identity matrix, and {\\mathbf I} - \\rho_{\\mathrm{Lag}} {\\mathbf W} is the Common Factor:\n\n\\qquad {\\mathbf y} = {\\mathbf X}{\\mathbf \\beta} + ({\\mathbf I} - \\rho_{\\mathrm{Lag}} {\\mathbf W})^{-1} {\\mathbf \\varepsilon},\n\\qquad {\\mathbf y} = {\\mathbf X}{\\mathbf \\beta} + {\\mathbf u},\n\\qquad {\\mathbf u} = \\rho_{\\mathrm{Err}} {\\mathbf W} {\\mathbf u} + {\\mathbf \\varepsilon},\n\nIf we extend this family with processes in the covariates and the residual, we get a spatial error Durbin model (SDEM). If it is chosen to admit a spatial process in the residuals in addition to a spatial process in the response, again two models are formed, a general nested model (GNM) nesting all the others, and a model without spatially lagged covariates (SAC, also known as SARAR - Spatial AutoRegressive-AutoRegressive model). If neither the residuals nor the residual are modelled with spatial processes, spatially lagged covariates may be added to a linear model, as a spatially lagged X model (SLX) (Elhorst 2010; Bivand 2012; J. LeSage 2014; Halleck Vega and Elhorst 2015).\nWe can write the general nested model (GNM) as:\n\n{\\mathbf y} = \\rho_{\\mathrm{Lag}} {\\mathbf W}{\\mathbf y} + {\\mathbf X}{\\mathbf \\beta} + {\\mathbf W}{\\mathbf X}{\\mathbf \\gamma} + {\\mathbf u},\n\\qquad {\\mathbf u} = \\rho_{\\mathrm{Err}} {\\mathbf W} {\\mathbf u} + {\\mathbf \\varepsilon},\n\nThis may be constrained to the double spatial coefficient model SAC/SARAR by setting {\\mathbf \\gamma} = 0, to the spatial Durbin (SDM) by setting \\rho_{\\mathrm{Err}} = 0, and to the error Durbin model (SDEM) by setting \\rho_{\\mathrm{Lag}} = 0. Imposing more conditions gives the spatial lag model (SLM) with {\\mathbf \\gamma} = 0 and \\rho_{\\mathrm{Err}} = 0, the spatial error model (SEM) with {\\mathbf \\gamma} = 0 and \\rho_{\\mathrm{Lag}} = 0, and the spatially lagged X model (SLX) with \\rho_{\\mathrm{Lag}} = 0 and \\rho_{\\mathrm{Err}} = 0.\nThe specification problem is then to choose between (from most complex to simplest): GNM (three sets of spatial parameters: \\rho_{\\mathrm{Lag}}, \\rho_{\\mathrm{Err}}, {\\mathbf \\gamma}), SAC, SDM or SDEM (two sets of spatial parameters among the three), SEM, SLM, SLX (one set of spatial parameters among the three) or ordinary least squares (no spatial parameters) - assuming that the dependent variable is Gaussian. Effectively the same specification choice is present with limited dependent variables.",
    "crumbs": [
      "<span class='chapter-number'>7</span>  <span class='chapter-title'>Tests of spatial autocorrelation, model specification</span>"
    ]
  },
  {
    "objectID": "07_talk.html#raos-score-lagrange-multiplier-tests",
    "href": "07_talk.html#raos-score-lagrange-multiplier-tests",
    "title": "7  Tests of spatial autocorrelation, model specification",
    "section": "7.4 Rao’s score (Lagrange multiplier) tests",
    "text": "7.4 Rao’s score (Lagrange multiplier) tests\nWhen working over 25 years ago on Bivand and Szymanski (2000), the only Rao’s score (Lagrange multiplier) tests available were those newly proposed by Anselin et al. (1996). The underlying concern is to test whether the spatial parameter of interest could be taken as zero, without estimating the parameter. One works from the information matrix of the spatial model; in the case of the first tests, a mixed regressive-spatial autoregressive model with a spatial autoregressive disturbance (SAC) was considered, as this had also been used for residual autocorrelation in an SLM model. Five tests are proposed, a test for missing \\rho_{\\mathrm{Lag}} {\\mathbf W}{\\mathbf y}, \"RSlag\" and pointing to SLM, another for missing \\rho_{\\mathrm{Err}} {\\mathbf W} {\\mathbf u}, \"RSerr\" pointing to SEM, two tests matching the first two tests but adjusted for the presence of the other (\"adjRSlag\", \"adjRSerr\"), and a \"SARMA\" test combining both alternatives, equal to \"RSlag\" plus \"adjRSerr\" and \"RSerr\" plus \"adjRSlag\".\n\nsummary(lm.RStests(lm_obj_pre, listw=lw, test=\"all\"))\n\n    Rao's score (a.k.a Lagrange multiplier) diagnostics for spatial\n    dependence\ndata:  \nmodel: lm(formula = form_pre, data = eng324)\ntest weights: lw\n \n         statistic parameter   p.value    \nRSerr      19.3936         1 1.064e-05 ***\nRSlag      13.4536         1 0.0002445 ***\nadjRSerr    7.8798         1 0.0049990 ** \nadjRSlag    1.9398         1 0.1636931    \nSARMA      21.3333         2 2.331e-05 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n\nHere, for the independent variables initially included in the model to account for the logarithm of real net expenditure on garbage collection in each district, the logarithm of the number of pick-up points (units), the proportion of dwellings among the pick-up points (house), the logarithm of pick-up point density (dens), a categorical variable Metrop with levels: \"district\", \"london\", \"metrop\", and the logarithm of the real regional wage rate for regions. In this case, the tests point to a SEM model rather than an SLM model or falling back to OLS.\nKoley and Bera (2022) propose a similar set of tests to distinguish between either an SLM or an SLX model based on an SDM model, falling back to ordinary least squares if neither alternative is chosen. Because the interpretation of spatially lagged categorical variables is unclear, we drop Metrop from the tests\n\nsummary(SD.RStests(lm_obj_pre, listw=lw, test=\"SDM\",\n Durbin=update(form_pre, ~ . - Metrop)))\n\n    Rao's score test spatial Durbin diagnostics\ndata:  \nmodel: lm(formula = form_pre, data = eng324)\nweights: lw\nDurbin: ~ log(realNetPre) log(units) + house + log(dens) + log(realWgPre)\n \n             statistic parameter   p.value    \nSDM_RSlag      13.4536         1 0.0002445 ***\nSDM_adjRSlag   22.4480         1 2.159e-06 ***\nSDM_RSWX        9.0301         4 0.0603510 .  \nSDM_adjRSWX    18.0246         4 0.0012205 ** \nSDM_Joint      31.4781         5 7.536e-06 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n\nIn this case, an SLX model appears to be indicated rather than SDM, SLM or OLS. However, we also need to look at SDEM as the tests against SAC indicated SEM rather than SLM. Koley (2024) proposes approriate tests:\n\nsummary(SD.RStests(lm_obj_pre, listw=lw, test=\"SDEM\",\n Durbin=update(form_pre, ~ . - Metrop)))\n\n    Rao's score test spatial Durbin diagnostics\ndata:  \nmodel: lm(formula = form_pre, data = eng324)\nweights: lw\nDurbin: ~ log(realNetPre) log(units) + house + log(dens) + log(realWgPre)\n \n           statistic parameter   p.value    \nSDEM_RSerr   19.3936         1 1.064e-05 ***\nSDEM_RSWX     9.0301         4   0.06035 .  \nSDEM_Joint   28.4237         5 3.007e-05 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n\nwhich indicate SEM rather than SDEM. Clearly, the underlying difficulty is that the GNM is poorly identified, and as Koley (2024) finds:\n\n… identification conditions have not been established for the GNS model in the spatial literature that also suffers from an identification problem. In fact, to the best of our knowledge, the non-identification of the GNS model has not yet been analytically studied in the literature (Koley 2024, 3).\n\nHowever, it has been found that the lm.RStests tests can be used on a fitted SLX model using the lmSLX function in spatialreg (Koley 2024, 18), again omitting Metrop from the {\\mathbf W}{\\mathbf X} term in addition to omitting the intercept:\n\nlibrary(spatialreg)\nSLX_obj &lt;- lmSLX(form_pre, data=eng324, listw=lw,\n Durbin=update(form_pre, ~ . - Metrop))\nsummary(lm.RStests(SLX_obj, listw=lw, test=\"all\"))\n\n    Rao's score (a.k.a Lagrange multiplier) diagnostics for spatial\n    dependence\ndata:  \nmodel: lm(log(realNetPre) ~ log.units. + house + log.dens. +\nMetroplondon + Metropmetrop + log.realWgPre. + lag.log.units. +\nlag.house + lag.log.dens. + lag.log.realWgPre., data = eng324, listw =\nlw)\ntest weights: lw\n \n             statistic parameter   p.value    \nGNM_RSerr       16.835         1 4.077e-05 ***\nGNM_RSlag       20.833         1 5.011e-06 ***\nGNM_adjRSerr    12.116         1 0.0004998 ***\nGNM_adjRSlag    16.114         1 5.964e-05 ***\nGNM_SARMA       32.949         2 7.000e-08 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n\nIn Bivand and Szymanski (2000), it was found that the inclusion of the categorical variable Majority, with levels: \"coalition\", \"conservative\" and \"labour\", as anecdotal reports indicated that neighbouring districts with the same political party in control shared more information than otherwise, so the yardstick used would be weighted towards the same political party:\n\nform_pre_maj &lt;- update(form_pre, . ~. + Majority)\nlm_obj_pre_maj &lt;- lm(form_pre_maj, data=eng324)\nsummary(lm.RStests(lm_obj_pre_maj, listw=lw, test=\"all\"))\n\n    Rao's score (a.k.a Lagrange multiplier) diagnostics for spatial\n    dependence\ndata:  \nmodel: lm(formula = form_pre_maj, data = eng324)\ntest weights: lw\n \n         statistic parameter   p.value    \nRSerr       8.1354         1 0.0043410 ** \nRSlag      11.2331         1 0.0008035 ***\nadjRSerr    1.4132         1 0.2345225    \nadjRSlag    4.5109         1 0.0336791 *  \nSARMA      12.6463         2 0.0017943 ** \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n\nThe tests here indicate some support for the inclusion of \\rho_{\\mathrm{Lag}} {\\mathbf W}{\\mathbf y}. On turning to the new tests for SDM compared to SLM or SLX:\n\nsummary(SD.RStests(lm_obj_pre_maj, listw=lw, test=\"SDM\"),\n Durbin=update(form_pre_maj, ~ . - Metrop - Majority))\n\n    Rao's score test spatial Durbin diagnostics\ndata:  \nmodel: lm(formula = form_pre_maj, data = eng324)\nweights: lw\n \n             statistic parameter   p.value    \nSDM_RSlag      11.2331         1 0.0008035 ***\nSDM_adjRSlag    8.1354         1 0.0043410 ** \nSDM_RSWX       38.6726         8 5.653e-06 ***\nSDM_adjRSWX    35.5749         8 2.100e-05 ***\nSDM_Joint      46.8079         9 4.262e-07 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n\nThere is as yet very little experience of interpreting the outcomes, but here an SDM seems to be indicated; we turn to the next set of tests:\n\nsummary(SD.RStests(lm_obj_pre_maj, listw=lw, test=\"SDEM\"),\n Durbin=update(form_pre_maj, ~ . - Metrop - Majority))\n\n    Rao's score test spatial Durbin diagnostics\ndata:  \nmodel: lm(formula = form_pre_maj, data = eng324)\nweights: lw\n \n           statistic parameter   p.value    \nSDEM_RSerr    8.1354         1  0.004341 ** \nSDEM_RSWX    38.6726         8 5.653e-06 ***\nSDEM_Joint   46.8079         9 4.262e-07 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n\nbut the SDEM versus SLX or SEM also looks feasible. Testing the fitted SLX model appears to point to the SDM model rather than the SDEM model:\n\nlibrary(spatialreg)\nSLX_obj_pre_maj &lt;- lmSLX(form_pre_maj, data=eng324, listw=lw,\n Durbin=update(form_pre_maj, ~ . - Metrop - Majority))\nsummary(lm.RStests(SLX_obj_pre_maj, listw=lw, test=\"all\"))\n\n    Rao's score (a.k.a Lagrange multiplier) diagnostics for spatial\n    dependence\ndata:  \nmodel: lm(log(realNetPre) ~ log.units. + house + log.dens. +\nMetroplondon + Metropmetrop + log.realWgPre. + MajorityCONS +\nMajorityLAB + lag.log.units. + lag.house + lag.log.dens. +\nlag.log.realWgPre., data = eng324, listw = lw)\ntest weights: lw\n \n             statistic parameter   p.value    \nGNM_RSerr       3.7201         1  0.053760 .  \nGNM_RSlag      10.6248         1  0.001116 ** \nGNM_adjRSerr   16.3201         1 5.349e-05 ***\nGNM_adjRSlag   23.2247         1 1.441e-06 ***\nGNM_SARMA      26.9449         2 1.409e-06 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n\nOf course, we should repeat these exercises for the post-CCT net expenditures:\n\nform_post &lt;- update(form_pre, log(realNetPst) ~ . - log(realWgPre) + log(realWgPst))\nform_post_maj &lt;- update(form_post, . ~ . + Majority)\n\n\nlm_obj_post &lt;- lm(form_post, data=eng324)\nsummary(lm.RStests(lm_obj_post, listw=lw, test=\"all\"))\n\n    Rao's score (a.k.a Lagrange multiplier) diagnostics for spatial\n    dependence\ndata:  \nmodel: lm(formula = form_post, data = eng324)\ntest weights: lw\n \n         statistic parameter   p.value    \nRSerr     14.50206         1 0.0001400 ***\nRSlag      7.15833         1 0.0074617 ** \nadjRSerr   7.63077         1 0.0057381 ** \nadjRSlag   0.28704         1 0.5921255    \nSARMA     14.78910         2 0.0006146 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n\n\nsummary(SD.RStests(lm_obj_post, listw=lw, test=\"SDM\",\n Durbin=update(form_post, ~ . - Metrop)))\n\n    Rao's score test spatial Durbin diagnostics\ndata:  \nmodel: lm(formula = form_post, data = eng324)\nweights: lw\nDurbin: ~ log(realNetPst) log(units) + house + log(dens) + log(realWgPst)\n \n             statistic parameter   p.value    \nSDM_RSlag       7.1583         1 0.0074617 ** \nSDM_adjRSlag   18.0764         1 2.122e-05 ***\nSDM_RSWX        7.6105         4 0.1069333    \nSDM_adjRSWX    18.5285         4 0.0009725 ***\nSDM_Joint      25.6869         5 0.0001026 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n\n\nsummary(SD.RStests(lm_obj_post, listw=lw, test=\"SDEM\",\n Durbin=update(form_post, ~ . - Metrop)))\n\n    Rao's score test spatial Durbin diagnostics\ndata:  \nmodel: lm(formula = form_post, data = eng324)\nweights: lw\nDurbin: ~ log(realNetPst) log(units) + house + log(dens) + log(realWgPst)\n \n           statistic parameter   p.value    \nSDEM_RSerr   14.5021         1 0.0001400 ***\nSDEM_RSWX     7.6105         4 0.1069333    \nSDEM_Joint   22.1126         5 0.0004984 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n\n\nlibrary(spatialreg)\nSLX_post_obj &lt;- lmSLX(form_post, data=eng324, listw=lw,\n Durbin=update(form_post, ~ . - Metrop))\nsummary(lm.RStests(SLX_post_obj, listw=lw, test=\"all\"))\n\n    Rao's score (a.k.a Lagrange multiplier) diagnostics for spatial\n    dependence\ndata:  \nmodel: lm(log(realNetPst) ~ log.units. + house + log.dens. +\nMetroplondon + Metropmetrop + log.realWgPst. + lag.log.units. +\nlag.house + lag.log.dens. + lag.log.realWgPst., data = eng324, listw =\nlw)\ntest weights: lw\n \n             statistic parameter   p.value    \nGNM_RSerr       14.119         1 0.0001716 ***\nGNM_RSlag       17.930         1 2.292e-05 ***\nGNM_adjRSerr    14.321         1 0.0001541 ***\nGNM_adjRSlag    18.132         1 2.061e-05 ***\nGNM_SARMA       32.251         2 9.926e-08 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n\n\nlm_obj_post_maj &lt;- lm(form_post_maj, data=eng324)\nsummary(lm.RStests(lm_obj_post_maj, listw=lw, test=\"all\"))\n\n    Rao's score (a.k.a Lagrange multiplier) diagnostics for spatial\n    dependence\ndata:  \nmodel: lm(formula = form_post_maj, data = eng324)\ntest weights: lw\n \n         statistic parameter  p.value   \nRSerr       6.8129         1 0.009050 **\nRSlag       7.0744         1 0.007819 **\nadjRSerr    1.7879         1 0.181185   \nadjRSlag    2.0494         1 0.152270   \nSARMA       8.8623         2 0.011901 * \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n\n\nsummary(SD.RStests(lm_obj_post_maj, listw=lw, test=\"SDM\"),\n Durbin=update(form_post_maj, ~ . - Metrop - Majority))\n\n    Rao's score test spatial Durbin diagnostics\ndata:  \nmodel: lm(formula = form_post_maj, data = eng324)\nweights: lw\n \n             statistic parameter   p.value    \nSDM_RSlag       7.0744         1  0.007819 ** \nSDM_adjRSlag    6.8129         1  0.009050 ** \nSDM_RSWX       35.5024         8 2.165e-05 ***\nSDM_adjRSWX    35.2409         8 2.417e-05 ***\nSDM_Joint      42.3153         9 2.878e-06 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n\n\nsummary(SD.RStests(lm_obj_post_maj, listw=lw, test=\"SDEM\"),\n Durbin=update(form_post_maj, ~ . - Metrop - Majority))\n\n    Rao's score test spatial Durbin diagnostics\ndata:  \nmodel: lm(formula = form_post_maj, data = eng324)\nweights: lw\n \n           statistic parameter   p.value    \nSDEM_RSerr    6.8129         1   0.00905 ** \nSDEM_RSWX    35.5024         8 2.165e-05 ***\nSDEM_Joint   42.3153         9 2.878e-06 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n\n\nlibrary(spatialreg)\nSLX_obj_post_maj &lt;- lmSLX(form_post_maj, data=eng324, listw=lw,\n Durbin=update(form_post_maj, ~ . - Metrop - Majority))\nsummary(lm.RStests(SLX_obj_post_maj, listw=lw, test=\"all\"))\n\n    Rao's score (a.k.a Lagrange multiplier) diagnostics for spatial\n    dependence\ndata:  \nmodel: lm(log(realNetPst) ~ log.units. + house + log.dens. +\nMetroplondon + Metropmetrop + log.realWgPst. + MajorityCONS +\nMajorityLAB + lag.log.units. + lag.house + lag.log.dens. +\nlag.log.realWgPst., data = eng324, listw = lw)\ntest weights: lw\n \n             statistic parameter   p.value    \nGNM_RSerr       4.7900         1 0.0286252 *  \nGNM_RSlag       9.7710         1 0.0017728 ** \nGNM_adjRSerr    6.6243         1 0.0100599 *  \nGNM_adjRSlag   11.6053         1 0.0006576 ***\nGNM_SARMA      16.3953         2 0.0002753 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n\n\n\n\n\nAnselin, Luc. 1988. Spatial Econometrics: Methods and Models. Dordrecht: Kluwer Academic Publishers.\n\n\nAnselin, Luc, Anil K. Bera, R. Florax, and M. J. Yoon. 1996. “Simple Diagnostic Tests for Spatial Dependence.” Regional Science and Urban Economics 26: 77–104. https://doi.org/10.1016/0166-0462(95)02111-6.\n\n\nBivand, Roger. 1984. “Regression Modeling with Spatial Dependence: An Application of Some Class Selection and Estimation Methods.” Geographical Analysis 16: 25–37.\n\n\n———. 2012. “After ‘Raising the Bar’: Applied Maximum Likelihood Estimation of Families of Models in Spatial Econometrics.” Estadística Española 54: 71–88.\n\n\nBivand, Roger, W. Müller, and M. Reder. 2009. “Power Calculations for Global and Local Moran’s I.” Computational Statistics and Data Analysis 53: 2859–72.\n\n\nBivand, Roger, and Stefan Szymanski. 2000. “Modelling the Spatial Impact of the Introduction of Compulsory Competitive Tendering.” Regional Science and Urban Economics 30: 203–19.\n\n\nBivand, Roger, and David W. S. Wong. 2018. “Comparing Implementations of Global and Local Indicators of Spatial Association.” TEST 27 (3): 716–48. https://doi.org/10.1007/s11749-018-0599-x.\n\n\nBurridge, P. 1981. “Testing for a Common Factor in a Spatial Autoregression Model.” Environment and Planning A 13: 795–800.\n\n\nCliff, Andrew D., and J. Keith Ord. 1981. Spatial Processes. London: Pion.\n\n\nElhorst, J. Paul. 2010. “Applied Spatial Econometrics: Raising the Bar.” Spatial Economic Analysis 5: 9–28.\n\n\nFingleton, B. 1999. “Spurious spatial regression: Some Monte Carlo results with a spatial unit root and spatial cointegration.” Journal of Regional Science 39: 1–19.\n\n\nHalleck Vega, Solmaria, and J. Paul Elhorst. 2015. “The SLX Model.” Journal of Regional Science 55 (3): 339–63. https://doi.org/10.1111/jors.12188.\n\n\nKelejian, Harry, and Gianfranco Piras. 2017. Spatial Econometrics. London: Academic Press.\n\n\nKoley, Malabika. 2024. “Specification Testing Under General Nesting Spatial Model.” https://drive.google.com/file/d/1jDAQEmczE7vlPPX1jKaYajD1VtmL4Zvh/view.\n\n\nKoley, Malabika, and Anil K. Bera. 2022. “Testing for Spatial Dependence in a Spatial Autoregressive (SAR) Model in the Presence of Endogenous Regressors.” Journal of Spatial Econometrics 3 (11): 1–46. https://doi.org/10.1007/s43071-022-00026-7.\n\n\nLeSage, James. 2014. “What Regional Scientists Need to Know about Spatial Econometrics.” The Review of Regional Studies 44 (1). http://journal.srsa.org/ojs/index.php/RRS/article/view/44.1.2.\n\n\nLeSage, James P., and R. Kelley Pace. 2009. Introduction to Spatial Econometrics. Boca Raton FL: Chapman; Hall/CRC.\n\n\nMcMillen, Daniel P. 2003. “Spatial Autocorrelation or Model Misspecification?” International Regional Science Review 26: 208–17.\n\n\nMur, Jesús, and Ana Angulo. 2006. “The Spatial Durbin Model and the Common Factor Tests.” Spatial Economic Analysis 1 (2): 207–26. https://doi.org/10.1080/17421770601009841.\n\n\nPace, R. Kelley, and James P. LeSage. 2008. “A Spatial Hausman Test.” Economics Letters 101: 282–84. https://doi.org/10.1016/j.econlet.2008.09.003.\n\n\nSchabenberger, O., and C. A. Gotway. 2005. Statistical Methods for Spatial Data Analysis. Boca Raton/London: Chapman & Hall/CRC.\n\n\nSmith, Tony E. 2009. “Estimation Bias in Spatial Models with Strongly Connected Weight Matrices.” Geographical Analysis 41 (3): 307–32. https://doi.org/10.1111/j.1538-4632.2009.00758.x.\n\n\nSmith, Tony E., and K. L. Lee. 2012. “The effects of spatial autoregressive dependencies on inference in ordinary least squares: a geometric approach.” Journal of Geographical Systems 14 (January): 91–124. https://doi.org/10.1007/s10109-011-0152-x.\n\n\nTiefelsdorf, Michael. 2002. “The Saddlepoint Approximation of Moran’s I and Local Moran’s {I}_i Reference Distributions and Their Numerical Evaluation.” Geographical Analysis 34: 187–206.",
    "crumbs": [
      "<span class='chapter-number'>7</span>  <span class='chapter-title'>Tests of spatial autocorrelation, model specification</span>"
    ]
  },
  {
    "objectID": "08_talk.html",
    "href": "08_talk.html",
    "title": "8  Spatial autoregressive models: conditional (CAR) and simultaneous (SAR)",
    "section": "",
    "text": "8.1 CAR and SAR\n(from: Pebesma and Bivand (2023), pp. 233-234)\nThere is a large literature in disease mapping using conditional autoregressive (CAR) and intrinsic CAR (ICAR) models in spatially structured random effects. These extend to multilevel models, in which the spatially structured random effects may apply at different levels of the model (Bivand et al. 2017). In order to try out some of the variants, we need to remove the no-neighbour observations from the tract level, and from the model output zone aggregated level, in two steps as reducing the tract level induces a no-neighbour outcome at the model output zone level. Many of the model estimating functions take family arguments, and fit generalised linear mixed effects models with per-observation spatial random effects structured using a Markov random field representation of relationships between neighbours. In the multilevel case, the random effects may be modelled at the group level, which is the case presented in the following examples.\nWe follow Gómez-Rubio (2019) in summarising Pinheiro and Bates (2000) and McCulloch and Searle (2001) to describe the mixed-effects model representation of spatial regression models. In a Gaussian linear mixed model setting, a random effect u is added to the model, with response Y, fixed covariates X, their coefficients \\beta and error term \\varepsilon_i \\sim N(0, \\sigma^2), i=1,\\dots, n:\nY = X \\beta + Z u + \\varepsilon\nZ is a fixed design matrix for the random effects. If there are n random effects, it will be an n \\times n identity matrix if instead the observations are aggregated into m groups, so with m &lt; n random effects, it will be an n \\times m matrix showing which group each observation belongs to. The random effects are modelled as a multivariate Normal distribution u \\sim N(0, \\sigma^2_u \\Sigma), and \\sigma^2_u \\Sigma is the square variance-covariance matrix of the random effects.\nA division has grown up, possibly unhelpfully, between scientific fields using CAR models (Besag 1974), and simultaneous autoregressive models (SAR) (Ord 1975; Hepple 1976). Although CAR and SAR models are closely related, these fields have found it difficult to share experience of applying similar models, often despite referring to key work summarising the models (Ripley 1981, 1988; Cressie 1993). Ripley gives the SAR variance as (Ripley 1981, 89), here shown as the inverse \\Sigma^{-1} (also known as the precision matrix):\n\\Sigma^{-1} = [(I - \\rho W)^\\top(I - \\rho W)]\nwhere \\rho is a spatial autocorrelation parameter and W is a non-singular spatial weights matrix that represents spatial dependence. The CAR variance is:\n\\Sigma^{-1} = (I - \\rho W)\nwhere W is a symmetric and strictly positive definite spatial weights matrix. In the case of the intrinsic CAR model, avoiding the estimation of a spatial autocorrelation parameter, we have:\n\\Sigma^{-1} = M = \\mathrm{diag}(n_i) - W\nwhere W is a symmetric and strictly positive definite spatial weights matrix as before and n_i are the row sums of W. The Besag-York-Mollié model includes intrinsic CAR spatially structured random effects and unstructured random effects. The Leroux model combines matrix components for unstructured and spatially structured random effects, where the spatially structured random effects are taken as following an intrinsic CAR specification:\n\\Sigma^{-1} = [(1 - \\rho) I_n + \\rho M]\nReferences to the definitions of these models may be found in Gómez-Rubio (2020), and estimation issues affecting the Besag-York-Mollié and Leroux models are reviewed by Gerber and Furrer (2015).\nMore recent books expounding the theoretical bases for modelling with areal data simply point out the similarities between SAR and CAR models in relevant chapters (Gaetan and Guyon 2010; Lieshout 2019); the interested reader is invited to consult these sources for background information.",
    "crumbs": [
      "<span class='chapter-number'>8</span>  <span class='chapter-title'>Spatial autoregressive models: conditional (CAR) and simultaneous (SAR)</span>"
    ]
  },
  {
    "objectID": "08_talk.html#some-car-examples-with-english-garbage-data",
    "href": "08_talk.html#some-car-examples-with-english-garbage-data",
    "title": "8  Spatial autoregressive models: conditional (CAR) and simultaneous (SAR)",
    "section": "8.2 Some CAR examples with English garbage data",
    "text": "8.2 Some CAR examples with English garbage data\nIn spatial econometrics, CAR is not used, nor are binary spatial weights; they both are, however, extensively used in spatial epidemiology (disease mapping). The CAR model accounts for spatial autocorrelation in the residuals of a linear model by modelling that residual dependency in various ways. spatialreg provides spautolm using Maximum Likelihood (ML) including a \"CAR\" family member, but does not have a direct method for extracting the spatially structured random effect (SSRE) from the fitted model:\n\nlibrary(spdep)\nlwB &lt;- nb2listw(unb, style=\"B\")\nlibrary(spatialreg)\ncar1 &lt;- spautolm(form_pre, data=eng324, listw=lwB, family=\"CAR\")\nsummary(car1, Nagelkerke=TRUE)\n\n\nCall: spautolm(formula = form_pre, data = eng324, listw = lwB, family = \"CAR\")\n\nResiduals:\n       Min         1Q     Median         3Q        Max \n-1.2458705 -0.1271315 -0.0082244  0.1395717  0.9975448 \n\nCoefficients: \n                 Estimate Std. Error z value  Pr(&gt;|z|)\n(Intercept)    -5.2940330  1.4601452 -3.6257 0.0002882\nlog(units)      0.9890709  0.0374943 26.3793 &lt; 2.2e-16\nhouse          -1.7376836  0.3188845 -5.4493 5.058e-08\nlog(dens)       0.0032286  0.0129677  0.2490 0.8033847\nMetroplondon    0.1181653  0.0765654  1.5433 0.1227517\nMetropmetrop    0.0032977  0.0648167  0.0509 0.9594235\nlog(realWgPre)  0.5710435  0.2692001  2.1213 0.0338999\n\nLambda: 0.12806 LR test value: 20.119 p-value: 7.2757e-06 \nNumerical Hessian standard error of lambda: 0.01965 \n\nLog likelihood: 10.54415 \nML residual variance (sigma squared): 0.051948, (sigma: 0.22792)\nNumber of observations: 324 \nNumber of parameters estimated: 9 \nAIC: -3.0883\nNagelkerke pseudo-R-squared: 0.84639 \n\n\nCressie (1993) gives the spatial component of the fit as \\rho_{\\mathrm{Err}} {\\mathbf W} ({\\mathbf y} - {\\mathbf X}{\\mathbf \\beta}) (p. 564, eq. 7.6.31):\n\neng324$ranef_ml &lt;- car1$fit$signal_stochastic\n\nHierarchical GLM hglm (Alam, Rönnegård, and Shen 2015) can be used for fitting a proper CAR model as a rand.family argument passing in the binary spatial weights coerced into a symmetric sparse matrix:\n\nlibrary(hglm)\nW &lt;- as(lwB, \"CsparseMatrix\")\ncar2 &lt;- hglm(fixed=form_pre, random= ~ 1|ID, data=eng324, family = gaussian(), rand.family=CAR(D=W))\ncar2\n\nCall: \nhglm.formula(family = gaussian(), rand.family = CAR(D = W), fixed = form_pre, \n    random = ~1 | ID, data = eng324)\n\n---------------------------\nEstimates of the mean model\n---------------------------\n\nFixed effects:\n   (Intercept)     log(units)          house      log(dens)   Metroplondon \n  -5.256205728    0.982604641   -1.740287615    0.006107953    0.109398222 \n  Metropmetrop log(realWgPre) \n   0.015926892    0.572707449 \n\nRandom effects:\n[1]  0.07512008 -0.01960200  0.14569011\n...\n[1] 0.11309920 0.05048601\nNOTE: to show all the random effects estimates, use print(hglm.object, print.ranef = TRUE).\n\nDispersion parameter for the mean model: 0.03210403 \n\nDispersion parameter for the random effects: 3.83044e+21 \n\nEstimation did not converge in 3 iterations\n\n!! Observation 65 is too influential! Estimates are likely unreliable !!\n\n\nThe fitting algorithm does not converge, so no estimate of the spatial autoregressive parameter is returned; a warning is given that one observation is highly unusual:\n\nas.character(eng324$NAME[65])\n\n[1] \"CITY OF LONDON\"\n\n\nAs almost nobody lives there, the proportion of houses in pick-up points is only 0.21, far below the median of 0.93; other variables are less extreme. No provision is made for dropping the outlier, so we will keep it; the SSRE is provided:\n\neng324$ranef_hglm &lt;- c(unname(car2$ranef))\n\nFinally, an intrinsic CAR (here termed Markov Random Field, MRF) can be fitted with mgcv using gam with an \"mrf\" smooth, and a spatial neighbour object with names set on the object components to match the variable defining the random effects:\n\nlibrary(mgcv)\n\nLoading required package: nlme\n\n\nThis is mgcv 1.9-1. For overview type 'help(\"mgcv-package\")'.\n\nnames(unb) &lt;- attr(unb, \"region.id\")\neng324$NAME &lt;- factor(eng324$NAME)\ncar3 &lt;- gam(update(form_pre, . ~ . + s(NAME, bs=\"mrf\", xt=list(nb=unb))), data=eng324)\nsummary(car3)\n\n\nFamily: gaussian \nLink function: identity \n\nFormula:\nlog(realNetPre) ~ log(units) + house + log(dens) + Metrop + log(realWgPre) + \n    s(NAME, bs = \"mrf\", xt = list(nb = unb))\n\nParametric coefficients:\n                Estimate Std. Error t value Pr(&gt;|t|)    \n(Intercept)    -4.579478   1.778786  -2.574   0.0108 *  \nlog(units)      1.029406   0.037874  27.180  &lt; 2e-16 ***\nhouse          -1.916974   0.325147  -5.896 1.71e-08 ***\nlog(dens)      -0.005621   0.012749  -0.441   0.6598    \nMetroplondon   -0.018417   0.089088  -0.207   0.8365    \nMetropmetrop   -0.121942   0.068941  -1.769   0.0786 .  \nlog(realWgPre)  0.403762   0.327662   1.232   0.2194    \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nApproximate significance of smooth terms:\n        edf Ref.df     F p-value    \ns(NAME) 130    319 1.057  &lt;2e-16 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nR-sq.(adj) =  0.918   Deviance explained = 95.2%\nGCV = 0.051034  Scale est. = 0.029448  n = 324\n\n\nSSRE are not returned directly, but can be extracted from predictions for the data used to fit the model, taking only the smooth term:\n\neng324$ranef_mrf &lt;- unname(predict(car3, type=\"terms\")[, \"s(NAME)\"])\n\nWe can tabulate the fixed effects coefficients, and see that these fitting approaches yield similar but not identical values:\n\ncbind(ML=coef(car1), HGLM=c(car2$fixef, NA), MRF=c(coef(car3)[1:7], NA))\n\n                         ML         HGLM          MRF\n(Intercept)    -5.294032977 -5.256205728 -4.579477921\nlog(units)      0.989070893  0.982604641  1.029405939\nhouse          -1.737683649 -1.740287615 -1.916973856\nlog(dens)       0.003228567  0.006107953 -0.005621393\nMetroplondon    0.118165294  0.109398222 -0.018416579\nMetropmetrop    0.003297685  0.015926892 -0.121942154\nlog(realWgPre)  0.571043491  0.572707449  0.403761668\nlambda          0.128061085           NA           NA\n\n\nWe can also look at correlations between the three approximations to SSRE:\n\ncor(st_drop_geometry(eng324)[, c(\"ranef_ml\", \"ranef_hglm\", \"ranef_mrf\")])\n\n            ranef_ml ranef_hglm ranef_mrf\nranef_ml   1.0000000  0.6203440 0.6620203\nranef_hglm 0.6203440  1.0000000 0.9297771\nranef_mrf  0.6620203  0.9297771 1.0000000\n\n\nIt is characteristic of work in disease mapping that the SSRE are mapped, and the maps are interpreted to learn whether the data collection could have been improved. It is not usual that work in spatial econometrics includes maps, and this difference has been noted critically by spatial statisticians. Here are comparative maps of the three output sets of SSRE:\n\nlibrary(tmap)\n\nBreaking News: tmap 3.x is retiring. Please test v4, e.g. with\nremotes::install_github('r-tmap/tmap')\n\ntm_shape(eng324) + tm_fill(c(\"ranef_ml\", \"ranef_hglm\", \"ranef_mrf\"), title=\"random effect\", n=9, midpoint=0, style=\"fisher\") + tm_borders() + tm_facets(free.scales=FALSE) + tm_layout(panel.labels=c(\"ML\", \"HGLM\", \"MRF\"))\n\n\n\n\nMaps of spatially structured random effects, conditional autoregressive models",
    "crumbs": [
      "<span class='chapter-number'>8</span>  <span class='chapter-title'>Spatial autoregressive models: conditional (CAR) and simultaneous (SAR)</span>"
    ]
  },
  {
    "objectID": "08_talk.html#simultaneous-autoregressive-models",
    "href": "08_talk.html#simultaneous-autoregressive-models",
    "title": "8  Spatial autoregressive models: conditional (CAR) and simultaneous (SAR)",
    "section": "8.3 Simultaneous autoregressive models",
    "text": "8.3 Simultaneous autoregressive models\nThere are many varieties of model fitting methods for CAR models, fewer for SAR. We can begin by using spautolm using Maximum Likelihood (ML) again, choosing SAR rather than CAR, but initially retaining the binary spatial weights:\n\nsar1B &lt;- spautolm(form_pre, data=eng324, listw=lwB, family=\"SAR\")\nsummary(sar1B, Nagelkerke=TRUE)\n\n\nCall: spautolm(formula = form_pre, data = eng324, listw = lwB, family = \"SAR\")\n\nResiduals:\n       Min         1Q     Median         3Q        Max \n-1.1973371 -0.1330977  0.0042846  0.1472354  1.0226467 \n\nCoefficients: \n                 Estimate Std. Error z value  Pr(&gt;|z|)\n(Intercept)    -5.2182355  1.4520462 -3.5937  0.000326\nlog(units)      0.9881039  0.0375060 26.3452 &lt; 2.2e-16\nhouse          -1.7196249  0.3196133 -5.3803 7.435e-08\nlog(dens)       0.0029204  0.0129370  0.2257  0.821401\nMetroplondon    0.1254203  0.0767156  1.6349  0.102076\nMetropmetrop    0.0093832  0.0648807  0.1446  0.885009\nlog(realWgPre)  0.5562152  0.2681111  2.0746  0.038026\n\nLambda: 0.073558 LR test value: 19.892 p-value: 8.1948e-06 \nNumerical Hessian standard error of lambda: 0.015158 \n\nLog likelihood: 10.4304 \nML residual variance (sigma squared): 0.053275, (sigma: 0.23081)\nNumber of observations: 324 \nNumber of parameters estimated: 9 \nAIC: -2.8608\nNagelkerke pseudo-R-squared: 0.84628 \n\n\nAs row-standardised weights are much more common in spatial econometrics, let us switch (back) to them. First we see that the domain of the spatial coefficient depends on the spatial weights, and is the inverse of the range of the eigenvalues of the spatial weights matrix; this applies irrespective of the estimation method:\n\n1/range(eigenw(lwB))\n\n[1] -0.3129207  0.1666602\n\nlw &lt;- nb2listw(unb, style=\"W\")\ne &lt;- eigenw(lw)\n1/range(e)\n\n[1] -1.224561  1.000000\n\n\nThe value of the single spatial parameter is found by line search (univariate optimisation). In spautolm, the objective function includes the use of numerical inversion of the {\\mathbf X}^\\top{\\mathbf A}{\\mathbf X} matrix, where in the CAR case, {\\mathbf A} = {\\mathbf I} - \\rho{\\mathbf W}, but in the SAR case, it is {\\mathbf A} = ({\\mathbf I} - \\rho{\\mathbf W})^\\top({\\mathbf I} - \\rho{\\mathbf W}), using plug-in functions. Using spautolm, we get:\n\nsar1 &lt;- spautolm(form_pre, data=eng324, listw=lw, family=\"SAR\", control=list(pre_eig=e))\nsummary(sar1, Nagelkerke=TRUE)\n\n\nCall: spautolm(formula = form_pre, data = eng324, listw = lw, family = \"SAR\", \n    control = list(pre_eig = e))\n\nResiduals:\n       Min         1Q     Median         3Q        Max \n-1.2099474 -0.1382060 -0.0061752  0.1467393  1.0037329 \n\nCoefficients: \n                  Estimate  Std. Error z value  Pr(&gt;|z|)\n(Intercept)    -4.99283719  1.49150170 -3.3475 0.0008154\nlog(units)      0.99637181  0.03760832 26.4934 &lt; 2.2e-16\nhouse          -1.73716260  0.31817206 -5.4598 4.766e-08\nlog(dens)       0.00052967  0.01256022  0.0422 0.9663626\nMetroplondon    0.10864174  0.07912775  1.3730 0.1697549\nMetropmetrop   -0.00633204  0.06608941 -0.0958 0.9236713\nlog(realWgPre)  0.50480257  0.27573061  1.8308 0.0671331\n\nLambda: 0.35401 LR test value: 19.988 p-value: 7.7912e-06 \nNumerical Hessian standard error of lambda: 0.072223 \n\nLog likelihood: 10.47868 \nML residual variance (sigma squared): 0.05332, (sigma: 0.23091)\nNumber of observations: 324 \nNumber of parameters estimated: 9 \nAIC: -2.9574\nNagelkerke pseudo-R-squared: 0.84632 \n\n\nspautolm outputs the standard error of the spatial coefficient based on the numerical Hessian to estimate the information matrix of the model. errorsarlm was written before spautolm, and yields very similar values, using for moderate n as in this case asymptotic standard errors:\n\nSEM_pre &lt;- errorsarlm(form_pre, data=eng324, listw=lw, control=list(pre_eig=e))\nsummary(SEM_pre, Nagelkerke=TRUE)\n\n\nCall:\nerrorsarlm(formula = form_pre, data = eng324, listw = lw, control = list(pre_eig = e))\n\nResiduals:\n       Min         1Q     Median         3Q        Max \n-1.2099474 -0.1382060 -0.0061752  0.1467393  1.0037330 \n\nType: error \nCoefficients: (asymptotic standard errors) \n                  Estimate  Std. Error z value  Pr(&gt;|z|)\n(Intercept)    -4.99283675  1.49150136 -3.3475 0.0008154\nlog(units)      0.99637177  0.03760832 26.4934 &lt; 2.2e-16\nhouse          -1.73716251  0.31817207 -5.4598 4.766e-08\nlog(dens)       0.00052969  0.01256022  0.0422 0.9663618\nMetroplondon    0.10864178  0.07912773  1.3730 0.1697547\nMetropmetrop   -0.00633193  0.06608941 -0.0958 0.9236726\nlog(realWgPre)  0.50480253  0.27573055  1.8308 0.0671331\n\nLambda: 0.35401, LR test value: 19.988, p-value: 7.7912e-06\nAsymptotic standard error: 0.069512\n    z-value: 5.0928, p-value: 3.5288e-07\nWald statistic: 25.936, p-value: 3.5288e-07\n\nLog likelihood: 10.47868 for error model\nML residual variance (sigma squared): 0.05332, (sigma: 0.23091)\nNagelkerke pseudo-R-squared: 0.84632 \nNumber of observations: 324 \nNumber of parameters estimated: 9 \nAIC: -2.9574, (AIC for lm: 15.031)\n\n\nIt avoids some loss of numerical precision in calculation of the objective function, so the coefficients are equal after moderate rounding:\n\nall.equal(coef(SEM_pre)[c(2:8, 1)], coef(sar1), tol=2e-07)\n\n[1] TRUE\n\n\nIn addition, output from errorsarlm offers the Hausman test (Pace and LeSage 2008); the SEM and OLS regression coefficients should be close to each other and significant divergence indicates model mis-specification; it seems difficult here to accept the null hypothesis of no difference:\n\nHausman.test(SEM_pre)\n\n\n    Spatial Hausman test (asymptotic)\n\ndata:  NULL\nHausman test = 21.049, df = 7, p-value = 0.003699",
    "crumbs": [
      "<span class='chapter-number'>8</span>  <span class='chapter-title'>Spatial autoregressive models: conditional (CAR) and simultaneous (SAR)</span>"
    ]
  },
  {
    "objectID": "08_talk.html#spatial-econometrics-models-pre-cct-examples",
    "href": "08_talk.html#spatial-econometrics-models-pre-cct-examples",
    "title": "8  Spatial autoregressive models: conditional (CAR) and simultaneous (SAR)",
    "section": "8.4 Spatial econometrics models: pre-CCT examples",
    "text": "8.4 Spatial econometrics models: pre-CCT examples\nWe have already fitted the SEM model using ML to the basic pre-CCT formula, partly based on our initial results, indicating that SEM was to be preferred to SLM, but without considering the inclusion of {\\mathbf W}{\\mathbf X}.\nUse of Rao’s score tests only involve the fitting of least squares models, both OLS and SLX, but it is also possible to work back from the most complex model GNM, recalling its identification issues (using ML):\n\nGNM_pre &lt;- sacsarlm(form_pre, data=eng324, listw=lw, Durbin=update(form_pre, ~ . - Metrop), control=list(pre_eig1=e, pre_eig2=e))\nSAC_pre &lt;- sacsarlm(form_pre, data=eng324, listw=lw, control=list(pre_eig1=e, pre_eig2=e))\n\nHowever, since GNM includes \\rho_{\\mathrm{Lag}} {\\mathbf W}{\\mathbf y}, presenting the conventional table of coefficient estimates is not appropriate, so we’ll stay with likelihood ratio tests, which depend on the models being compared being nested, and returning log-likelihood values:\n\n\\mathrm{LR} = -2 (\\ell(\\theta_0) - \\ell(\\theta_1))\n\nwhere \\ell(\\theta_0) is the log-likelihood of the nested model, and \\ell(\\theta_1) of the encompassing model, and where the number of degrees of freedom for \\chi^2 is the difference in the estimated parameter counts.\n\nlibrary(lmtest)\n\nLoading required package: zoo\n\n\n\nAttaching package: 'zoo'\n\n\nThe following objects are masked from 'package:base':\n\n    as.Date, as.Date.numeric\n\nlrtest(GNM_pre, SAC_pre)\n\nLikelihood ratio test\n\nModel 1: log(realNetPre) ~ log(units) + house + log(dens) + Metrop + log(realWgPre)\nModel 2: log(realNetPre) ~ log(units) + house + log(dens) + Metrop + log(realWgPre)\n  #Df LogLik Df  Chisq Pr(&gt;Chisq)  \n1  14 17.361                       \n2  10 10.887 -4 12.947    0.01154 *\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n\nThis test indicates that including {\\mathbf W}{\\mathbf X} to the SAC model to give an GNM model only yields a minor improvement in fit. Moving on, we fit the remaining models:\n\nSDEM_pre &lt;- errorsarlm(form_pre, data=eng324, listw=lw, Durbin=update(form_pre, ~ . - Metrop), control=list(pre_eig=e))\n\n\nHausman.test(SDEM_pre)\n\n\n    Spatial Hausman test (asymptotic)\n\ndata:  NULL\nHausman test = 19.012, df = 11, p-value = 0.06087\n\n\nThe Hausman test is now borderline, so the coefficients of the SDEM may be taken as close to those of the SLX model. Moving on:\n\nSDM_pre &lt;- lagsarlm(form_pre, data=eng324, listw=lw, Durbin=update(form_pre, ~ . - Metrop), control=list(pre_eig=e))\n\n\nc(LM_test=signif(SDM_pre$LMtest), p.value=format.pval((1 - pchisq(SDM_pre$LMtest, 1))))\n\n    LM_test     p.value \n  \"8.61387\" \"0.0033361\" \n\n\nThe Rao’s score (Lagrange Multiplier) test (Anselin 1988) for residual spatial autocorrelation in the SDM model shows that the model is mis-specified.\n\nSLM_pre &lt;- lagsarlm(form_pre, data=eng324, listw=lw, control=list(pre_eig=e))\n\n\nc(LM_test=signif(SLM_pre$LMtest), p.value=format.pval((1 - pchisq(SLM_pre$LMtest, 1))))\n\n   LM_test    p.value \n  \"6.3742\" \"0.011579\" \n\n\nThe LM test for residual spatial autocorrelation in the SLM model indicates that something in the {\\mathbf W}{\\mathbf X} is adding spatial autocorrelation to the residuals.\n\nSLX_pre &lt;- lmSLX(form_pre, data=eng324, listw=lw, Durbin=update(form_pre, ~ . - Metrop))\n\n\nOLS_pre &lt;- lm(form_pre, data=eng324)\n\nwe now have eight fitted pre-CCT models, and can calculate the likelihood ratio tests between nested models. GNM nests all models, SAC nests SEM, SLM and OLS, SDEM nests SEM, SLX and OLS, SDM nests SLM, SLX and OLS (and SEM through the Common Factor \\rho_{\\mathrm{Err}} = - \\rho_{\\mathrm{Lag}}{\\mathbf \\beta}), and SEM, SLX and SLM nest OLS:\n\nmlist_pre &lt;- list(GNM=GNM_pre, SAC=SAC_pre, SDEM=SDEM_pre, SDM=SDM_pre, SLX=SLX_pre, SEM=SEM_pre, SLM=SLM_pre, OLS=OLS_pre)\nm &lt;- length(mlist_pre)\nLR_pre &lt;- matrix(NA, ncol=m, nrow=m)\ncolnames(LR_pre) &lt;- rownames(LR_pre) &lt;- names(mlist_pre)\nfor (j in 2:m) LR_pre[1, j] &lt;- lrtest(mlist_pre[[1]],\n    mlist_pre[[j]])[[2, \"Pr(&gt;Chisq)\"]]\nfor (j in 6:8) LR_pre[2, j] &lt;- lrtest(mlist_pre[[2]],\n    mlist_pre[[j]])[[2, \"Pr(&gt;Chisq)\"]]\nfor (j in c(5, 6, 8)) LR_pre[3, j] &lt;- lrtest(mlist_pre[[3]],\n    mlist_pre[[j]])[[2, \"Pr(&gt;Chisq)\"]]\nfor (j in c(5:8)) LR_pre[4, j] &lt;- lrtest(mlist_pre[[4]],\n    mlist_pre[[j]])[[2, \"Pr(&gt;Chisq)\"]]\nfor (i in 5:7) LR_pre[i, 8] &lt;- lrtest(mlist_pre[[i]],\n    mlist_pre[[8]])[[2, \"Pr(&gt;Chisq)\"]]\n\n\nlibrary(plot.matrix)\nlibrary(viridis)\n\nLoading required package: viridisLite\n\nopar &lt;- par(mar=c(3.1, 3.1, 3.1, 7.1), cex.axis=0.8)\nplot(LR_pre, breaks=c(0, 10^-(8:0)), col=viridis, las=1)\n\n\n\n\nHeat map of likelihood ratio p-values, pre_CCT models\n\n\n\npar(opar)\n\nThe figure shows that the only comparisons indicating minor improvement in fit by making the model more complex are from SEM to SDEM or SAC; it is not clear that adding the {\\mathbf W}{\\mathbf X} helps. In addition, the likelihood ratio does not penalise for the increased number of fitted paramters, unlike AIC and BIC, which penalise in increasing degree. The Akaike information criterion (AIC) is, where k is the parameter count:\n\n\\mathrm{AIC} = 2 k - 2 \\ell(\\theta)\n\n\nsort(sapply(mlist_pre, AIC))\n\n      GNM       SEM       SDM       SAC      SDEM       SLM       SLX       OLS \n-6.722113 -2.957365 -2.742996 -1.774990 -1.102252  3.887504 13.872713 15.031060 \n\n\nThe BIC scores put all of the models including {\\mathbf W}{\\mathbf X} behind those without, pointing to SEM, followed by SAC and SLM. The Bayesian information criterion (BIC) is, for n, the observation count:\n\n\\mathrm{BIC} = k \\ln(n) - 2 \\ell(\\theta)\n\n\nsort(sapply(mlist_pre, BIC))\n\n     SEM      SAC      SLM      OLS      GNM      SDM     SDEM      SLX \n31.06933 36.03245 37.91420 45.27701 46.20830 46.40667 48.04741 59.24163",
    "crumbs": [
      "<span class='chapter-number'>8</span>  <span class='chapter-title'>Spatial autoregressive models: conditional (CAR) and simultaneous (SAR)</span>"
    ]
  },
  {
    "objectID": "08_talk.html#spatial-econometrics-models-pre-cct-examples-including-political-control",
    "href": "08_talk.html#spatial-econometrics-models-pre-cct-examples-including-political-control",
    "title": "8  Spatial autoregressive models: conditional (CAR) and simultaneous (SAR)",
    "section": "8.5 Spatial econometrics models: pre-CCT examples including political control",
    "text": "8.5 Spatial econometrics models: pre-CCT examples including political control\n\nSEM_pre_maj &lt;- errorsarlm(form_pre_maj, data=eng324, listw=lw, control=list(pre_eig=e))\n\n\nHausman.test(SEM_pre_maj)\n\n\n    Spatial Hausman test (asymptotic)\n\ndata:  NULL\nHausman test = 24.487, df = 9, p-value = 0.003594\n\n\n\nGNM_pre_maj &lt;- sacsarlm(form_pre_maj, data=eng324, listw=lw, Durbin=update(form_pre_maj, ~ . - Metrop - Majority), control=list(pre_eig1=e, pre_eig2=e))\nSAC_pre_maj &lt;- sacsarlm(form_pre_maj, data=eng324, listw=lw, control=list(pre_eig1=e, pre_eig2=e))\n\n\nSDEM_pre_maj &lt;- errorsarlm(form_pre_maj, data=eng324, listw=lw, Durbin=update(form_pre_maj, ~ . - Metrop - Majority), control=list(pre_eig=e))\n\n\nHausman.test(SDEM_pre_maj)\n\n\n    Spatial Hausman test (asymptotic)\n\ndata:  NULL\nHausman test = 21.775, df = 13, p-value = 0.05894\n\n\n\nSDM_pre_maj &lt;- lagsarlm(form_pre_maj, data=eng324, listw=lw, Durbin=update(form_pre_maj, ~ . - Metrop - Majority), control=list(pre_eig=e))\n\n\nc(LM_test=signif(SDM_pre_maj$LMtest), p.value=format.pval((1 - pchisq(SDM_pre_maj$LMtest, 1))))\n\n     LM_test      p.value \n   \"15.7135\" \"7.3694e-05\" \n\n\n\nSLM_pre_maj &lt;- lagsarlm(form_pre_maj, data=eng324, listw=lw, control=list(pre_eig=e))\n\n\nc(LM_test=signif(SLM_pre_maj$LMtest), p.value=format.pval((1 - pchisq(SLM_pre_maj$LMtest, 1))))\n\n  LM_test   p.value \n\"1.03321\" \"0.30941\" \n\n\n\nSLX_pre_maj &lt;- lmSLX(form_pre_maj, data=eng324, listw=lw, Durbin=update(form_pre_maj, ~ . - Metrop - Majority))\n\n\nOLS_pre_maj &lt;- lm(form_pre_maj, data=eng324)\n\n\nmlist_pre_maj &lt;- list(GNM=GNM_pre_maj, SAC=SAC_pre_maj, SDEM=SDEM_pre_maj, SDM=SDM_pre_maj, SLX=SLX_pre_maj, SEM=SEM_pre_maj, SLM=SLM_pre_maj, OLS=OLS_pre_maj)\nm &lt;- length(mlist_pre_maj)\nLR_pre_maj &lt;- matrix(NA, ncol=m, nrow=m)\ncolnames(LR_pre_maj) &lt;- rownames(LR_pre_maj) &lt;- names(mlist_pre_maj)\nfor (j in 2:m) LR_pre_maj[1, j] &lt;- lrtest(mlist_pre_maj[[1]],\n    mlist_pre_maj[[j]])[[2, \"Pr(&gt;Chisq)\"]]\nfor (j in 6:8) LR_pre_maj[2, j] &lt;- lrtest(mlist_pre_maj[[2]],\n    mlist_pre_maj[[j]])[[2, \"Pr(&gt;Chisq)\"]]\nfor (j in c(5, 6, 8)) LR_pre_maj[3, j] &lt;- lrtest(mlist_pre_maj[[3]],\n    mlist_pre_maj[[j]])[[2, \"Pr(&gt;Chisq)\"]]\nfor (j in c(5:8)) LR_pre_maj[4, j] &lt;- lrtest(mlist_pre_maj[[4]],\n    mlist_pre_maj[[j]])[[2, \"Pr(&gt;Chisq)\"]]\nfor (i in 5:7) LR_pre_maj[i, 8] &lt;- lrtest(mlist_pre_maj[[i]],\n    mlist_pre_maj[[8]])[[2, \"Pr(&gt;Chisq)\"]]\n\n\nopar &lt;- par(mar=c(3.1, 3.1, 3.1, 7.1), cex.axis=0.8)\nplot(LR_pre_maj, breaks=c(0, 10^-(8:0)), col=viridis, las=1)\n\n\n\n\nHeat map of likelihood ratio p-values, pre_CCT models including politiacl control\n\n\n\npar(opar)\n\n\nsort(sapply(mlist_pre_maj, AIC))\n\n      GNM       SDM      SDEM       SLX       SLM       SAC       SEM       OLS \n-38.29440 -29.30102 -23.60534 -21.31938 -20.13818 -19.52201 -18.43801 -11.04604 \n\n\n\nsort(sapply(mlist_pre_maj, BIC))\n\n     SLM      GNM      SEM      SAC      OLS      SDM      SLX     SDEM \n21.45000 22.19749 23.15016 25.84692 26.76140 27.41013 31.61103 33.10581",
    "crumbs": [
      "<span class='chapter-number'>8</span>  <span class='chapter-title'>Spatial autoregressive models: conditional (CAR) and simultaneous (SAR)</span>"
    ]
  },
  {
    "objectID": "08_talk.html#spatial-econometrics-models-post-cct-examples-including-political-control",
    "href": "08_talk.html#spatial-econometrics-models-post-cct-examples-including-political-control",
    "title": "8  Spatial autoregressive models: conditional (CAR) and simultaneous (SAR)",
    "section": "8.6 Spatial econometrics models: post-CCT examples including political control",
    "text": "8.6 Spatial econometrics models: post-CCT examples including political control\n\nSEM_post_maj &lt;- errorsarlm(form_post_maj, data=eng324, listw=lw, control=list(pre_eig=e))\n\n\nHausman.test(SEM_post_maj)\n\n\n    Spatial Hausman test (asymptotic)\n\ndata:  NULL\nHausman test = 21.981, df = 9, p-value = 0.008938\n\n\n\nGNM_post_maj &lt;- sacsarlm(form_post_maj, data=eng324, listw=lw, Durbin=update(form_post_maj, ~ . - Metrop - Majority), control=list(pre_eig1=e, pre_eig2=e))\nSAC_post_maj &lt;- sacsarlm(form_post_maj, data=eng324, listw=lw, control=list(pre_eig1=e, pre_eig2=e))\n\n\nSDEM_post_maj &lt;- errorsarlm(form_post_maj, data=eng324, listw=lw, Durbin=update(form_post_maj, ~ . - Metrop - Majority), control=list(pre_eig=e))\n\n\nHausman.test(SDEM_post_maj)\n\n\n    Spatial Hausman test (asymptotic)\n\ndata:  NULL\nHausman test = 15.783, df = 13, p-value = 0.261\n\n\n\nSDM_post_maj &lt;- lagsarlm(form_post_maj, data=eng324, listw=lw, Durbin=update(form_post_maj, ~ . - Metrop - Majority), control=list(pre_eig=e))\n\n\nc(LM_test=signif(SDM_post_maj$LMtest), p.value=format.pval((1 - pchisq(SDM_post_maj$LMtest, 1))))\n\n   LM_test    p.value \n \"5.46586\" \"0.019391\" \n\n\n\nSLM_post_maj &lt;- lagsarlm(form_post_maj, data=eng324, listw=lw, control=list(pre_eig=e))\n\n\nc(LM_test=signif(SLM_post_maj$LMtest), p.value=format.pval((1 - pchisq(SLM_post_maj$LMtest, 1))))\n\n  LM_test   p.value \n\"1.89042\" \"0.16916\" \n\n\n\nSLX_post_maj &lt;- lmSLX(form_post_maj, data=eng324, listw=lw, Durbin=update(form_post_maj, ~ . - Metrop - Majority))\n\n\nOLS_post_maj &lt;- lm(form_post_maj, data=eng324)\n\n\nmlist_post_maj &lt;- list(GNM=GNM_post_maj, SAC=SAC_post_maj, SDEM=SDEM_post_maj, SDM=SDM_post_maj, SLX=SLX_post_maj, SEM=SEM_post_maj, SLM=SLM_post_maj, OLS=OLS_post_maj)\nm &lt;- length(mlist_post_maj)\nLR_post_maj &lt;- matrix(NA, ncol=m, nrow=m)\ncolnames(LR_post_maj) &lt;- rownames(LR_post_maj) &lt;- names(mlist_post_maj)\nfor (j in 2:m) LR_post_maj[1, j] &lt;- lrtest(mlist_post_maj[[1]],\n    mlist_post_maj[[j]])[[2, \"Pr(&gt;Chisq)\"]]\nfor (j in 6:8) LR_post_maj[2, j] &lt;- lrtest(mlist_post_maj[[2]],\n    mlist_post_maj[[j]])[[2, \"Pr(&gt;Chisq)\"]]\nfor (j in c(5, 6, 8)) LR_post_maj[3, j] &lt;- lrtest(mlist_post_maj[[3]],\n    mlist_post_maj[[j]])[[2, \"Pr(&gt;Chisq)\"]]\nfor (j in c(5:8)) LR_post_maj[4, j] &lt;- lrtest(mlist_post_maj[[4]],\n    mlist_post_maj[[j]])[[2, \"Pr(&gt;Chisq)\"]]\nfor (i in 5:7) LR_post_maj[i, 8] &lt;- lrtest(mlist_post_maj[[i]],\n    mlist_post_maj[[8]])[[2, \"Pr(&gt;Chisq)\"]]\n\n\nopar &lt;- par(mar=c(3.1, 3.1, 3.1, 7.1), cex.axis=0.8)\nplot(LR_post_maj, breaks=c(0, 10^-(8:0)), col=viridis, las=1)\n\n\n\n\nHeat map of likelihood ratio p-values, post_CCT models including political control\n\n\n\npar(opar)\n\n\nsort(sapply(mlist_post_maj, AIC))\n\n      GNM       SDM      SDEM       SLX       SEM       SAC       SLM       OLS \n-65.97796 -63.54597 -59.60015 -56.38760 -54.05232 -53.87685 -53.76302 -48.47510 \n\n\n\nsort(sapply(mlist_post_maj, BIC))\n\n       SEM        SLM        OLS        SAC        SDM        GNM        SLX \n-12.464138 -12.174841 -10.667662  -8.507931  -6.834818  -5.486068  -3.457190 \n      SDEM \n -2.889000 \n\n\nSo we might reasonably choose to proceed with SLM including political control, but will have to wait to present coefficient estimates, or rather the marginal effects, because SLM includes \\rho_{\\mathrm{Lag}} {\\mathbf W}{\\mathbf y}.\n\n\n\n\nAlam, Moudud, Lars Rönnegård, and Xia Shen. 2015. “Fitting Conditional and Simultaneous Autoregressive Spatial Models in Hglm.” The R Journal 7 (2): 5–18. https://doi.org/10.32614/RJ-2015-017.\n\n\nAnselin, Luc. 1988. “Lagrange Multiplier Test Diagnostics for Spatial Dependence and Spatial Heterogeneity.” Geographical Analysis 20 (1): 1–17. https://doi.org/10.1111/j.1538-4632.1988.tb00159.x.\n\n\nBesag, Julian. 1974. “Spatial Interaction and the Statistical Analysis of Lattice Systems.” Journal of the Royal Statistical Society. Series B (Methodological) 36: pp. 192–236.\n\n\nBivand, Roger, Zhe Sha, Liv Osland, and Ingrid Sandvig Thorsen. 2017. “A Comparison of Estimation Methods for Multilevel Models of Spatially Structured Data.” Spatial Statistics. https://doi.org/10.1016/j.spasta.2017.01.002.\n\n\nCressie, Noel A. C. 1993. Statistics for Spatial Data. New York: John Wiley & Sons.\n\n\nGaetan, Carlo, and Xavier Guyon. 2010. Spatial Statistics and Modeling. New York: Springer.\n\n\nGerber, Florian, and Reinhard Furrer. 2015. “Pitfalls in the Implementation of Bayesian Hierarchical Modeling of Areal Count Data: An Illustration Using BYM and Leroux Models.” Journal of Statistical Software, Code Snippets 63 (1): 1–32. https://doi.org/10.18637/jss.v063.c01.\n\n\nGómez-Rubio, Virgilio. 2019. “Spatial Data Analysis with INLA. Coding Club UC3M Tutorial Series. Universidad Carlos III de Madrid.” https://codingclubuc3m.rbind.io/talk/2019-11-05/.\n\n\n———. 2020. Bayesian Inference with INLA. Boca Raton, FL: CRC Press.\n\n\nHepple, Leslie W. 1976. “A Maximum Likelihood Model for Econometric Estimation with Spatial Series.” In Theory and Practice in Regional Science, edited by I. Masser, 90–104. London Papers in Regional Science. London: Pion.\n\n\nLieshout, M. N. M. van. 2019. Theory of Spatial Statistics. Boca Raton, FL: Chapman & Hall/CRC.\n\n\nMcCulloch, Charles E., and Shayle R. Searle. 2001. Generalized, Linear, and Mixed Models. New York: Wiley.\n\n\nOrd, J. Keith. 1975. “Estimation Methods for Models of Spatial Interaction.” Journal of the American Statistical Association 70: 120–26.\n\n\nPace, R. Kelley, and James P. LeSage. 2008. “A Spatial Hausman Test.” Economics Letters 101: 282–84. https://doi.org/10.1016/j.econlet.2008.09.003.\n\n\nPebesma, Edzer, and Roger Bivand. 2023. Spatial Data Science with Applications in R. Boca Raton, FL: CRC Press.\n\n\nPinheiro, Jose C., and Douglas M. Bates. 2000. Mixed-Effects Models in S and S-Plus. New York: Springer.\n\n\nRipley, Brian D. 1981. Spatial Statistics. New York: John Wiley & Sons.\n\n\n———. 1988. Statistical Inference for Spatial Processes. Cambridge: Cambridge University Press.",
    "crumbs": [
      "<span class='chapter-number'>8</span>  <span class='chapter-title'>Spatial autoregressive models: conditional (CAR) and simultaneous (SAR)</span>"
    ]
  },
  {
    "objectID": "09_talk.html",
    "href": "09_talk.html",
    "title": "9  Estimation of spatial autoregressive models: methods (ML, Bayesian, GMM)",
    "section": "",
    "text": "9.1 Maximum likelihood estimation\n(from Bivand, Millo, and Piras (2021))\nThe log-likelihood function for the spatial error model (SEM) is:\n\\ell(\\beta, \\rho_{\\mathrm{Err}}, \\sigma^2) = - \\frac{N}{2} \\ln 2 \\pi - \\frac{N}{2} \\ln \\sigma^2 + \\ln |{\\mathbf I} - \\rho_{\\mathrm{Err}} {\\mathbf W}| - \\frac{1}{2 \\sigma^2} \\big[({\\mathbf y} - {\\mathbf X}\\beta)^\\top ({\\mathbf I} - \\rho_{\\mathrm{Err}} {\\mathbf W})^\\top({\\mathbf I} - \\rho_{\\mathrm{Err}} {\\mathbf W}) ({\\mathbf y} - {\\mathbf X}\\beta)\\big].\n\\beta may be concentrated out of the sum of squared errors term, for example as:\n\\ell(\\rho_{\\mathrm{Err}}, \\sigma^2) = - \\frac{N}{2} \\ln 2 \\pi - \\frac{N}{2} \\ln \\sigma^2 + \\ln |{\\mathbf I} - \\rho_{\\mathrm{Err}} {\\mathbf W}| - \\frac{1}{2 \\sigma^2} \\big[{\\mathbf y}^\\top({\\mathbf I} - \\rho_{\\mathrm{Err}} {\\mathbf W})^\\top ({\\mathbf I} - {\\mathbf Q}_{\\rho_{\\mathrm{Err}}}{\\mathbf Q}_{\\rho_{\\mathrm{Err}}}^\\top) ({\\mathbf I} - \\rho_{\\mathrm{Err}} {\\mathbf W}){\\mathbf y}\\big]\nwhere {\\mathbf Q}_{\\rho_{\\mathrm{Err}}} is obtained by decomposing ({\\mathbf X} - \\rho_{\\mathrm{Err}} {\\mathbf W}{\\mathbf X}) = {\\mathbf Q}_{\\rho_{\\mathrm{Err}}}{\\mathbf R}_{\\rho_{\\mathrm{Err}}}.\nThe first published versions of the eigenvalue method for finding the Jacobian (Ord 1975, 121) is:\n\\ln(|{\\mathbf I} - \\lambda {\\mathbf W}|) = \\sum_{i=1}^{N} \\ln(1 - \\lambda\\zeta_i)\nwhere \\zeta_i are the eigenvalues of {\\mathbf W}.\nOne specific problem addressed by Ord (1975, 125) is that of the eigenvalues of the asymmetric row-standardised matrix {\\mathbf W} with underlying symmetric neighbour relations c_{ij} = c_{ji}. If we write {\\mathbf w} = {\\mathbf C}{\\mathbf 1}, where {\\mathbf 1} is a vector of ones, we can get: {\\mathbf W} = {\\mathbf C}{\\mathbf D}, where {\\mathbf D} = {\\mathrm {diag}}(1/{\\mathbf w}); by similarity, the eigenvalues of {\\mathbf W} are equal to those of: {\\mathbf D}^{\\frac{1}{2}}{\\mathbf C}{\\mathbf D}^\\frac{1}{2}. From the very beginning in spdep, sparse Cholesky alternatives were available for cases in which finding the eigenvalues of a large weights matrix would be impracticable, see (Bivand, Hauke, and Kossowski 2013) for further details.\nSEM_pre_maj &lt;- errorsarlm(form_pre_maj, data=eng324, listw=lw, control=list(pre_eig=e), quiet=FALSE)\n\n\nSpatial autoregressive error model\n\nJacobian calculated using neighbourhood matrix eigenvalues\n\nlambda: -0.3748541  function: -4.941735  Jacobian: -4.52514  SSE: 19.01899 \nlambda: 0.1502935  function: 19.30871  Jacobian: -0.788878  SSE: 16.75685 \nlambda: 0.4748525  function: 16.56229  Jacobian: -8.876868  SSE: 16.21334 \nlambda: 0.246777  function: 20.19845  Jacobian: -2.188131  SSE: 16.52175 \nlambda: 0.2580037  function: 20.21679  Jacobian: -2.400493  SSE: 16.49824 \nlambda: 0.2639805  function: 20.21899  Jacobian: -2.517964  SSE: 16.48606 \nlambda: 0.2634933  function: 20.21901  Jacobian: -2.508273  SSE: 16.48704 \nlambda: 0.2634766  function: 20.21901  Jacobian: -2.507941  SSE: 16.48707 \nlambda: 0.2634769  function: 20.21901  Jacobian: -2.507947  SSE: 16.48707 \nlambda: 0.2613861  function: 20.21868  Jacobian: -2.466594  SSE: 16.49131 \nlambda: 0.2626781  function: 20.21896  Jacobian: -2.492103  SSE: 16.48869 \nlambda: 0.2631716  function: 20.219  Jacobian: -2.501885  SSE: 16.48769 \nlambda: 0.2633601  function: 20.21901  Jacobian: -2.505626  SSE: 16.48731 \nlambda: 0.2634321  function: 20.21901  Jacobian: -2.507056  SSE: 16.48716 \nlambda: 0.2634596  function: 20.21901  Jacobian: -2.507603  SSE: 16.48711 \nlambda: 0.2634701  function: 20.21901  Jacobian: -2.507812  SSE: 16.48709 \nlambda: 0.2634743  function: 20.21901  Jacobian: -2.507896  SSE: 16.48708 \nlambda: 0.2634758  function: 20.21901  Jacobian: -2.507924  SSE: 16.48708 \nlambda: 0.2634762  function: 20.21901  Jacobian: -2.507934  SSE: 16.48707 \nlambda: 0.2634766  function: 20.21901  Jacobian: -2.50794  SSE: 16.48707 \nlambda: 0.2634767  function: 20.21901  Jacobian: -2.507943  SSE: 16.48707 \nlambda: 0.2634766  function: 20.21901  Jacobian: -2.507941  SSE: 16.48707 \nlambda: 0.2634766  function: 20.21901  Jacobian: -2.507941  SSE: 16.48707 \nlambda: 0.2634766  function: 20.21901  Jacobian: -2.507941  SSE: 16.48707\nThe values used in calculating the likelihood function can be tracked as line search moves towards the optimum, where for many of the final iterations, the value of the spatial coefficient, here reported as lambda, moves little.\nThe log-likelihood function for the spatial lag model is:\n\\ell(\\beta, \\rho_{\\mathrm{Lag}}, \\sigma^2) = - \\frac{N}{2} \\ln 2 \\pi - \\frac{N}{2} \\ln \\sigma^2 + \\ln |{\\mathbf I} - \\rho_{\\mathrm{Lag}} {\\mathbf W}| - \\frac{1}{2 \\sigma^2} \\big[(({\\mathbf I} - \\rho_{\\mathrm{Lag}} {\\mathbf W}){\\mathbf y} - {\\mathbf X}\\beta)^\\top(({\\mathbf I} - \\rho_{\\mathrm{Lag}} {\\mathbf W}){\\mathbf y} - {\\mathbf X}\\beta)\\big]\nand by extension the same framework is used for the spatial Durbin model when [{\\mathbf X} ({\\mathbf W}{\\mathbf X})] are grouped together. The sum-of-squared errors (SSE) term in the square brackets is found using auxilliary regressions {\\mathbf e} = {\\mathbf y}-({\\mathbf X}^\\top{\\mathbf X}){\\mathbf X}{\\mathbf y} and {\\mathbf u} = {\\mathbf W}{\\mathbf y}-({\\mathbf X}^\\top{\\mathbf X}){\\mathbf X}{\\mathbf W}{\\mathbf y}, and SSE = {\\mathbf e}^\\top{\\mathbf e} - 2 \\rho_{\\mathrm{Lag}} {\\mathbf u}^\\top{\\mathbf e} + \\rho_{\\mathrm{Lag}}^2 {\\mathbf u}^\\top{\\mathbf u}. The cross-products of {\\mathbf u} and {\\mathbf e} can conveniently be calculated before line search begins; Bivand (2012) gives more details.\nModels with two parameters require that \\rho_{\\mathrm{Lag}} and \\rho_{\\mathrm{Err}} be found by constrained numerical optimization in two dimensions by searching for the maximum on the surface of the log likelihood function, which is like that of the spatial error model with additional terms in {\\mathbf I} - \\rho_{\\mathrm{Lag}} {\\mathbf W}:\n\\ell(\\rho_{\\mathrm{Lag}}, \\rho_{\\mathrm{Err}}, \\sigma^2) = - \\frac{N}{2} \\ln 2 \\pi - \\frac{N}{2} \\ln \\sigma^2 + \\ln |{\\mathbf I} - \\rho_{\\mathrm{Lag}} {\\mathbf W}| + \\ln |{\\mathbf I} - \\rho_{\\mathrm{Err}} {\\mathbf W}| - \\frac{1}{2 \\sigma^2} \\big[{\\mathbf y}^\\top({\\mathbf I} - \\rho_{\\mathrm{Lag}} {\\mathbf W})^\\top({\\mathbf I} - \\rho_{\\mathrm{Err}} {\\mathbf W})^\\top({\\mathbf I} - {\\mathbf Q}_{\\rho_{\\mathrm{Err}}}{\\mathbf Q}_{\\rho_{\\mathrm{Err}}}^\\top) ({\\mathbf I} - \\rho_{\\mathrm{Err}} {\\mathbf W})({\\mathbf I} - \\rho_{\\mathrm{Lag}} {\\mathbf W}){\\mathbf y}\\big]\nwhere {\\mathbf Q}_{\\rho_{\\mathrm{Err}}} is obtained by decomposing ({\\mathbf X} - \\rho_{\\mathrm{Err}} {\\mathbf W}{\\mathbf X}) = {\\mathbf Q}_{\\rho_{\\mathrm{Err}}} {\\mathbf R}_{\\rho_{\\mathrm{Err}}}.\nThe nlminb optimiser is currently used by default, but as the figure shows, it jumps around quite a lot on the flat ridge of the surface of the log-likelihood, here displayed after additional calculation over a 40 by 40 grid. Note that this work has been computed on a x86_64/amd64 processor, which uses 80-bit extended precision. We are already seeing cases of arm64 processors with 64-bit precision affecting optimisation outcomes, (Apple Silicon, expected elsewhere). Much AI/GPU technology uses reduced precision, unfortunately.\nSAC_pre_maj &lt;- sacsarlm(form_pre_maj, data=eng324, listw=lw, control=list(pre_eig1=e, pre_eig2=e), llprof=40)\nSAC_track &lt;- capture.output(sac &lt;- sacsarlm(form_pre_maj, data=eng324, listw=lw, control=list(pre_eig1=e, pre_eig2=e), quiet=FALSE))\nc(SAC_pre_maj$rho, SAC_pre_maj$lambda)\n\n      rho    lambda \n0.1073891 0.1344878 \n\nc(SAC_pre_maj$rho/SAC_pre_maj$rho.se, SAC_pre_maj$lambda/SAC_pre_maj$lambda.se)\n\n     rho   lambda \n1.950402 1.398422\nThe estimated spatial parameters, and their z-values show that the null hypothesis of no difference from zero may well be acceptable for both, with \\rho_{\\mathrm{Lag}} more likely to be in play than \\rho_{\\mathrm{Err}}; this matches the observation that the LM test for residual spatial autocorrelation from the SLM model did not reject the null hypothesis of no residual spatial autocorrelation. Here \\rho_{\\mathrm{Err}} and \\rho_{\\mathrm{Lag}} are competing for any remaining spatial signal in the data.\nm &lt;- -matrix(SAC_pre_maj$llprof$ll, 40, 40)\ncon &lt;- textConnection(SAC_track)\nsac_track &lt;- read.table(con, skip=14)\nclose(con)\ncontour(SAC_pre_maj$llprof$xseq, SAC_pre_maj$llprof$yseq, m, levels=quantile(c(m), seq(0,1,0.1)), xlab=\"rho\", ylab=\"lambda\", col=\"blue4\")\nabline(h=SAC_pre_maj$rho, v=SAC_pre_maj$lambda, lwd=3, col=\"grey\")\nlines(sac_track$V2, sac_track$V4, col=\"brown3\")\n\n\n\n\nSAC pre-CCT with political control model log likelihood surface and optimiser path to optimum",
    "crumbs": [
      "<span class='chapter-number'>9</span>  <span class='chapter-title'>Estimation of spatial autoregressive models: methods (ML, Bayesian, GMM)</span>"
    ]
  },
  {
    "objectID": "09_talk.html#bayesian-estimation",
    "href": "09_talk.html#bayesian-estimation",
    "title": "9  Estimation of spatial autoregressive models: methods (ML, Bayesian, GMM)",
    "section": "9.2 Bayesian estimation",
    "text": "9.2 Bayesian estimation\nThere is no time now to go into depth about Bayesian estimation, for now it is sufficient to know that instead of fitting models using maximum likelihood by optimising the log-likelihood function, the likelihood function and the underlying distributional assumptions are sampled from in this case in a Markov chain Monte Carlo framework.\n\nset.seed(12345)\nSAC_bayes &lt;- spBreg_sac(form_pre_maj, data=eng324, listw=lw, control=list(ndraw=20000L, nomit=2000L))\n\nHere we are fitting a SAC model with 20,000 samples drawn, and report the outcomes for \\rho_{\\mathrm{Lag}}, \\rho_{\\mathrm{Err}} and \\sigma^2 (for ML, \\sigma^2 was 0.05087):\n\nsummary(SAC_bayes[, c(\"rho\", \"lambda\", \"sige\")])\n\n\nIterations = 2001:20000\nThinning interval = 1 \nNumber of chains = 1 \nSample size per chain = 18000 \n\n1. Empirical mean and standard deviation for each variable,\n   plus standard error of the mean:\n\n          Mean       SD  Naive SE Time-series SE\nrho    0.10688 0.060203 4.487e-04      1.467e-03\nlambda 0.13112 0.112294 8.370e-04      2.736e-03\nsige   0.05207 0.004194 3.126e-05      3.349e-05\n\n2. Quantiles for each variable:\n\n           2.5%     25%     50%     75%   97.5%\nrho    -0.01319 0.06692 0.10843 0.14796 0.22263\nlambda -0.09325 0.05657 0.13373 0.20688 0.34262\nsige    0.04434 0.04918 0.05181 0.05472 0.06087\n\n\nThe MCMC estimation methods in spatialreg report in mcmc objects defined in coda, and tests for convergence provided in that package can also be used. The figure shows that sampling for the spatial coefficients is somewhat uneven, which is perhaps unsurprising since they carry little information:\n\nopar &lt;- par(mfrow=c(2, 1)) \nplot(SAC_bayes[, c(\"rho\", \"lambda\", \"sige\")], smooth=TRUE)\n\n\n\n\nSampling traces and density plots for spatial coefficients and \\sigma^2, SAC model with political control, MCMC, 20,000 draws\n\n\n\npar(opar)",
    "crumbs": [
      "<span class='chapter-number'>9</span>  <span class='chapter-title'>Estimation of spatial autoregressive models: methods (ML, Bayesian, GMM)</span>"
    ]
  },
  {
    "objectID": "09_talk.html#generalised-method-of-moments-estimation",
    "href": "09_talk.html#generalised-method-of-moments-estimation",
    "title": "9  Estimation of spatial autoregressive models: methods (ML, Bayesian, GMM)",
    "section": "9.3 Generalised method of moments estimation",
    "text": "9.3 Generalised method of moments estimation\nThere are implementations of some GMM estimation methods in spatialreg, but those in sphet are actively maintained and better adapted to recent research results (Piras 2010). The workhorse spreg model fitting function can be used with several different models, including \"sarar\" also known as SAC:\n\nlibrary(sphet)\n\n\nAttaching package: 'sphet'\n\n\nThe following object is masked from 'package:spatialreg':\n\n    impacts\n\nSAC_gmm &lt;- spreg(form_pre_maj, data=eng324, listw=lw, model=\"sarar\")\nc(coef(SAC_gmm)[c(\"lambda\", \"rho\"),], s2=as.numeric(SAC_gmm$s2))\n\n    lambda        rho         s2 \n0.18324659 0.05111413 0.05259217 \n\n\nNote that here lambda is \\rho_{\\mathrm{Lag}}, and rho is \\rho_{\\mathrm{Err}}, reversing the meaning of the terms elsewhere. Once again the nlminb optimiser is used, as in a number of steps \\rho_{\\mathrm{Lag}} is estimated by spatial two-stage least squares using {\\mathbf W}{\\mathbf X} and {\\mathbf W}{\\mathbf W}{\\mathbf X} as instruments, and then optimising \\rho_{\\mathrm{Err}} and \\sigma^2 in the method of moments steps. GMM does not use the log determinant of the Jacobian term in the model specification, and this was one of the reasons for the development of such methods.\nMore details on GMM estimation may be found in Bivand, Millo, and Piras (2021) and articles cited therein, and Kelejian and Piras (2017).\n\n\n\n\nBivand, Roger. 2012. “After ‘Raising the Bar’: Applied Maximum Likelihood Estimation of Families of Models in Spatial Econometrics.” Estadística Española 54: 71–88.\n\n\nBivand, Roger, Jan Hauke, and Tomasz Kossowski. 2013. “Computing the Jacobian in Gaussian Spatial Autoregressive Models: An Illustrated Comparison of Available Methods.” Geographical Analysis 45: 150–79.\n\n\nBivand, Roger, Giovanni Millo, and Gianfranco Piras. 2021. “A Review of Software for Spatial Econometrics in R.” Mathematics 9 (11). https://doi.org/10.3390/math9111276.\n\n\nBivand, Roger, and Gianfranco Piras. 2015. “Comparing Implementations of Estimation Methods for Spatial Econometrics.” Journal of Statistical Software 63 (1): 1–36. https://doi.org/10.18637/jss.v063.i18.\n\n\nKelejian, Harry, and Gianfranco Piras. 2017. Spatial Econometrics. London: Academic Press.\n\n\nOrd, J. Keith. 1975. “Estimation Methods for Models of Spatial Interaction.” Journal of the American Statistical Association 70: 120–26.\n\n\nPiras, Gianfranco. 2010. “Sphet: Spatial Models with Heteroskedastic Innovations in R.” Journal of Statistical Software 35: 1–21.",
    "crumbs": [
      "<span class='chapter-number'>9</span>  <span class='chapter-title'>Estimation of spatial autoregressive models: methods (ML, Bayesian, GMM)</span>"
    ]
  },
  {
    "objectID": "10_talk.html",
    "href": "10_talk.html",
    "title": "10  No orthogonality between regression and autoregression coefficients",
    "section": "",
    "text": "10.1 Marginal effects in spatial econometrics\nRecall that we aim to consider:\nIt has emerged over time, however, that the spatial dependence in the parameter \\rho_{\\mathrm{Lag}} feeds back. This feedback comes from the fact that the reduced form model is {\\mathbf y} = ({\\mathbf I} - \\rho_{\\mathrm{Lag}} {\\mathbf W})^{-1}{\\mathbf X}{\\mathbf \\beta} + ({\\mathbf I} - \\rho_{\\mathrm{Lag}} {\\mathbf W})^{-1}{\\mathbf \\varepsilon}. is the n \\times n identity matrix, and ({\\mathbf I} - \\rho_{\\mathrm{Lag}} {\\mathbf W})^{-1} is known to be dense. Expressed in terms of changes in x impacting y, the feedback runs through the global spillover ({\\mathbf I} - \\rho_{\\mathrm{Lag}} {\\mathbf W})^{-1}. These difficulties are discussed as emanating effects (Kelejian, Tavlas, and Hondroyiannis 2006), also known as impacts (LeSage and Fischer 2008; LeSage and Pace 2009; Golgher and Voss 2016), simultaneous spatial reaction function/reduced form (Anselin and Lozano-Gracia 2008) and equilibrium effects (Ward and Gleditsch 2008).\nThis feedback comes from the fact that, while the elements of the Hessian matrix for the ML spatial error model linking \\rho_{\\mathrm{Err}} and \\beta are zero (\\partial^2 \\ell / (\\partial \\beta \\partial \\rho_{\\mathrm{Err}}) = {\\mathbf 0}), in the spatial lag model (and by extension in the spatial Durbin model): \\partial^2 \\ell / (\\partial \\beta \\partial \\rho_{\\mathrm{Lag}}) \\neq {\\mathbf 0}. In the spatial error model, for exogenous variable r, \\partial y_i / \\partial x_{ir} = \\beta_r and \\partial y_i / \\partial x_{jr} = 0 for i \\neq j. In the spatial lag model, \\partial y_i / \\partial x_{jr} = (({\\mathbf I} - \\rho_{\\mathrm{Lag}} {\\mathbf W})^{-1} {\\mathbf I} \\beta_r)_{ij}, where {\\mathbf I} is the n \\times n identity matrix. The awkward S_r({\\mathbf W}) = (({\\mathbf I} - \\rho_{\\mathrm{Lag}} {\\mathbf W})^{-1} {\\mathbf I} \\beta_r) matrix term needed to calculate impact measures for the lag model, and S_r({\\mathbf W}) = (({\\mathbf I} - \\rho_{\\mathrm{Lag}} {\\mathbf W})^{-1} ({\\mathbf I} \\beta_r - {\\mathbf W} \\gamma_r)) for the spatial Durbin model, may be approximated using traces of powers of the spatial weights matrix as well as analytically.\nThe average direct impacts are represented by the sum of the diagonal elements of the matrix divided by n for each exogenous variable. The average total impacts are the sum of all matrix elements divided by n for each exogenous variable. The average indirect impacts are the differences between the direct and total impact vectors.\nThe development in LeSage and Pace (2009, pp. 114–115) for the SLM model and q traces is as follows:\n{\\mathbf T} = [1, 0, n^{-1}tr({\\mathbf W}^2), n^{-1}tr({\\mathbf W}^3), \\ldots, n^{-1}tr({\\mathbf W}^q)]\n{\\mathbf g} = [1, \\rho, \\rho^2, \\rho^3, \\ldots, \\rho^q]; {\\mathbf G}_{ii} = g_i, i = 1, \\ldots, q+1\n{\\mathbf P} = [\\beta_1, \\beta_2, \\ldots, \\beta_p]^T\nwhere the intercept \\beta_0 is dropped, and with {\\mathbf a} a p-vector of ones:\n{\\mathrm {Direct}} = {\\mathbf P} {\\mathbf T} {\\mathbf G} {\\mathbf a}\n{\\mathrm {Total}} = {\\mathbf \\beta} {\\mathbf g} {\\mathbf a}",
    "crumbs": [
      "<span class='chapter-number'>10</span>  <span class='chapter-title'>No orthogonality between regression and autoregression coefficients</span>"
    ]
  },
  {
    "objectID": "10_talk.html#marginal-effects-in-spatial-econometrics",
    "href": "10_talk.html#marginal-effects-in-spatial-econometrics",
    "title": "10  No orthogonality between regression and autoregression coefficients",
    "section": "",
    "text": "if we change x, what do we expect to happen to y.",
    "crumbs": [
      "<span class='chapter-number'>10</span>  <span class='chapter-title'>No orthogonality between regression and autoregression coefficients</span>"
    ]
  },
  {
    "objectID": "10_talk.html#trace-style-impacts",
    "href": "10_talk.html#trace-style-impacts",
    "title": "10  No orthogonality between regression and autoregression coefficients",
    "section": "10.2 Trace-style impacts",
    "text": "10.2 Trace-style impacts\ntrW in spatialreg can be used to generate {\\mathbf T} above:\n\nlibrary(spdep)\nlw &lt;- nb2listw(unb, style=\"W\")\nlibrary(spatialreg)\ne &lt;- eigenw(lw)\nW &lt;- as(lw, \"CsparseMatrix\")\ntrMat &lt;- trW(W, type=\"mult\")\n\n\nSLM_pre_maj &lt;- lagsarlm(form_pre_maj, data=eng324, listw=lw, control=list(pre_eig=e))\n\nThe samples are drawn from the fitted model using the coefficients, spatial lag coefficient \\rho_{\\mathrm{Lag}} and possibly other components as the mean values, and the variance-covariance matrix of coefficients, applying mvrnorm from MASS once for R draws, yielding inputs for the trace method, which is applied to each draw to give R sample direct, indirect and total impacts:\n\nset.seed(12345)\nR &lt;- 2000\n(imp_SLM_pre_maj_tr &lt;- impacts(SLM_pre_maj, tr=trMat, R=R))\n\nImpact measures (lag, trace):\n                    Direct     Indirect       Total\nlog(units)      0.97021645  0.166102763  1.13631922\nhouse          -1.75150349 -0.299860477 -2.05136397\nlog(dens)      -0.02019100 -0.003456735 -0.02364774\nMetroplondon    0.07432424  0.012724440  0.08704868\nMetropmetrop   -0.05080358 -0.008697662 -0.05950124\nlog(realWgPre)  0.34764203  0.059516927  0.40715896\nMajorityCONS    0.03796509  0.006499690  0.04446478\nMajorityLAB     0.19524091  0.033425587  0.22866650\n\n\nRepeating for post-CCT, we have R pre-CCT samples of \\rho_{\\mathrm{Lag}}, and R post-CCT samples, plus the same counts of sample impacts for the variables distinguished in Bivand and Szymanski (2000) as of importance both pre-CCT and post-CCT.\n\nSLM_post_maj &lt;- lagsarlm(form_post_maj, data=eng324, listw=lw, control=list(pre_eig=e))\n\n\nset.seed(12345)\n(imp_SLM_post_maj_tr &lt;- impacts(SLM_post_maj, tr=trMat, R=R))\n\nImpact measures (lag, trace):\n                    Direct     Indirect       Total\nlog(units)      0.93758286  0.133550323  1.07113319\nhouse          -1.37901113 -0.196427845 -1.57543897\nlog(dens)      -0.04950261 -0.007051205 -0.05655381\nMetroplondon    0.03621620  0.005158675  0.04137488\nMetropmetrop   -0.02805200 -0.003995758 -0.03204776\nlog(realWgPst)  0.67442535  0.096065881  0.77049124\nMajorityCONS   -0.01960548 -0.002792626 -0.02239811\nMajorityLAB     0.17957971  0.025579529  0.20515924\n\n\nAs a graphical display may be easier to begin with, we’ll use tinyplot and assemble the samples of \\rho_{\\mathrm{Lag}}, and the total impact samples for the variables: logarithm of pick-up point counts, proportion of dwellings among pick-up points, logarithm of density of pick-up points per unit area, logarithm of real wages, and the categorical variable Labour majority control (compared with base value of no overall control).\n\npre_samp &lt;- attr(imp_SLM_pre_maj_tr, \"samples\")\npost_samp &lt;- attr(imp_SLM_post_maj_tr, \"samples\")\npre_tot &lt;- imp_SLM_pre_maj_tr$sres$total[, c(1:3, 6, 8)]\npost_tot &lt;- imp_SLM_post_maj_tr$sres$total[, c(1:3, 6, 8)]\ntot &lt;- as.data.frame(rbind(pre_tot, post_tot))\nnames(tot)[4] &lt;- \"log.realWg.\"\ndf &lt;- data.frame(tot, rho=c(pre_samp$samples[,2], post_samp$samples[,2]), CCT=factor(c(rep(\"pre\", times=R), rep(\"post\", times=R)), levels=c(\"pre\", \"post\")))\n\nWe expect see the total impacts of the logarithm of density of pick-up points per unit area and those of the logarithm of real wages sharpen (move further from zero) as CCT leads to increased efficiency. An increase in efficiency might also be associated with moves toward zero of the other three variables. In Bivand and Szymanski (2000), we also asserted that \\rho_{\\mathrm{Lag}} would move towards zero as yardstick competition was replaced by competitive tendering.\n\nlibrary(tinyplot)\nlibrary(grid)\nx11()\ntinyplot(~ rho | CCT, data=df, type=\"density\", fill=\"by\", palette=\"dark2\", main=\"rho\")\ngridGraphics::grid.echo()\ng1 &lt;- grid.grab()\ndev.off()\nx11()\ntinyplot(~ log.units. | CCT, data=df, type=\"density\", fill=\"by\", palette=\"dark2\", main=\"log(units)\")\ngridGraphics::grid.echo()\ng2 &lt;- grid.grab()\ndev.off()\nx11()\ntinyplot(~ house | CCT, data=df, type=\"density\", fill=\"by\", palette=\"dark2\", main=\"house\")\ngridGraphics::grid.echo()\ng3 &lt;- grid.grab()\ndev.off()\nx11()\ntinyplot(~ log.dens. | CCT, data=df, type=\"density\", fill=\"by\", palette=\"dark2\", main=\"log(dens)\")\ngridGraphics::grid.echo()\ng4 &lt;- grid.grab()\ndev.off()\nx11()\ntinyplot(~ log.realWg. | CCT, data=df, type=\"density\", fill=\"by\", palette=\"dark2\", main=\"log(realWg)\")\ngridGraphics::grid.echo()\ng5 &lt;- grid.grab()\ndev.off()\nx11()\ntinyplot(~ MajorityLAB | CCT, data=df, type=\"density\", fill=\"by\", palette=\"dark2\", main=\"MajorityLAB\")\ngridGraphics::grid.echo()\ng6 &lt;- grid.grab()\ndev.off()\n\n\npng(\"Images/10_imp_pre_post_tr_fig0.png\", width=760, height=1200, pointsize=10)\ngrid.newpage()\ngridExtra::grid.arrange(g1, g2, g3, g4, g5, g6, nrow=3, ncol=2)\ndev.off()\n\n\n\n\n\n\nShifts in spatial coefficient value and chosen variable total impacts from pre-CCT to post-CCT, SLM models, 324 English districts\n\n\n\n\nWe can also use tinytable to show the estimates of \\rho_{\\mathrm{Lag}} and total imacts for the selected variables with their standard errors (for the impacts, standard errors estimated from the samples):\n\nlibrary(tinytable)\nsum_imp_SLM_pre_maj_tr &lt;- summary(imp_SLM_pre_maj_tr, short=TRUE, zstats=TRUE)\nsum_imp_SLM_post_maj_tr &lt;- summary(imp_SLM_post_maj_tr, short=TRUE, zstats=TRUE)\ntf &lt;- data.frame(variable=c(attr(imp_SLM_pre_maj_tr, \"bnames\")[c(1:3, 6, 8)], \"rho\"),\n  pre=c(sum_imp_SLM_pre_maj_tr$res$total[c(1:3, 6, 8)], SLM_pre_maj$rho),\n  pre_se=c(sum_imp_SLM_pre_maj_tr$semat[c(1:3, 6, 8), 3], SLM_pre_maj$rho.se),\n  post=c(sum_imp_SLM_post_maj_tr$res$total[c(1:3, 6, 8)], SLM_post_maj$rho),\n  post_se=c(sum_imp_SLM_post_maj_tr$semat[c(1:3, 6, 8), 3], SLM_post_maj$rho.se))\ntf$variable[4] &lt;- \"log(realWg)\"\ntt(tf, digits=4)\n\n \n\n  \n    \n    \n    tinytable_x7thj6a1p3jqq0ljqkme\n    \n    \n    \n    \n  \n\n  \n    \n      \n        \n        \n              \n                variable\n                pre\n                pre_se\n                post\n                post_se\n              \n        \n        \n        \n                \n                  log(units) \n                   1.13632\n                  0.07465\n                   1.07113\n                  0.06949\n                \n                \n                  house      \n                  -2.05136\n                  0.36659\n                  -1.57544\n                  0.33305\n                \n                \n                  log(dens)  \n                  -0.02365\n                  0.01477\n                  -0.05655\n                  0.01389\n                \n                \n                  log(realWg)\n                   0.40716\n                  0.25623\n                   0.77049\n                  0.21888\n                \n                \n                  MajorityLAB\n                   0.22867\n                  0.04353\n                   0.20516\n                  0.04111\n                \n                \n                  rho        \n                   0.1504 \n                  0.04404\n                   0.12778\n                  0.04532",
    "crumbs": [
      "<span class='chapter-number'>10</span>  <span class='chapter-title'>No orthogonality between regression and autoregression coefficients</span>"
    ]
  },
  {
    "objectID": "10_talk.html#bayesian-marginal-effects",
    "href": "10_talk.html#bayesian-marginal-effects",
    "title": "10  No orthogonality between regression and autoregression coefficients",
    "section": "10.3 Bayesian marginal effects",
    "text": "10.3 Bayesian marginal effects\nBecause MCMC in any case draws samples, the use of fitted coefficients and their covariance matrix for posterior sampling to carry out inference on the models is unnecessary, and the same trace method can be used as with other estimation methods for constructing the sample impacts. Here we thin the samples to reduce the time needed for plotting the density plots:\n\nset.seed(12345)\nSLM_pre_maj_bayes &lt;- spBreg_lag(form_pre_maj, data=eng324, listw=lw, control=list(ndraw=22000L, nomit=2000L, thin=10L))\n\n\nset.seed(12345)\nSLM_post_maj_bayes &lt;- spBreg_lag(form_post_maj, data=eng324, listw=lw, control=list(ndraw=22000L, nomit=2000L, thin=10L))\n\nAs can be seen, no R is needed to give the number of samples to draw, because they are already at hand. If we wished to modify the priors of the Bayesian models, we could also explore the consequences for the impacts - here uninformative priors have been used, yielding results very like those of maximum likelihood:\n\nsum_imp_pre &lt;- summary(impacts(SLM_pre_maj_bayes, tr=trMat))\nsum_imp_post &lt;- summary(impacts(SLM_post_maj_bayes, tr=trMat))\n\n\npre_tot &lt;- sum_imp_pre$sres$total[, c(1:3, 6, 8)]\npost_tot &lt;- sum_imp_post$sres$total[, c(1:3, 6, 8)]\nR &lt;- nrow(pre_tot)\ntot &lt;- as.data.frame(rbind(pre_tot, post_tot))\nnames(tot)[4] &lt;- \"log.realWg.\"\nbdf &lt;- data.frame(tot, rho=c(c(SLM_pre_maj_bayes[, \"rho\"]), c(SLM_post_maj_bayes[, \"rho\"])), CCT=factor(c(rep(\"pre\", times=R), rep(\"post\", times=R)), levels=c(\"pre\", \"post\")))\n\n\nlibrary(tinyplot)\nx11()\ntinyplot(~ rho | CCT, data=bdf, type=\"density\", fill=\"by\", palette=\"dark2\", main=\"rho\")\ngridGraphics::grid.echo()\ng1 &lt;- grid.grab()\ndev.off()\nx11()\ntinyplot(~ log.units. | CCT, data=bdf, type=\"density\", fill=\"by\", palette=\"dark2\", main=\"log(units)\")\ngridGraphics::grid.echo()\ng2 &lt;- grid.grab()\ndev.off()\nx11()\ntinyplot(~ house | CCT, data=bdf, type=\"density\", fill=\"by\", palette=\"dark2\", main=\"house\")\ngridGraphics::grid.echo()\ng3 &lt;- grid.grab()\ndev.off()\nx11()\ntinyplot(~ log.dens. | CCT, data=bdf, type=\"density\", fill=\"by\", palette=\"dark2\", main=\"log(dens)\")\ngridGraphics::grid.echo()\ng4 &lt;- grid.grab()\ndev.off()\nx11()\ntinyplot(~ log.realWg. | CCT, data=bdf, type=\"density\", fill=\"by\", palette=\"dark2\", main=\"log(realWg)\")\ngridGraphics::grid.echo()\ng5 &lt;- grid.grab()\ndev.off()\nx11()\ntinyplot(~ MajorityLAB | CCT, data=bdf, type=\"density\", fill=\"by\", palette=\"dark2\", main=\"MajorityLAB\")\ngridGraphics::grid.echo()\ng6 &lt;- grid.grab()\ndev.off()\n\n\npng(\"Images/10_bayes_pre_post_tr_fig0.png\", width=760, height=1200, pointsize=10)\ngrid.newpage()\ngridExtra::grid.arrange(g1, g2, g3, g4, g5, g6, nrow=3, ncol=2)\ndev.off()\n\n\n\n\n\n\nShifts in spatial coefficient value and chosen variable total impacts from pre-CCT to post-CCT, SLM models, 324 English districts\n\n\n\n\nWe could also replicate the outcomes in tabular form.",
    "crumbs": [
      "<span class='chapter-number'>10</span>  <span class='chapter-title'>No orthogonality between regression and autoregression coefficients</span>"
    ]
  },
  {
    "objectID": "10_talk.html#gmm-marginal-effects",
    "href": "10_talk.html#gmm-marginal-effects",
    "title": "10  No orthogonality between regression and autoregression coefficients",
    "section": "10.4 GMM marginal effects",
    "text": "10.4 GMM marginal effects\nPiras and Postiglione (2022) propose the use of eigenvalues of the spatial weights matrix to calculate the direct, indirect and total impacts, rather than the use of traces, which are necessarily approximate as the power series is truncated. However, an argument for GMM was that it avoided the computation of eigenvalues of the spatial weights matrix, which cease to be numerically stable at large n using standard or extended precision (n up to 10,000 is fine). For larger n, the trace method remains viable.\nThe eigenvalue method can of course also be used to calculate impacts from samples for inferential purposes, but so far only the impacts themselves are available for models fitted by maximum likelihood:\n\ntfe0 &lt;- data.frame(variable=c(names(coef(SLM_pre_maj))[3:10], \"rho\"), pre=c(impacts(SLM_pre_maj, evalues=e)$total, SLM_pre_maj$rho), post=c(impacts(SLM_post_maj, evalues=e)$total, SLM_post_maj$rho))\ntfe0$variable[6] &lt;- \"log(realWg)\"\ntt(tfe0, digits=4) \n\n \n\n  \n    \n    \n    tinytable_20gd4tltl5zhiqtg9fvk\n    \n    \n    \n    \n  \n\n  \n    \n      \n        \n        \n              \n                variable\n                pre\n                post\n              \n        \n        \n        \n                \n                  log(units)  \n                   1.13632\n                   1.07113\n                \n                \n                  house       \n                  -2.05136\n                  -1.57544\n                \n                \n                  log(dens)   \n                  -0.02365\n                  -0.05655\n                \n                \n                  Metroplondon\n                   0.08705\n                   0.04137\n                \n                \n                  Metropmetrop\n                  -0.0595 \n                  -0.03205\n                \n                \n                  log(realWg) \n                   0.40716\n                   0.77049\n                \n                \n                  MajorityCONS\n                   0.04446\n                  -0.0224 \n                \n                \n                  MajorityLAB \n                   0.22867\n                   0.20516\n                \n                \n                  rho         \n                   0.1504 \n                   0.12778\n                \n        \n      \n    \n\n    \n\n  \n\n\n\n\nLet us fit the SLM pre-CCT and post-CCT models with GMM:\n\nlibrary(sphet)\n\n\nAttaching package: 'sphet'\n\n\nThe following object is masked from 'package:spatialreg':\n\n    impacts\n\nspreg_pre_maj &lt;- spreg(form_pre_maj, data=eng324, listw=lw, model=\"lag\")\nspreg_post_maj &lt;- spreg(form_post_maj, data=eng324, listw=lw, model=\"lag\")\n\nand continue to calculate the impacts and their standard errors using the Kelejian and Piras formula:\n\nimp_spreg_pre_maj &lt;- impacts(spreg_pre_maj, evalues=e, KPformula=TRUE, prt=FALSE)\nimp_spreg_post_maj &lt;- impacts(spreg_post_maj, evalues=e, KPformula=TRUE, prt=FALSE)\n\n\netf &lt;- data.frame(variable=c(rownames(imp_spreg_pre_maj[[1]])[c(1:3, 6, 8)], \"rho\"),\n pre=c(imp_spreg_pre_maj[[1]][c(1:3, 6, 8), 3], c(coef(spreg_pre_maj)[10])),\n pre_se=c(imp_spreg_pre_maj[[2]][c(1:3, 6, 8), 3], sqrt(diag(spreg_pre_maj$var))[10]),\n post=c(imp_spreg_post_maj[[1]][c(1:3, 6, 8), 3], c(coef(spreg_post_maj)[10])),\n post_se=c(imp_spreg_post_maj[[2]][c(1:3, 6, 8), 3], sqrt(diag(spreg_post_maj$var))[10]))\netf$variable[4] &lt;- \"log(realWg)\"\ntt(etf, digits=4)\n\n \n\n  \n    \n    \n    tinytable_9ycn73uys0882ngj5dl5\n    \n    \n    \n    \n  \n\n  \n    \n      \n        \n        \n              \n                variable\n                pre\n                pre_se\n                post\n                post_se\n              \n        \n        \n        \n                \n                  log(units) \n                   1.19098\n                  0.09537\n                   1.0755 \n                  0.08659\n                \n                \n                  house      \n                  -2.15052\n                  0.41584\n                  -1.58078\n                  0.35657\n                \n                \n                  log(dens)  \n                  -0.02608\n                  0.01599\n                  -0.05683\n                  0.0146 \n                \n                \n                  log(realWg)\n                   0.38525\n                  0.27094\n                   0.76965\n                  0.22409\n                \n                \n                  MajorityLAB\n                   0.23452\n                  0.04707\n                   0.2056 \n                  0.04185\n                \n                \n                  rho        \n                   0.18698\n                  0.05349\n                   0.13111\n                  0.05787\n                \n        \n      \n    \n\n    \n\n  \n\n\n\n\nAlthough we could generate “density” plots using the standard errors, a more parsimonious approach might be a pair of coefficient plots:\n\nlibrary(tinyplot)\nlevel &lt;- 0.95\na &lt;- (1 - level)/2\na &lt;- c(a, 1 - a)\nfac &lt;- qt(a, 324)\nedf_pre &lt;- c(imp_spreg_pre_maj[[1]][c(1:3, 6, 8), 3], c(coef(spreg_pre_maj)[10])) + c(imp_spreg_pre_maj[[2]][c(1:3, 6, 8), 3], sqrt(diag(spreg_pre_maj$var))[10]) %o% fac\nedf_pre &lt;- data.frame(estimate=c(imp_spreg_pre_maj[[1]][c(1:3, 6, 8), 3], c(coef(spreg_pre_maj)[10])), ci_low=edf_pre[,1], ci_high=edf_pre[,2], vars=rownames(edf_pre))\nedf_pre$vars[4] &lt;- \"log(realWg)\"\nedf_post &lt;- c(imp_spreg_post_maj[[1]][c(1:3, 6, 8), 3], c(coef(spreg_post_maj)[10])) + c(imp_spreg_post_maj[[2]][c(1:3, 6, 8), 3], sqrt(diag(spreg_post_maj$var))[10]) %o% fac\nedf_post &lt;- data.frame(estimate=c(imp_spreg_post_maj[[1]][c(1:3, 6, 8), 3], c(coef(spreg_post_maj)[10])), ci_low=edf_post[,1], ci_high=edf_post[,2], vars=rownames(edf_post))\nedf_post$vars[4] &lt;- \"log(realWg)\"\nopar &lt;- par(mfrow=c(1,2), mar=c(7, 4, 4, 2)+0.1)\nwith(edf_pre, tinyplot(x=vars, y=estimate, ymin=ci_low, ymax=ci_high, type=\"pointrange\", col=\"blue4\", pch=16, cex=2, main=\"pre-CCT\", ylim=c(-2.9686, 1.3786), grid=TRUE, las=3))\nwith(edf_post, tinyplot(x=vars, y=estimate, ymin=ci_low, ymax=ci_high, type=\"pointrange\", col=\"red4\", pch=16, cex=2, main=\"post-CCT\", ylim=c(-2.9686, 1.3786), grid=TRUE, las=3))\n\n\n\n\nSpatial coefficient value and chosen variable total impacts and eigenvalue-based standard errors, pre-CCT and post-CCT, GMM SLM models, 324 English districts\n\n\n\npar(opar)\n\n\n\n\n\nAnselin, Luc, and N. Lozano-Gracia. 2008. “Errors in Variables and Spatial Effects in Hedonic House Price Models of Ambient Air Quality.” Empirical Economics 34: 5–34.\n\n\nBivand, Roger, and Stefan Szymanski. 2000. “Modelling the Spatial Impact of the Introduction of Compulsory Competitive Tendering.” Regional Science and Urban Economics 30: 203–19.\n\n\nGolgher, André Braz, and Paul R. Voss. 2016. “How to Interpret the Coefficients of Spatial Models: Spillovers, Direct and Indirect Effects.” Spatial Demography 4: 175–205. https://doi.org/10.1007/s40980-015-0016-y.\n\n\nKelejian, Harry H., G. Tavlas, and G. Hondroyiannis. 2006. “A Spatial Modelling Approach to Contagion Among Emerging Economies.” Open Economies Review 17: 423–41.\n\n\nLeSage, James P., and Manfred M. Fischer. 2008. “Spatial Growth Regression: Model Specification, Estimation and Interpretation.” Spatial Economic Analysis 3: 275–304.\n\n\nLeSage, James P., and R. Kelley Pace. 2009. Introduction to Spatial Econometrics. Boca Raton FL: Chapman; Hall/CRC.\n\n\nPiras, Gianfranco, and Paolo Postiglione. 2022. “A Deeper Look at Impacts in Spatial Durbin Model with Sphet.” Geographical Analysis 54 (3): 664–84. https://doi.org/10.1111/gean.12318.\n\n\nWard, M. D., and K. S. Gleditsch. 2008. Spatial Regression Models. Thousand Oaks, CA: Sage.",
    "crumbs": [
      "<span class='chapter-number'>10</span>  <span class='chapter-title'>No orthogonality between regression and autoregression coefficients</span>"
    ]
  },
  {
    "objectID": "11_talk.html",
    "href": "11_talk.html",
    "title": "11  Prediction and spatial models",
    "section": "",
    "text": "11.1 Prediction and impacts\nIn models fitted by OLS, the marginal effect of a unit change in a numerical independent variable is equal to the regression coefficient. Taking the mean difference of predicted values before and after the incrementation, we can see that this holds:\nOLS_pre &lt;- lm(form_pre_maj, data=eng324)\nrow.names(eng324) &lt;- eng324$NAME\nnewdata &lt;- eng324\np0 &lt;- predict(OLS_pre, newdata=newdata)\nnewdata$dens &lt;- exp(log(newdata$dens)+1)\np1 &lt;- predict(OLS_pre, newdata=newdata)\nmean(p1-p0)\n\n[1] -0.01552116\n\ncoefficients(OLS_pre)[\"log(dens)\"]\n\n  log(dens) \n-0.01552116\nWhen the spatially lagged dependent variable is included in the model (SLM, SDM, GNM), and as we have just seen, global spill-over occurs, varying in intensity as the coefficient departs from zero.\nlibrary(spdep)\nlw &lt;- nb2listw(unb, style=\"W\")\nlibrary(spatialreg)\ne &lt;- eigenw(lw)\nW &lt;- as(lw, \"CsparseMatrix\")\ntrMat &lt;- trW(W, type=\"mult\")\nSLM_pre_maj &lt;- lagsarlm(form_pre_maj, data=eng324, listw=lw, control=list(pre_eig=e))\nSLM_post_maj &lt;- lagsarlm(form_post_maj, data=eng324, listw=lw, control=list(pre_eig=e))\n(imp_SLM_pre_maj_ev &lt;- impacts(SLM_pre_maj, listw=lw, evalue=e))\n\nImpact measures (lag, exact):\n                    Direct     Indirect       Total\nlog(units)      0.97021645  0.166102763  1.13631922\nhouse          -1.75150349 -0.299860477 -2.05136397\nlog(dens)      -0.02019100 -0.003456735 -0.02364774\nMetroplondon    0.07432424  0.012724440  0.08704868\nMetropmetrop   -0.05080358 -0.008697662 -0.05950124\nlog(realWgPre)  0.34764203  0.059516927  0.40715896\nMajorityCONS    0.03796509  0.006499690  0.04446478\nMajorityLAB     0.19524091  0.033425587  0.22866650\nDoing this by hand and using the reduced form model: \\hat{{\\mathbf y}} = ({\\mathbf I} - \\rho {\\mathbf W})^{-1}{\\mathbf X}{\\mathbf \\beta}, we can see that the equality between the mean difference of before-and-after incrementation predictions is not with the regression coefficient for the chosen variable, byt with its total impact:\nIrW &lt;- invIrW(lw, rho=SLM_pre_maj$rho)\np0a &lt;- IrW %*% SLM_pre_maj$X %*% coef(SLM_pre_maj)[-1]\nnd &lt;- SLM_pre_maj$X\nnd[,4] &lt;- nd[,4] + 1\np1 &lt;- IrW %*% nd %*% coef(SLM_pre_maj)[-1]\nmean(p1-p0a)\n\n[1] -0.02364774\n\ncoefficients(SLM_pre_maj)[\"log(dens)\"]\n\n  log(dens) \n-0.02009104 \n\nimp_SLM_pre_maj_ev$total[3]\n\n[1] -0.02364774\nUsing the predict method described by Goulard, Laurent, and Thomas-Agnan (2017), we can see that this continues to hold:\np0 &lt;- predict(SLM_pre_maj, newdata=eng324, listw=lw, pred.type=\"TS\", legacy=FALSE)\nall.equal(unclass(p0), c(p0a), check.attributes=FALSE)\n\n[1] TRUE\n\np1 &lt;- predict(SLM_pre_maj, newdata=newdata, listw=lw, pred.type=\"TS\", legacy=FALSE)\nmean(p1-p0)\n\n[1] -0.02364774\n\nimp_SLM_pre_maj_ev$total[3]\n\n[1] -0.02364774",
    "crumbs": [
      "<span class='chapter-number'>11</span>  <span class='chapter-title'>Prediction and spatial models</span>"
    ]
  },
  {
    "objectID": "11_talk.html#predicting-post-cct-with-the-pre-cct-model",
    "href": "11_talk.html#predicting-post-cct-with-the-pre-cct-model",
    "title": "11  Prediction and spatial models",
    "section": "11.2 Predicting post-CCT with the pre-CCT model",
    "text": "11.2 Predicting post-CCT with the pre-CCT model\nWe can also use prediction in a counterfactual setting, by changing the only time-varying independent variable (real wages) in the newdata object. The model is fitted with the pre-CCT data, but the predictions are made with the fitted pre-CCT model and post-CCT data:\n\npre_nd &lt;- eng324\npre_nd$realWgPre &lt;- pre_nd$realWgPst\npre_post &lt;- predict(SLM_pre_maj, newdata=pre_nd, listw=lw, pred.type=\"TS\", legacy=FALSE)\neng324$diff &lt;- eng324$realNetPst-eng324$realNetPre\neng324$pre_diff &lt;- eng324$realNetPst-exp(pre_post)\n\n\nlibrary(tmap)\n\nBreaking News: tmap 3.x is retiring. Please test v4, e.g. with\nremotes::install_github('r-tmap/tmap')\n\ntm_shape(eng324) + tm_fill(c(\"diff\", \"pre_diff\"), n=11, style=\"pretty\", midpoint=0, palette=\"-RdBu\", title=\"£ 000\") + tm_borders() + tm_facets(free.scales=FALSE) + tm_layout(panel.labels=c(\"Post-CCT - Pre-CCT expenditure\", \"Post-CCT expenditure - prediction from pre-CCT model\"))\n\n\n\n\nDifference between real net expenditure post-CCT and pre-CCT (left), and predictions made with post-CCT independent variables and pre-CCT SLM model coefficients (right)",
    "crumbs": [
      "<span class='chapter-number'>11</span>  <span class='chapter-title'>Prediction and spatial models</span>"
    ]
  },
  {
    "objectID": "11_talk.html#out-of-sample-prediction",
    "href": "11_talk.html#out-of-sample-prediction",
    "title": "11  Prediction and spatial models",
    "section": "11.3 Out-of-sample prediction",
    "text": "11.3 Out-of-sample prediction\nThe situation becomes more complex for out-of-sample prediction. If we make predictions for a set of observations not linked in space through the spatial weights object with the set of observations used to fit the model, there are no troublesome spill-overs between the fitting set and the prediction set. Recall from chapter 6 that:\nThere is now an extensive literature both on the split between training and test data sets, and on the use of fitted models for prediction to areas that were un- or under-represented in the data used to fit the model (Meyer et al. 2018, 2019; Valavi et al. 2019; Schratz et al. 2019; Meyer and Pebesma 2021, 2022; Mila et al. 2022; Linnenbrink et al. 2023). These articles are accompanied by software permitting the reproduction of their findings and the application of suggested adaptations, replacing random permutations in machine learning model fitting and tuning by spatially-aware procedures.\nHere we will split England into the North region and the rest, modify the Metrop factor because no \"london\" level is present in the North, and divide the data and neighbour objects:\n\neng324$Metrop |&gt; as.character() |&gt; (\\(d) sub(\"london\", \"metrop\", x=d))() |&gt; factor() -&gt; eng324$Metrop\n\n\nrest &lt;- eng324$region != \"NORTH\"\neng324_rest &lt;- eng324[rest,]\nunb_rest &lt;- subset(unb, rest)\nunb_rest\n\nNeighbour list object:\nNumber of regions: 297 \nNumber of nonzero links: 1454 \nPercentage nonzero weights: 1.648358 \nAverage number of links: 4.895623 \n\nlw_rest &lt;- nb2listw(unb_rest, style=\"W\")\ne_rest &lt;- eigenw(lw_rest)\n\nThen we fit the rest of England subset using the formula without the political control variable, as there were no Conservative controlled local authorities in the North, and prepare the predictions made for the whole data set for mapping, allowing spill-over to occur between North and the rest of England:\n\nSLM_rest &lt;-lagsarlm(form_pre, data=eng324_rest, listw=lw_rest, control=list(pre_eig=e_rest))\neng324$rest_pred &lt;- exp(c(unclass(predict(SLM_rest, newdata=eng324, listw=lw, pred.type=\"TS\", legacy=FALSE))))\n\nWarning in predict.Sarlm(SLM_rest, newdata = eng324, listw = lw, pred.type =\n\"TS\", : some region.id are both in data and newdata\n\n\nNext, we repeat the subsetting, fitting the same formula to North data, and predicting for the whole data set:\n\neng324_north &lt;- eng324[!rest,]\nunb_north &lt;- subset(unb, !rest)\nunb_north\n\nNeighbour list object:\nNumber of regions: 27 \nNumber of nonzero links: 112 \nPercentage nonzero weights: 15.36351 \nAverage number of links: 4.148148 \n\nlw_north &lt;- nb2listw(unb_north, style=\"W\")\ne_north &lt;- eigenw(lw_north)\n\n\nSLM_north &lt;-lagsarlm(form_pre, data=eng324_north, listw=lw_north, control=list(pre_eig=e_north))\neng324$north_pred &lt;- exp(c(unclass(predict(SLM_north, newdata=eng324, listw=lw, pred.type=\"TS\", legacy=FALSE))))\n\nWarning in predict.Sarlm(SLM_north, newdata = eng324, listw = lw, pred.type =\n\"TS\", : some region.id are both in data and newdata\n\n\n\ntm_shape(eng324) + tm_fill(c(\"rest_pred\", \"north_pred\"), n=7, style=\"quantile\", palette=\"YlOrBr\", title=\"£ 000\") + tm_borders(col=\"grey\") + tm_facets(free.scales=FALSE) + tm_layout(panel.labels=c(\"Predicted pre-CCT expenditure, model without North region\", \"Predicted pre-CCT expenditure, North region model\"))\n\n\n\n\nDifference between real net expenditure post-CCT and pre-CCT (left), and predictions made with post-CCT independent variables and pre-CCT SLM model coefficients (right)\n\n\n\n\n\n\n\n\nBivand, Roger. 2002. “Spatial Econometrics Functions in R: Classes and Methods.” Journal of Geographical Systems 4: 405–21.\n\n\nDubin, Robin. 2003. “Robustness of Spatial Autocorrelation Specifications: Some Monte Carlo Evidence.” Journal of Regional Science 43 (2): 221–48. https://doi.org/10.1111/1467-9787.00297.\n\n\nGoulard, Michel, Thibault Laurent, and Christine Thomas-Agnan. 2017. “About Predictions in Spatial Autoregressive Models: Optimal and Almostoptimal Strategies.” Spatial Economic Analysis 12 (2-3): 304–25. https://doi.org/10.1080/17421772.2017.1300679.\n\n\nKato, Takafumi. 2013. “Usefulness of the Information Contained in the Prediction Sample for the Spatial Error Model.” The Journal of Real Estate Finance and Economics 47: 169–95. https://doi.org/10.1007/s11146-011-9345-9.\n\n\nLinnenbrink, J., C. Milà, M. Ludwig, and H. Meyer. 2023. “kNNDM: K-Fold Nearest Neighbour Distance Matching Cross-Validation for Map Accuracy Estimation.” EGUsphere 2023: 1–16. https://doi.org/10.5194/egusphere-2023-1308.\n\n\nMeyer, Hanna, and Edzer Pebesma. 2021. “Predicting into Unknown Space? Estimating the Area of Applicability of Spatial Prediction Models.” Methods in Ecology and Evolution 12 (9): 1620–33. https://doi.org/10.1111/2041-210X.13650.\n\n\n———. 2022. “Machine Learning-Based Global Maps of Ecological Variables and the Challenge of Assessing Them.” Nature Communincations 13. https://doi.org/ 10.1038/s41467-022-29838-9 .\n\n\nMeyer, Hanna, Christoph Reudenbach, Tomislav Hengl, Marwan Katurji, and Thomas Nauss. 2018. “Improving Performance of Spatio-Temporal Machine Learning Models Using Forward Feature Selection and Target-Oriented Validation.” Environmental Modelling & Software 101: 1–9. https://doi.org/10.1016/j.envsoft.2017.12.001.\n\n\nMeyer, Hanna, Christoph Reudenbach, Stephan Wöllauer, and Thomas Nauss. 2019. “Importance of Spatial Predictor Variable Selection in Machine Learning Applications – Moving from Data Reproduction to Spatial Prediction.” Ecological Modelling 411: 108815. https://doi.org/10.1016/j.ecolmodel.2019.108815.\n\n\nMila, Carles, Jorge Mateu, Edzer Pebesma, and Hanna Meyer. 2022. “Nearest Neighbour Distance Matching Leave-One-Out Cross-Validation for Map Validation.” Methods in Ecology and Evolution 13 (6): 1304–16. https://doi.org/10.1111/2041-210X.13851.\n\n\nSchratz, Patrick, Jannes Muenchow, Eugenia Iturritxa, Jakob Richter, and Alexander Brenning. 2019. “Hyperparameter Tuning and Performance Assessment of Statistical and Machine-Learning Algorithms Using Spatial Data.” Ecological Modelling 406: 109–20. https://doi.org/10.1016/j.ecolmodel.2019.06.002.\n\n\nSuesse, Thomas. 2018. “Marginal Maximum Likelihood Estimation of SAR Models with Missing Data.” Computational Statistics & Data Analysis 120: 98–110. https://doi.org/10.1016/j.csda.2017.11.004.\n\n\nSuesse, Thomas, and Andrew Zammit-Mangion. 2017. “Computational Aspects of the EM Algorithm for Spatial Econometric Models with Missing Data.” Journal of Statistical Computation and Simulation 87 (9): 1767–86. https://doi.org/10.1080/00949655.2017.1286495.\n\n\nValavi, Roozbeh, Jane Elith, José J. Lahoz-Monfort, and Gurutzeta Guillera-Arroita. 2019. “blockCV: An R Package for Generating Spatially or Environmentally Separated Folds for k-Fold Cross-Validation of Species Distribution Models.” Methods in Ecology and Evolution 10 (2): 225–32. https://doi.org/10.1111/2041-210X.13107.",
    "crumbs": [
      "<span class='chapter-number'>11</span>  <span class='chapter-title'>Prediction and spatial models</span>"
    ]
  },
  {
    "objectID": "12_talk.html",
    "href": "12_talk.html",
    "title": "12  Eigenvectors and eigenvalues of graphs of relationships between cross-sectional observations",
    "section": "",
    "text": "12.1 Neighbours as graphs\nA neighbour object may be represented as a sparse matrix, and as the relationship is symmetric, as an undirected graph. Graphs may be directed or undirected, and edges may be weighted. Graphs are in wide contemporary use in analysing social networks, traffic metadata, and internet advertising. Graph analysis techniques may tell us helpful things about our representation of neighbours.\nMoving from binary spatial weights to a symmetric sparse matrix - an adjacency matrix, we can go on to an undirected graph (see https://r.igraph.org/articles/igraph.html for details) using igraph; note that the region.id attribute of the nb object propagates through the row and column names of the sparse matrix to node names of the graph:\nlibrary(spatialreg)\n\nLoading required package: Matrix\n\n\n\nAttaching package: 'spatialreg'\n\n\nThe following objects are masked from 'package:spdep':\n\n    get.ClusterOption, get.coresOption, get.mcOption,\n    get.VerboseOption, get.ZeroPolicyOption, set.ClusterOption,\n    set.coresOption, set.mcOption, set.VerboseOption,\n    set.ZeroPolicyOption\n\nB0 &lt;- as(lwB, \"symmetricMatrix\")\nlibrary(igraph)\n\n\nAttaching package: 'igraph'\n\n\nThe following objects are masked from 'package:stats':\n\n    decompose, spectrum\n\n\nThe following object is masked from 'package:base':\n\n    union\n\ng1 &lt;- graph_from_adjacency_matrix(B0, mode=\"undirected\")\nc1 &lt;- components(g1)\nstr(c1)\n\nList of 3\n $ membership: Named num [1:324] 1 1 1 1 1 1 1 1 1 1 ...\n  ..- attr(*, \"names\")= chr [1:324] \"ADUR\" \"ALLERDALE\" \"ALNWICK\" \"AMBER VALLEY\" ...\n $ csize     : num 324\n $ no        : num 1\nHad unb had subgraphs, the number of components would have been greater than one - this is the same as n.comp.nb in spdep:\nstr(n.comp.nb(unb))\n\nList of 2\n $ nc     : int 1\n $ comp.id: int [1:324] 1 1 1 1 1 1 1 1 1 1 ...\nThis is also shown by is_connected, as there are no nodes that are unconnected:\nis_connected(g1)\n\n[1] TRUE\ndiameter is the largest number of steps taken to traverse the graph, and the i to j step count is highly correlated with the measured metric distance:\ndiameter(g1)\n\n[1] 23\ndistances provides a matrix of all i to j step counts, showing that the minimum is 0, i to i steps with no self-loops:\nstr(g1d &lt;- distances(g1))\n\n num [1:324, 1:324] 0 18 19 13 1 12 5 6 10 10 ...\n - attr(*, \"dimnames\")=List of 2\n  ..$ : chr [1:324] \"ADUR\" \"ALLERDALE\" \"ALNWICK\" \"AMBER VALLEY\" ...\n  ..$ : chr [1:324] \"ADUR\" \"ALLERDALE\" \"ALNWICK\" \"AMBER VALLEY\" ...\n\nsummary(c(g1d))\n\n   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. \n  0.000   6.000   9.000   9.066  12.000  23.000\nWe can also look at the degree counts, which are symmetric for edges in an undirected graph, but which could be in-degree or out-degree for directed graphs:\nhead(sort(degree(g1), decreasing=TRUE))\n\nSTRATFORD-ON-AVON        HARBOROUGH         HIGH PEAK     RIBBLE VALLEY \n               11                 9                 9                 9 \n     AMBER VALLEY         BRECKLAND \n                8                 8\nThis is the same as examining the cardinality of neighbour sets:\ncunb &lt;- card(unb)\nnames(cunb) &lt;- attr(unb, \"region.id\")\nhead(sort(cunb, decreasing=TRUE))\n\nSTRATFORD-ON-AVON        HARBOROUGH         HIGH PEAK     RIBBLE VALLEY \n               11                 9                 9                 9 \n     AMBER VALLEY         BRECKLAND \n                8                 8\nSince we are looking at eigenvalues, page_rank - the Google approach to sorting hyperlinks (as a directed graph) - which uses the solution to the eigenvalue decomposition of the graph to rank web pages by incoming links:\nhead(sort(page_rank(g1)$vector, decreasing=TRUE))\n\nSTRATFORD-ON-AVON     RIBBLE VALLEY         HIGH PEAK         MID DEVON \n      0.005808958       0.005320926       0.005179886       0.005177169 \n    EPPING FOREST    CASTLE MORPETH \n      0.005025738       0.005022165\nor the eigen_centrality of the graph:\nhead(sort(eigen_centrality(g1)$vector, decreasing=TRUE))\n\nSTRATFORD-ON-AVON             RUGBY          WYCHAVON          DAVENTRY \n        1.0000000         0.7239936         0.6912560         0.6907044 \n       BROMSGROVE        HARBOROUGH \n        0.6468678         0.6236657\nSo using eigenvalues in relation to graphs is well-established.",
    "crumbs": [
      "<span class='chapter-number'>12</span>  <span class='chapter-title'>Eigenvectors and eigenvalues of graphs of relationships between cross-sectional observations</span>"
    ]
  },
  {
    "objectID": "12_talk.html#eigenproblem",
    "href": "12_talk.html#eigenproblem",
    "title": "12  Eigenvectors and eigenvalues of graphs of relationships between cross-sectional observations",
    "section": "12.2 Eigenproblem",
    "text": "12.2 Eigenproblem\nIn general, the number of neighbours for each observation will be small compared to n, so that {\\mathbf W} is usually sparse. Ord (1975) gives a maximum likelihood method for estimating the spatial error SAR model. Unlike the time series case, the logarithm of the determinant of the (N \\times N) matrix ({\\mathbf I} - \\lambda {\\mathbf W}) does not tend to zero with increasing sample size. It constrains the parameter values to their feasible range between the inverses of the smallest and largest eigenvalues of {\\mathbf W}. For positive autocorrelation, \\ln | {\\mathbf I} - \\lambda {\\mathbf W}| \\rightarrow -\\infty as \\lambda \\rightarrow 1/\\max_i(\\zeta_i) - \\zeta_i are the eigenvalues of {\\mathbf W}.\nThe log-likelihood function for the spatial error model:\n\n\\ell(\\lambda, \\sigma^2) = - \\frac{N}{2} \\ln 2 \\pi - \\frac{N}{2} \\ln \\sigma^2 + \\ln |{\\mathbf I} - \\lambda {\\mathbf W}| - \\frac{1}{2 \\sigma^2} \\big[{\\mathbf y}'({\\mathbf I} - \\lambda {\\mathbf W})' ({\\mathbf I} - {\\mathbf Q}_{\\lambda}{\\mathbf Q}_{\\lambda}') ({\\mathbf I} - \\lambda {\\mathbf W}){\\mathbf y}\\big]\n\nwhere {\\mathbf Q}_{\\lambda} is obtained by decomposing ({\\mathbf X} - \\lambda {\\mathbf W}{\\mathbf X}) = {\\mathbf Q}_{\\lambda} {\\mathbf R}_{\\lambda}.\nAs we can see, the problem is one of balancing the log determinant term against the sum of squares term. When \\lambda approaches the ends of its feasible range, the log determinant term may swamp the sum of squares term.\n\n12.2.1 Computing the Jacobian\nThere are a number of areas in applied statistical data analysis in which the efficient computation of the log determinant of a possibly sparse real symmetric positive definite matrix is necessary. One of these is in finding the values of the log likelihood function for various spatial regression models, where the underlying sparse matrix of spatial weights represents a graph of relationships between observations. For small numbers of observations, there are no difficulties in treating the spatial weights matrix as dense, and computing the log determinant using its eigenvalues. The intention in this class is to discuss in detail developments in the computation of such log determinants.\n\n\n12.2.2 Eigenvalue approach\nThe first published versions of the eigenvalue method for finding the Jacobian (Ord 1975) is:\n\n\\log(|{\\mathbf I} - \\lambda {\\mathbf W}|) = \\sum_{i=1}^{N} \\log(1 - \\lambda\\zeta_i)\n\nwhere \\zeta_i are the eigenvalues of {\\mathbf W}. One specific problem addressed by Ord is that of the eigenvalues of the asymmetric row-standardised matrix W with underlying symmetric neighbour relations c_{ij} = c_{ji}. If we write {\\mathbf w} = {\\mathbf C}{\\mathbf 1}, where {\\mathbf 1} is a vector of ones, we can get: {\\mathbf W} = {\\mathbf C}{\\mathbf D}, where {\\mathbf D} = {\\mathrm {diag}}(1/{\\mathbf w}); by similarity, the eigenvalues of {\\mathbf W} are equal to those of: {\\mathbf D}^{\\frac{1}{2}}{\\mathbf C}{\\mathbf D}^{\\frac{1}{2}}.\nMany disciplines using spatial regression methods simply use unstandardised neighbour relations matrices which may or may not be symmetric. We show the lower and upper bounds for \\rho for the 324 districts under different weights representations. The underlying eigenvalues have been calculated using the R eigen function, with symmetry of the input matrix determined by the internal code. Where symmetry by similarity exists, it is also discovered by the function:\n\neB &lt;- eigenw(lwB)\neW &lt;- eigenw(similar.listw(lwW))\ncat(\"Class:\", class(eB), \"min:\", 1/min(eB), \"max:\", 1/max(eB), \"\\n\")\n\nClass: numeric min: -0.3129207 max: 0.1666602 \n\neigW &lt;- eigenw(similar.listw(lwW))\ncat(\"Class:\", class(eW), \"min:\", 1/min(eW), \"max:\", 1/max(eW), \"\\n\")\n\nClass: numeric min: -1.224561 max: 1 \n\n\nJacobian term and extreme eigenvalues\n\noopar &lt;- par(mfrow=c(1,2), mar=c(4,2,4,2))\nrhoB &lt;- seq(1/min(eB), 1/max(eB), length.out=500)\nplot(rhoB, sapply(rhoB, function(rho) sum(log(1 - rho*eB))), type=\"l\", xlab=expression(rho), ylab=\"\", main=\"Binary weights\")\nabline(v=1/range(eB), lty=2, lwd=2, col=\"#EB811B\")\nabline(h=0, v=0, lty=2, col=\"grey\")\nlegend(\"bottomright\", bty=\"n\", legend=c(expression(plain(ln) * group(\"|\", bold(I) - rho * bold(W), \"|\")), \"extreme eigenvalues\"), lty=c(1, 2), lwd=c(1, 2), col=c(\"black\", \"#EB811B\"), cex=0.8)\nrhoW &lt;- seq(1/min(eW), 1/max(eW), length.out=500)\nplot(rhoW, sapply(rhoW, function(rho) sum(log(1 - rho*eW))), type=\"l\", xlab=expression(rho), ylab=\"\", main=\"Row-standardised weights\")\nabline(v=1/range(eW), lty=2, lwd=2, col=\"#EB811B\")\nabline(h=0, v=0, lty=2, col=\"grey\")\n\n\n\n\nValues of the log determinant term for ranges of values of the spatial parameter\n\n\n\npar(oopar)\n\nIn a series of contributions, Pace and Barry (1997) show that sparse matrix methods can be used to find the log determinant directly. The method of choice is the Cholesky decomposition of a sparse, symmetric, positive-definite matrix. It but can be extended to the LU decomposition if requirements on the matrix need to be relaxed. Naturally, for the same sparse, symmetric, positive-definite matrix, one would expect the log determinants based on the Cholesky decomposition and the LU decomposition to be identical within machine precision.",
    "crumbs": [
      "<span class='chapter-number'>12</span>  <span class='chapter-title'>Eigenvectors and eigenvalues of graphs of relationships between cross-sectional observations</span>"
    ]
  },
  {
    "objectID": "12_talk.html#aple",
    "href": "12_talk.html#aple",
    "title": "12  Eigenvectors and eigenvalues of graphs of relationships between cross-sectional observations",
    "section": "12.3 APLE",
    "text": "12.3 APLE\nUnlike the Saddlepoint approximation and the exact distribution, APLE does not require the calculation of the eigenvalues but rather the trace of \\mathbf{W}\\mathbf{W}. The trace is used to ``stretch’’ Moran’s I with respect to the feasible range of the equivalent simultaneous autoregression coefficient, which APLE approximates. Inference on APLE is based on permutation bootstrap (Li, Calder, and Cressie 2012).\n\nc(crossprod(eigW))\n\n[1] 67.45592\n\n\nThe cross-product of the eigenvalues is equal to the trace of the second power of the weights:\n\nW &lt;- as(lwW, \"CsparseMatrix\")\nsum(diag(W %*% W))\n\n[1] 67.45592\n\n\ngiving us the APLE:\n\nvar &lt;- scale(log(eng324$realNetPre), scale=FALSE)[,1]\nset.seed(1)\naple.mc(var, lwW, nsim=999)\n\n\nDATA PERMUTATION\n\n\nCall:\nboot(data = x, statistic = aple.boot, R = nsim, sim = \"permutation\", \n    pre = pre, parallel = parallel, ncpus = ncpus, cl = cl)\n\n\nBootstrap Statistics :\n     original     bias    std. error\nt1* 0.5534535 -0.5582679  0.08375269",
    "crumbs": [
      "<span class='chapter-number'>12</span>  <span class='chapter-title'>Eigenvectors and eigenvalues of graphs of relationships between cross-sectional observations</span>"
    ]
  },
  {
    "objectID": "12_talk.html#moran-eigenvectors---spatial-filtering",
    "href": "12_talk.html#moran-eigenvectors---spatial-filtering",
    "title": "12  Eigenvectors and eigenvalues of graphs of relationships between cross-sectional observations",
    "section": "12.4 Moran eigenvectors - spatial filtering",
    "text": "12.4 Moran eigenvectors - spatial filtering\nIt has been suggested by Griffith (2003) that maps of eigenvectors of the spatial weights matrix may be used to explore the effect of scale, because some eigenvectors will show large scale structures, others will capture regional differences, and others again will represent small scale patterns (Chun and Griffith 2013; Griffith 2010; Patuelli et al. 2012)\n\nx &lt;- log(eng324$realNetPre)\nmoran.test(x, lwW)$estimate\n\nMoran I statistic       Expectation          Variance \n      0.341331393      -0.003095975       0.001348605 \n\n\n\nn &lt;- nrow(eng324)\nM &lt;- diag(n) - (tcrossprod(rep(1, n)))/n\nMCM &lt;- M %*% W %*% M\nc((n/sum(W)) * crossprod(x, MCM %*% x)/crossprod(x, M %*% x))\n\n[[1]]\n1 x 1 Matrix of class \"dgeMatrix\"\n          [,1]\n[1,] 0.3413314\n\n\nFollowing Tiefelsdorf and Griffith (2007), we can choose the eigenvectors of the doubly centred matrix that reduce residual autocorrelation most:\n\nSF_pre_maj &lt;- SpatialFiltering(form_pre_maj, data=eng324, nb=unb, style=\"W\", alpha=0.33)\nSF_pre_maj\n\n  Step SelEvec      Eval       MinMi    ZMinMi      Pr(ZI)        R2      gamma\n0    0       0 0.0000000 0.105669000 3.2202539 0.001280771 0.8510363  0.0000000\n1    1       4 0.9898642 0.083006376 2.6964636 0.007008007 0.8547590 -0.6563168\n2    2      14 0.9023341 0.062556323 2.2195372 0.026450202 0.8582958 -0.6397312\n3    3      10 0.9298828 0.047684764 1.8986116 0.057615562 0.8606846 -0.5257440\n4    4      66 0.4246665 0.032731810 1.5196152 0.128607722 0.8659997 -0.7842311\n5    5      17 0.8710660 0.017698183 1.1855141 0.235814258 0.8683604  0.5226422\n6    6      19 0.8585573 0.005741818 0.9346916 0.349947252 0.8702059  0.4621184\n\n\nThen add this spatial term to the regular aspatial OLS model:\n\nSF_pre_maj_lm &lt;- lm(update(form_pre_maj, . ~ . + fitted(SF_pre_maj)), data=eng324)\nspdep::lm.morantest(SF_pre_maj_lm, lwW)\n\n\n    Global Moran I for regression residuals\n\ndata:  \nmodel: lm(formula = update(form_pre_maj, . ~ . + fitted(SF_pre_maj)),\ndata = eng324)\nweights: lwW\n\nMoran I statistic standard deviate = 0.93469, p-value = 0.175\nalternative hypothesis: greater\nsample estimates:\nObserved Moran I      Expectation         Variance \n     0.005741818     -0.027667662      0.001277623",
    "crumbs": [
      "<span class='chapter-number'>12</span>  <span class='chapter-title'>Eigenvectors and eigenvalues of graphs of relationships between cross-sectional observations</span>"
    ]
  },
  {
    "objectID": "12_talk.html#extreme-eigenvalues",
    "href": "12_talk.html#extreme-eigenvalues",
    "title": "12  Eigenvectors and eigenvalues of graphs of relationships between cross-sectional observations",
    "section": "12.5 Extreme eigenvalues",
    "text": "12.5 Extreme eigenvalues\nThe largest and smallest eigenvalues are needed to find the bounds of the domain of the spatial autoregressive coefficient. If n is moderate, as it is here, we can solve the eigenproblem by computation, and so have a benchmark. We can also use an approximation given by Griffith (2004) to find the extreme eiegenvalues of binary and row-standardised weights. Alternative methods can also be used, such as RSpectra to return the extreme eigenvalues of large sparse matrices.\n\n12.5.1 Rayleigh quotient approaches\nGriffith (2004) shows how extreme eigenvalues of a binary symmetric contiguity matrix {\\mathbf C} expressed as an undirected irreducible planar graph may be calculated.\nThe largest eigenvalue is found using the Rayleigh quotient approach:\n\n\\lambda_1 = \\lim_{k\\to\\infty} \\frac{({\\mathbf 1}'{\\mathbf C}^{k+1}{\\mathbf 1})}{({\\mathbf 1}'{\\mathbf C}^k{\\mathbf 1})}.\n\nGriffith (2004) further describes an approach to finding the smallest eigenvalue of {\\mathbf C}. This is extended to the case of the smallest eigenvalue of {\\mathbf W}, the row-standardised spatial weights matrix based on {\\mathbf C}.\n\necount(g1) &lt;= 3*vcount(g1) - 6\n\n[1] TRUE\n\n1/range(eB)\n\n[1] -0.3129207  0.1666602\n\nrB &lt;- lextrB(lwB)\n1/c(rB)\n\n  lambda_n   lambda_1 \n-0.3130520  0.1666602 \n\n1/range(eW)\n\n[1] -1.224561  1.000000\n\nrW &lt;- lextrW(lwW)\n1/c(rW)\n\n lambda_n  lambda_1 \n-1.224561  1.000001 \n\n\nImplementations of these methods, based on original code by Griffith and re-implemented in R and C, are now available in spatialreg as functions lextrB and lextrW. For large regular grids, the eigenvalues of {\\mathbf C} are known analytically for contiguity defined as non-zero shared boundary length (Ord 1975; Griffith and Sone 1995).\n\n\n12.5.2 Alternatives\nIn the row-standardised cases, 1/\\lambda_{\\max} is 1 by construction, and as Smirnov and Anselin (2009) show, 1/\\lambda_{\\min} may be found to be -1 by graph analysis. If larger subgraphs, or the graph as a whole, are cyclical in Smirnov and Anselin’s terminology - for every location i, no pair of its neighbours j, k are connected - the smallest eigenvalue must be -1 by definition. Taking 1/\\lambda_{\\min}=-1 may be inappropriate for some lattices for which this condition does not hold, especially when more than one spatial coefficient is being estimated\n\nlibrary(RSpectra)\nB &lt;- as(as(B0, \"symmetricMatrix\"), \"unpackedMatrix\")\narB &lt;- eigs(B, 2, which = \"BE\")\n1/rev(arB$values)\n\n[1] -0.3129207  0.1666602\n\nW &lt;- as(as(similar.listw(lwW), \"CsparseMatrix\"), \"symmetricMatrix\")\narW &lt;- eigs(W, 2, which = \"BE\")\n1/rev(arW$values)\n\n[1] -1.224561  1.000000\n\n\nWe need eigenvalues (and eigenvectors) in many settings in spatial analysis. Eigenvalues can be used for testing spatial autocorrelation and fitting spatial regression models. Extreme eigenvalues are needed in fitting spatial regression models when n is large, because they give the interval for line search and nonlinear optimisation. Griffith approximations are fast and quite robust for symmetric weights, but when the input graphs diverge from the planarity condition, they may fail.\n\n\n\n\nChun, Yongwan, and Daniel A. Griffith. 2013. Spatial Statistics and Geostatistics: Theory and Applications for Geographic Information Science and Technology. Thousand Oaks, CA: Sage.\n\n\nGriffith, Daniel A. 2003. Spatial Autocorrelation and Spatial Filtering. New York: Springer.\n\n\n———. 2004. “Extreme Eigenfunctions of Adjacency Matrices for Planar Graphs Employed in Spatial Analyses.” Linear Algebra and Its Applications 388: 201–19. https://doi.org/10.1016/S0024-3795(03)00368-9.\n\n\n———. 2010. “Spatial Filtering.” In Handbook of Applied Spatial Analysis, edited by Manfred Fischer and Arthur Getis, 301–18. Heidelberg: Springer.\n\n\nGriffith, Daniel A., and A Sone. 1995. “Trade-offs associated with normalizing constant computational simplifications for estimating spatial statistical models.” Journal of Statistical Computation and Simulation 51 (2–4): 165–83.\n\n\nLi, H., C. A. Calder, and N. Cressie. 2012. “One-Step Estimation of Spatial Dependence Parameters: Properties and Extensions of the APLE Statistic.” Journal of Multivariate Analysis 105 (1): 68–84.\n\n\nOrd, J. Keith. 1975. “Estimation Methods for Models of Spatial Interaction.” Journal of the American Statistical Association 70: 120–26.\n\n\nPace, R. Kelley, and R. P. Barry. 1997. “Fast CARs.” Journal of Statistical Computation and Simulation 59 (2): 123–45.\n\n\nPatuelli, Roberto, Norbert Schanne, Daniel A. Griffith, and Peter Nijkamp. 2012. “PERSISTENCE OF REGIONAL UNEMPLOYMENT: APPLICATION OF a SPATIAL FILTERING APPROACH TO LOCAL LABOR MARKETS IN GERMANY.” Journal of Regional Science 52 (2): 300–323. https://doi.org/10.1111/j.1467-9787.2012.00759.x.\n\n\nSmirnov, O., and Luc Anselin. 2009. “An O(N) Parallel Method of Computing the Log-Jacobian of the Variable Transformation for Models with Spatial Interaction on a Lattice.” Computational Statistics & Data Analysis 53 (8): 2980–88.\n\n\nTiefelsdorf, Michael, and Daniel A. Griffith. 2007. “Semiparametric Filtering of Spatial Autocorrelation: The Eigenvector Approach.” Environment and Planning A: Economy and Space 39 (5): 1193–1221. https://doi.org/10.1068/a37378.",
    "crumbs": [
      "<span class='chapter-number'>12</span>  <span class='chapter-title'>Eigenvectors and eigenvalues of graphs of relationships between cross-sectional observations</span>"
    ]
  },
  {
    "objectID": "references.html",
    "href": "references.html",
    "title": "References",
    "section": "",
    "text": "Ahmed, Zia U., Kang Sun, Michael Shelly, and Lina Mu. 2021.\n“Explainable Artificial Intelligence (XAI) for Exploring Spatial\nVariability of Lung and Bronchus Cancer (LBC) Mortality Rates in the\nContiguous USA.” Scientific Reports 11: 24090. https://doi.org/10.1038/s41598-021-03198-8.\n\n\nAkbari, Kamal, Stephan Winter, and Martin Tomko. 2023. “Spatial\nCausality: A Systematic Review on Spatial Causal Inference.”\nGeographical Analysis 55 (1): 56–89. https://doi.org/10.1111/gean.12312.\n\n\nAlam, Moudud, Lars Rönnegård, and Xia Shen. 2015. “Fitting\nConditional and Simultaneous Autoregressive Spatial Models in\nHglm.” The R Journal 7 (2): 5–18. https://doi.org/10.32614/RJ-2015-017.\n\n\nAlves Costa, Sonia M., Laura Sánchez, Diego Piñón, José A. Tarrio\nMosquera, Gabriel Guimarães, Demián D. Gómez, Hermann Drewes, et al.\n2023. “Status of the SIRGAS Reference Frame: Recent Developments\nand New Challenges.” In International Association of Geodesy\nSymposia, 1–13. Berlin, Heidelberg: Springer Berlin Heidelberg. https://doi.org/10.1007/1345_2023_227.\n\n\nAngrist, Joshua D., Guido W. Imbens, and Donald B. Rubin. 1996.\n“Identification of Causal Effects Using Instrumental\nVariables.” Journal of the American Statistical\nAssociation 91 (434): 444–72.\n\n\nAnselin, Luc. 1988a. “Lagrange Multiplier Test Diagnostics for\nSpatial Dependence and Spatial Heterogeneity.” Geographical\nAnalysis 20 (1): 1–17. https://doi.org/10.1111/j.1538-4632.1988.tb00159.x.\n\n\n———. 1988b. Spatial Econometrics: Methods\nand Models. Dordrecht: Kluwer Academic Publishers.\n\n\n———. 2006. “Spatial Econometrics.” In Palgrave Handbook\non Econometrics: Econometric Theory, edited by T. C. Mills and K.\nPatterson, 901–69. Basingstoke: Palgrave Macmillan.\n\n\n———. 2010a. “Spatial Econometrics.” In The SAGE\nHandbook of Spatial Analysis, edited by A. Stewart Fotheringham and\nPeter A. Rogerson, 255–75. London: SAGE Publications Ltd.\n\n\n———. 2010b. “Thirty Years of Spatial Econometrics.”\nPapers in Regional Science 89: 3–25.\n\n\nAnselin, Luc, Anil K. Bera, R. Florax, and M. J. Yoon. 1996.\n“Simple Diagnostic Tests for Spatial Dependence.”\nRegional Science and Urban Economics 26: 77–104. https://doi.org/10.1016/0166-0462(95)02111-6.\n\n\nAnselin, Luc, and N. Lozano-Gracia. 2008. “Errors in Variables and\nSpatial Effects in Hedonic House Price Models of Ambient Air\nQuality.” Empirical Economics 34: 5–34.\n\n\nArbia, Giuseppe. 2001. “Modelling the Geography of Economic\nActivities on a Continuous Space.” Papers in Regional\nScience 80 (4): 411–24. https://doi.org/10.1111/j.1435-5597.2001.tb01211.x.\n\n\nBailly, Antoine, Pierre-Henri Derycke, and André Torre. 2012. “50\nAns de Science Régionale Francophone.” l’Association de Science\nRégionale de Langue Française. http://www.asrdlf.org/telechargements/50ansASRDLF.pdf.\n\n\nBardaka, Eleni, Michael S. Delgado, and Raymond J. G. M. Florax. 2018.\n“Causal Identification of Transit-Induced Gentrification and\nSpatial Spillover Effects: The Case of the Denver Light Rail.”\nJournal of Transport Geography 71: 15–31. https://doi.org/10.1016/j.jtrangeo.2018.06.025.\n\n\n———. 2019. “A Spatial Multiple Treatment/Multiple Outcome\nDifference-in-Differences Model with an Application to Urban Rail\nInfrastructure and Gentrification.” Transportation Research\nPart A: Policy and Practice 121: 325–45. https://doi.org/10.1016/j.tra.2019.01.028.\n\n\nBartels, Cornelis P. A., and Leen Hordijk. 1977. “On the Power of\nthe Generalized Moran Contiguity Coefficient in Testing for Spatial\nAutocorrelation Among Regression Disturbances.” Regional\nScience and Urban Economics 7: 83–101.\n\n\nBaylis, Kathy, and Andrés Ham. 2015. “How Important Is Spatial\nCorrelation in Randomized Controlled Trials?” https://ageconsearch.umn.edu/record/205586/.\n\n\nBello, Hakeem, and Stefan Szymanski. 1996. “COMPULSORY COMPETITIVE\nTENDERING FOR PUBLIC SERVICES IN THE UK: THE CASE OF REFUSE\nCOLLECTION.” Journal of Business Finance &\nAccounting 23 (5-6): 881–903. https://doi.org/10.1111/j.1468-5957.1996.tb01157.x.\n\n\nBesag, Julian. 1974. “Spatial Interaction and the Statistical\nAnalysis of Lattice Systems.” Journal of the Royal\nStatistical Society. Series B (Methodological) 36: pp. 192–236.\n\n\nBesley, Timothy, and Anne Case. 1995. “Incumbent Behavior:\nVote-Seeking, Tax-Setting, and Yardstick Competition.”\nAmerican Economic Review 85 (1): 25.\n\n\nBillot, Antoine, and Jacques-Francois Thisse. 1992. “Claude\nPonsard (1927-1990): A Biographical Essay.”\nAnnals of Regional Science 26: 191–98.\n\n\nBivand, Roger. 1984. “Regression Modeling with Spatial Dependence:\nAn Application of Some Class Selection and Estimation Methods.”\nGeographical Analysis 16: 25–37.\n\n\n———. 2002. “Spatial Econometrics Functions in R:\nClasses and Methods.” Journal of Geographical Systems 4:\n405–21.\n\n\n———. 2008. “Implementing Representations of Space in Economic\nGeography.” Journal of Regional Science 48: 1–27.\n\n\n———. 2012. “After ‘Raising the\nBar’: Applied Maximum Likelihood Estimation of Families of\nModels in Spatial Econometrics.” Estadística Española\n54: 71–88.\n\n\n———. 2022. “Analytical Environments.” In Handbook of\nSpatial Analysis in the Social Sciences, edited by Sergio J. Rey\nand Rachel Franklin, 36–63. Camberley, UK: Edward Elgar. https://hdl.handle.net/11250/3065981.\n\n\nBivand, Roger, Jan Hauke, and Tomasz Kossowski. 2013. “Computing\nthe Jacobian in Gaussian Spatial\nAutoregressive Models: An Illustrated Comparison of Available\nMethods.” Geographical Analysis 45: 150–79.\n\n\nBivand, Roger, Giovanni Millo, and Gianfranco Piras. 2021. “A\nReview of Software for Spatial Econometrics in R.”\nMathematics 9 (11). https://doi.org/10.3390/math9111276.\n\n\nBivand, Roger, W. Müller, and M. Reder. 2009. “Power Calculations\nfor Global and Local Moran’s I.” Computational\nStatistics and Data Analysis 53: 2859–72.\n\n\nBivand, Roger, and Gianfranco Piras. 2015. “Comparing\nImplementations of Estimation Methods for Spatial Econometrics.”\nJournal of Statistical Software 63 (1): 1–36. https://doi.org/10.18637/jss.v063.i18.\n\n\nBivand, Roger, Zhe Sha, Liv Osland, and Ingrid Sandvig Thorsen. 2017.\n“A Comparison of Estimation Methods for Multilevel Models of\nSpatially Structured Data.” Spatial Statistics. https://doi.org/10.1016/j.spasta.2017.01.002.\n\n\nBivand, Roger, and Stefan Szymanski. 1997. “Spatial Dependence\nThrough Local Yardstick Competition: Theory and Testing.”\nEconomics Letters 55: 257–65.\n\n\n———. 2000. “Modelling the Spatial Impact of the Introduction of\nCompulsory Competitive Tendering.” Regional Science and Urban\nEconomics 30: 203–19.\n\n\nBivand, Roger, and David W. S. Wong. 2018. “Comparing\nImplementations of Global and Local Indicators of Spatial\nAssociation.” TEST 27 (3): 716–48. https://doi.org/10.1007/s11749-018-0599-x.\n\n\nBoyce, David. 2004. “A Short History of the Field of Regional\nScience.” Papers in Regional Science 83: 31–57.\n\n\nBrenning, Alexander. 2012. “Spatial Cross-Validation and Bootstrap\nfor the Assessment of Prediction Rules in Remote Sensing: The r Package\nSperrorest.” In 2012 IEEE International Geoscience and Remote\nSensing Symposium, 5372–75. https://doi.org/10.1109/IGARSS.2012.6352393.\n\n\nBrueckner, Jan K. 2003. “Strategic Interaction Among Governments:\nAn Overview of Empirical Studies.” International Regional\nScience Review 26: 175–88.\n\n\nBurridge, P. 1981. “Testing for a Common Factor in a Spatial\nAutoregression Model.” Environment and Planning A 13:\n795–800.\n\n\nButts, Kyle. 2023a. “Geographic\nDifference-in-Discontinuities.” Applied Economics\nLetters 30 (5): 615–19. https://doi.org/10.1080/13504851.2021.2005236.\n\n\n———. 2023b. “JUE Insight: Difference-in-Differences with Geocoded\nMicrodata.” Journal of Urban Economics 133: 103493. https://doi.org/10.1016/j.jue.2022.103493.\n\n\nCalonico, Sebastian, Matias D. Cattaneo, and Rocio Titiunik. 2014.\n“Robust Nonparametric Confidence Intervals for\nRegression-Discontinuity Designs.” Econometrica 82 (6):\n2295–2326. https://doi.org/10.3982/ECTA11757.\n\n\nCase, Anne C., James R. Hines, and Harvey S. Rosen. 1993. “Budget\nSpillovers and Fiscal Policy Interdependence: Evidence from the\nStates.” Journal of Public Economics 52 (3): 285–307. https://doi.org/10.1016/0047-2727(93)90036-S.\n\n\nCattaneo, Matias D., and Rocı́o Titiunik. 2022. “Regression\nDiscontinuity Designs.” Annual Review of Economics 14\n(1): 821–51. https://doi.org/10.1146/annurev-economics-051520-021409.\n\n\nChagas, André L. S., Carlos R. Azzoni, and Alexandre N. Almeida. 2016.\n“A Spatial Difference-in-Differences Analysis of the Impact of\nSugarcane Production on Respiratory Diseases.” Regional\nScience and Urban Economics 59: 24–36. https://doi.org/10.1016/j.regsciurbeco.2016.04.002.\n\n\nChen, Jinyu, Wenjing Luo, Xiaohang Ren, and Tianqi Liu. 2023. “The\nLocal-Neighborhood Effects of Low-Carbon City Pilots Program on PM2.5 in\nChina: A Spatial Difference-in-Differences Analysis.” Science\nof The Total Environment 857: 159511. https://doi.org/10.1016/j.scitotenv.2022.159511.\n\n\nChun, Yongwan, and Daniel A. Griffith. 2013. Spatial Statistics and\nGeostatistics: Theory and Applications for Geographic Information\nScience and Technology. Thousand Oaks, CA: Sage.\n\n\nCliff, Andrew D., and J. Keith Ord. 1969. “The Problem of Spatial\nAutocorrelation.” In Studies in Regional Science, edited\nby A. J. Scott, 25–55. London Papers in Regional Science. London: Pion.\n\n\n———. 1973. Spatial Autocorrelation. London: Pion.\n\n\n———. 1981. Spatial Processes. London: Pion.\n\n\nCorrado, Luisa, and Bernard Fingleton. 2012. “Where Is the\nEconomics in Spatial Econometrics?” Journal of Regional\nScience 52: 210–39.\n\n\nCredit, Kevin. 2022. “Spatial Models or Random Forest? Evaluating\nthe Use of Spatially Explicit Machine Learning Methods to Predict\nEmployment Density Around New Transit Stations in Los Angeles.”\nGeographical Analysis 54 (1): 58–83. https://doi.org/10.1111/gean.12273.\n\n\nCressie, Noel A. C. 1993. Statistics for Spatial Data. New\nYork: John Wiley & Sons.\n\n\nDearmon, Jacob, and Tony E. Smith. 2021. “A Hierarchical Approach\nto Scalable Gaussian Process Regression for Spatial\nData.” Journal of Spatial Econometrics 2 (7): 1–33. https://doi.org/10.1007/s43071-021-00012-5.\n\n\nDelgado, Michael S., and Raymond J. G. M. Florax. 2015.\n“Difference-in-Differences Techniques for Spatial Data: Local\nAutocorrelation and Spatial Interaction.” Economics\nLetters 137: 123–26. https://doi.org/10.1016/j.econlet.2015.10.035.\n\n\nDeng, Yue, Rixing He, and Yang Liu. 2023. “Crime Risk Prediction\nIncorporating Geographical Spatiotemporal Dependency into Machine\nLearning Models.” Information Sciences 646: 119414. https://doi.org/10.1016/j.ins.2023.119414.\n\n\nDiao, Mi, Delon Leonard, and Tien Foo Sing. 2017.\n“Spatial-Difference-in-Differences Models for Impact of New Mass\nRapid Transit Line on Private Housing Values.” Regional\nScience and Urban Economics 67: 64–77. https://doi.org/10.1016/j.regsciurbeco.2017.08.006.\n\n\nDray, S., R. Pélissier, P. Couteron, M.-J. Fortin, P. Legendre, P. R.\nPeres-Neto, E. Bellier, et al. 2012. “Community Ecology in the Age\nof Multivariate Multiscale Spatial Analysis.” Ecological\nMonographs 82 (3): 257–75. https://doi.org/10.1890/11-1183.1.\n\n\nDrèze, Jacques H. 1964. “Some Postwar Contributions of French\nEconomists to Theory and Public Policy: With Special Emphasis on\nProblems of Resource Allocation.” The American Economic\nReview 54 (4): 2–64.\n\n\nDubé, Jean, Maha AbdelHalim, and Nicolas Devaux. 2021. “Evaluating\nthe Impact of Floods on Housing Price Using a Spatial Matching\nDifference-in-Differences (SM-DID) Approach.”\nSustainability 13 (2). https://doi.org/10.3390/su13020804.\n\n\nDubé, Jean, Diègo Legros, Marius Thériault, and François Des Rosiers.\n2014. “A Spatial Difference-in-Differences Estimator to Evaluate\nthe Effect of Change in Public Mass Transit Systems on House\nPrices.” Transportation Research Part B: Methodological\n64: 24–40. https://doi.org/10.1016/j.trb.2014.02.007.\n\n\n———. 2017. “Measuring and Interpreting Urban Externalities in\nReal-Estate Data: A Spatio-Temporal Difference-in-Differences (STDID)\nEstimator.” Buildings 7 (2). https://doi.org/10.3390/buildings7020051.\n\n\nDubin, Robin. 2003. “Robustness of Spatial Autocorrelation\nSpecifications: Some Monte Carlo Evidence.” Journal of\nRegional Science 43 (2): 221–48. https://doi.org/10.1111/1467-9787.00297.\n\n\nDyba, Krzysztof, and Jakub Nowosad. 2021. “Rgugik: Search and\nRetrieve Spatial Data from the Polish Head Office of Geodesy and\nCartography in r.” Journal of Open Source Software 6\n(59): 2948. https://doi.org/10.21105/joss.02948.\n\n\nElhorst, J. Paul. 2010. “Applied Spatial Econometrics: Raising the\nBar.” Spatial Economic Analysis 5: 9–28.\n\n\nFang, Jing. 2021. “Impacts of High-Speed Rail on Urban Smog\nPollution in China: A Spatial Difference-in-Difference Approach.”\nScience of The Total Environment 777: 146153. https://doi.org/10.1016/j.scitotenv.2021.146153.\n\n\nFingleton, B. 1999. “Spurious spatial\nregression: Some Monte Carlo results with a spatial unit root and\nspatial cointegration.” Journal of Regional\nScience 39: 1–19.\n\n\nFujita, Masahisa, Paul Krugman, and Anthony J. Venables. 1999. The\nSpatial Economy. Cambridge, MA: MIT Press.\n\n\nGaetan, Carlo, and Xavier Guyon. 2010. Spatial Statistics and\nModeling. New York: Springer.\n\n\nGao, Bingbo, Jinfeng Wang, Alfred Stein, and Ziyue Chen. 2022.\n“Causal Inference in Spatial Statistics.” Spatial\nStatistics 50: 100621. https://doi.org/10.1016/j.spasta.2022.100621.\n\n\nGao, Da, and Guimei Wang. 2023. “Does the Opening of High-Speed\nRails Improve Urban Carbon Efficiency? Evidence from a Spatial\nDifference-in-Difference Method.” Environmental Science and\nPollution Research 30: 101873–87.\n\n\nGerber, Florian, and Reinhard Furrer. 2015. “Pitfalls in the\nImplementation of Bayesian Hierarchical Modeling of Areal Count Data: An\nIllustration Using BYM and Leroux Models.” Journal of\nStatistical Software, Code Snippets 63 (1): 1–32. https://doi.org/10.18637/jss.v063.c01.\n\n\nGibbons, Stephen, Stephen Machin, and Olmo Silva. 2013. “Valuing\nSchool Quality Using Boundary Discontinuities.” Journal of\nUrban Economics 75: 15–28.\n\n\nGibbons, Stephen, and Henry G. Overman. 2012. “Mostly Pointless\nSpatial Econometrics?” Journal of Regional Science 52:\n172–91.\n\n\nGolgher, André Braz, and Paul R. Voss. 2016. “How to Interpret the\nCoefficients of Spatial Models: Spillovers, Direct and Indirect\nEffects.” Spatial Demography 4: 175–205. https://doi.org/10.1007/s40980-015-0016-y.\n\n\nGómez-Rubio, Virgilio. 2019. “Spatial Data Analysis with INLA.\nCoding Club UC3M Tutorial Series. Universidad Carlos III de\nMadrid.” https://codingclubuc3m.rbind.io/talk/2019-11-05/.\n\n\n———. 2020. Bayesian Inference with INLA. Boca Raton, FL: CRC\nPress.\n\n\nGotway, C. A., and L. J. Young. 2002. “Combining Incompatible\nSpatial Data.” Journal of the American Statistical\nAssociation 97: 632–48.\n\n\nGoulard, Michel, Thibault Laurent, and Christine Thomas-Agnan. 2017.\n“About Predictions in Spatial Autoregressive Models: Optimal and\nAlmostoptimal Strategies.” Spatial Economic Analysis 12\n(2-3): 304–25. https://doi.org/10.1080/17421772.2017.1300679.\n\n\nGraham, Robert E., and J. Thomas Romans. 1971. “Regional Economic\nAccounting in the u.s. Office of Business Economics — an\nAppraisal.” Review of Income and Wealth 17: 1–34.\n\n\nGranger, Clive W. J. 1969. “Spatial Data and Time Series\nAnalysis.” In Studies in Regional Science, edited by A.\nJ. Scott, 1–25. London Papers in Regional Science 1. London: Pion.\n\n\nGriffith, Daniel A. 2003. Spatial Autocorrelation and Spatial\nFiltering. New York: Springer.\n\n\n———. 2004. “Extreme Eigenfunctions of Adjacency Matrices for\nPlanar Graphs Employed in Spatial Analyses.” Linear Algebra\nand Its Applications 388: 201–19. https://doi.org/10.1016/S0024-3795(03)00368-9.\n\n\n———. 2010. “Spatial Filtering.” In Handbook of Applied\nSpatial Analysis, edited by Manfred Fischer and Arthur Getis,\n301–18. Heidelberg: Springer.\n\n\nGriffith, Daniel A., and Jean H. P. Paelinck. 2007. “An Equation\nby Any Other Name Is Still the Same: On Spatial Econometrics and Spatial\nStatistics.” Annals of Regional Science 41: 209–27.\n\n\nGriffith, Daniel A., and A Sone. 1995. “Trade-offs associated with normalizing constant\ncomputational simplifications for estimating spatial statistical\nmodels.” Journal of Statistical Computation and\nSimulation 51 (2–4): 165–83.\n\n\nGriliches, Zvi. 1967. “Distributed Lags: A Survey.”\nEconometrica 35: 16–49.\n\n\nHalleck Vega, Solmaria, and J. Paul Elhorst. 2015. “The\nSLX Model.” Journal of Regional Science 55\n(3): 339–63. https://doi.org/10.1111/jors.12188.\n\n\nHan, Mengjie, Oana Mihaescu, Yujiao Li, and Niklas Rudholm. 2018.\n“Comparison and One-Stop Shopping After Big-Box Retail Entry: A\nSpatial Difference-in-Difference Analysis.” Journal of\nRetailing and Consumer Services 40: 175–87. https://doi.org/10.1016/j.jretconser.2017.10.003.\n\n\nHepple, Leslie W. 1974. “The Impact of Stochastic Process Theory\nUpon Spatial Analysis in Human Geography.” Progress in\nGeography 6: 89–142.\n\n\n———. 1976. “A Maximum Likelihood Model for Econometric Estimation\nwith Spatial Series.” In Theory and Practice in Regional\nScience, edited by I. Masser, 90–104. London Papers in Regional\nScience. London: Pion.\n\n\nHordijk, Leen. 1974. “Spatial Correlation in the Disturbances of a\nLinear Interregional Model.” Regional and Urban\nEconomics 4: 117–40.\n\n\nHordijk, Leen, and Jean H. P. Paelinck. 1976. “Some Principles and\nResults in Spatial Econometrics.” Recherches Economiques de\nLouvain 42: 175–97.\n\n\nJia, Ruining, Shuai Shao, and Lili Yang. 2021. “High-Speed Rail\nand CO2 Emissions in Urban China: A Spatial Difference-in-Differences\nApproach.” Energy Economics 99: 105271. https://doi.org/10.1016/j.eneco.2021.105271.\n\n\nKato, Takafumi. 2013. “Usefulness of the Information Contained in\nthe Prediction Sample for the Spatial Error Model.” The\nJournal of Real Estate Finance and Economics 47: 169–95. https://doi.org/10.1007/s11146-011-9345-9.\n\n\nKattenborn, Teja, Felix Schiefer, Julian Frey, Hannes Feilhauer, Miguel\nD. Mahecha, and Carsten F. Dormann. 2022. “Spatially\nAutocorrelated Training and Validation Samples Inflate Performance\nAssessment of Convolutional Neural Networks.” ISPRS Open\nJournal of Photogrammetry and Remote Sensing 5: 100018. https://doi.org/10.1016/j.ophoto.2022.100018.\n\n\nKeele, Luke J., and Rocío Titiunik. 2015. “Geographic Boundaries\nas Regression Discontinuities.” Political Analysis 23\n(1): 127–55. https://doi.org/10.1093/pan/mpu014.\n\n\nKelejian, Harry H., G. Tavlas, and G. Hondroyiannis. 2006. “A\nSpatial Modelling Approach to Contagion Among Emerging\nEconomies.” Open Economies Review 17: 423–41.\n\n\nKelejian, Harry, and Gianfranco Piras. 2017. Spatial\nEconometrics. London: Academic Press.\n\n\nKendall, M. G. 1939. “The Geographical Distribution of Crop\nProductivity in England.” Journal of the Royal Statistical\nSociety 102 (1): 21–62. http://www.jstor.org/stable/2980138.\n\n\nKlaassen, Leo H., Jean H. P. Paelinck, and Sjoerd Wagenaar. 1979.\nSpatial Systems. Farnborough: Saxon House.\n\n\nKlein, L. R. 1958. “The Estimation of Distributed Lags.”\nEconometrica 26: 553–65.\n\n\nKolak, Marynia, and Luc Anselin. 2020. “A Spatial Perspective on\nthe Econometrics of Program Evaluation.” International\nRegional Science Review 43 (1-2): 128–53. https://doi.org/10.1177/0160017619869781.\n\n\nKoley, Malabika. 2024. “Specification Testing Under General\nNesting Spatial Model.” https://drive.google.com/file/d/1jDAQEmczE7vlPPX1jKaYajD1VtmL4Zvh/view.\n\n\nKoley, Malabika, and Anil K. Bera. 2022. “Testing for Spatial\nDependence in a Spatial Autoregressive (SAR) Model in the Presence of\nEndogenous Regressors.” Journal of Spatial Econometrics\n3 (11): 1–46. https://doi.org/10.1007/s43071-022-00026-7.\n\n\nKopczewska, Katarzyna. 2022. “Spatial Machine Learning: New\nOpportunities for Regional Science.” The Annals of Regional\nScience 68 (3): 713–55. https://doi.org/10.1007/s00168-021-01101-x.\n\n\nKoschinsky, Julia. 2013. “The Case for Spatial Analysis in\nEvaluation to Reduce Health Inequities.” Evaluation and\nProgram Planning 36 (1): 172–76. https://doi.org/10.1016/j.evalprogplan.2012.03.004.\n\n\nKosfeld, Reinhold, Timo Mitze, Johannes Rode, and Klaus Wälde. 2021.\n“The Covid-19 Containment Effects of Public Health Measures: A\nSpatial Difference-in-Differences Approach.” Journal of\nRegional Science 61 (4): 799–825. https://doi.org/10.1111/jors.12536.\n\n\nKoyck, L. M. 1954. Distributed Lags and Znoestment Analysis.\nAmsterdam: North-Holland.\n\n\nLeSage, James. 2014. “What Regional Scientists Need to Know about\nSpatial Econometrics.” The Review of Regional Studies 44\n(1). http://journal.srsa.org/ojs/index.php/RRS/article/view/44.1.2.\n\n\nLeSage, James P., and Manfred M. Fischer. 2008. “Spatial Growth\nRegression: Model Specification, Estimation and Interpretation.”\nSpatial Economic Analysis 3: 275–304.\n\n\nLeSage, James P., and R. Kelley Pace. 2009. Introduction to Spatial\nEconometrics. Boca Raton FL: Chapman; Hall/CRC.\n\n\nLi, H., C. A. Calder, and N. Cressie. 2012. “One-Step Estimation\nof Spatial Dependence Parameters: Properties and Extensions of the\nAPLE Statistic.” Journal of Multivariate\nAnalysis 105 (1): 68–84.\n\n\nLi, Heng, Chunxiao Zhang, Min Chen, Dingtao Shen, and Yunyun Niu. 2023.\n“Data-Driven Surrogate Modeling: Introducing Spatial Lag to\nConsider Spatial Autocorrelation of Flooding Within Urban Drainage\nSystems.” Environmental Modelling & Software 161:\n105623. https://doi.org/10.1016/j.envsoft.2023.105623.\n\n\nLieshout, M. N. M. van. 2019. Theory of Spatial Statistics.\nBoca Raton, FL: Chapman & Hall/CRC.\n\n\nLinnenbrink, J., C. Milà, M. Ludwig, and H. Meyer. 2023. “kNNDM:\nK-Fold Nearest Neighbour Distance Matching Cross-Validation for Map\nAccuracy Estimation.” EGUsphere 2023: 1–16. https://doi.org/10.5194/egusphere-2023-1308.\n\n\nLiu, Jun, Yu Qian, Shun-feng Song, and Rong-rong Duan. 2022.\n“Industrial Symbiotic Agglomeration and Green Economic Growth: A\nSpatial Difference-in-Differences Approach.” Journal of\nCleaner Production 364: 132560. https://doi.org/10.1016/j.jclepro.2022.132560.\n\n\nLovelace, Robin, Jakub Nowosad, and Jannes Muenchow. 2019.\nGeocomputation with R. CRC Press.https://r.geocompx.org/ .\n\n\nMarcon, Eric, and Florence Puech. 2017. “A Typology of\nDistance-Based Measures of Spatial Concentration.” Regional\nScience and Urban Economics 62: 56–67. https://doi.org/10.1016/j.regsciurbeco.2016.10.004.\n\n\n———. 2023. “Mapping Distributions in Non‑homogeneous Space with\nDistance‑based Methods.” Journal of Spatial Econometrics\n4 (13): 1–16. https://doi.org/10.1007/s43071-023-00042-1.\n\n\nMarcon, Eric, Stéphane Traissac, Florence Puech, and Gabriel Lang. 2015.\n“Tools to Characterize Point Patterns: Dbmss for r.”\nJournal of Statistical Software, Code Snippets 67 (3): 1–15. https://doi.org/10.18637/jss.v067.c03.\n\n\nMcCulloch, Charles E., and Shayle R. Searle. 2001. Generalized,\nLinear, and Mixed Models. New York: Wiley.\n\n\nMcMillen, Daniel P. 2003. “Spatial Autocorrelation or Model\nMisspecification?” International Regional Science Review\n26: 208–17.\n\n\n———. 2010. “Issues in Spatial Data Analysis.” Journal\nof Regional Science 50: 119–41.\n\n\nMeyer, Hanna, and Edzer Pebesma. 2021. “Predicting into Unknown\nSpace? Estimating the Area of Applicability of Spatial Prediction\nModels.” Methods in Ecology and Evolution 12 (9):\n1620–33. https://doi.org/10.1111/2041-210X.13650.\n\n\n———. 2022. “Machine Learning-Based Global Maps of Ecological\nVariables and the Challenge of Assessing Them.” Nature\nCommunincations 13. https://doi.org/\n10.1038/s41467-022-29838-9 .\n\n\nMeyer, Hanna, Christoph Reudenbach, Tomislav Hengl, Marwan Katurji, and\nThomas Nauss. 2018. “Improving Performance of Spatio-Temporal\nMachine Learning Models Using Forward Feature Selection and\nTarget-Oriented Validation.” Environmental Modelling &\nSoftware 101: 1–9. https://doi.org/10.1016/j.envsoft.2017.12.001.\n\n\nMeyer, Hanna, Christoph Reudenbach, Stephan Wöllauer, and Thomas Nauss.\n2019. “Importance of Spatial Predictor Variable Selection in\nMachine Learning Applications – Moving from Data Reproduction to Spatial\nPrediction.” Ecological Modelling 411: 108815. https://doi.org/10.1016/j.ecolmodel.2019.108815.\n\n\nMila, Carles, Jorge Mateu, Edzer Pebesma, and Hanna Meyer. 2022.\n“Nearest Neighbour Distance Matching Leave-One-Out\nCross-Validation for Map Validation.” Methods in Ecology and\nEvolution 13 (6): 1304–16. https://doi.org/10.1111/2041-210X.13851.\n\n\nMur, Jesús, and Ana Angulo. 2006. “The Spatial Durbin Model and\nthe Common Factor Tests.” Spatial Economic Analysis 1\n(2): 207–26. https://doi.org/10.1080/17421770601009841.\n\n\nNikparvar, Behnam, and Jean-Claude Thill. 2021. “Machine Learning\nof Spatial Data.” ISPRS International Journal of\nGeo-Information 10 (9). https://doi.org/10.3390/ijgi10090600.\n\n\nOlsson, Gunnar. 1970. “Explanation, Prediction, and Meaning\nVariance: An Assessment of Distance Interaction Models.”\nEconomic Geography 46: 223–33. http://www.jstor.org/stable/143140.\n\n\nOpenshaw, S., and P. J. Taylor. 1979. “A Million or so Correlation\nCoefficients: Three Experiments on the Modifiable Area Unit\nProblem.” In Statistical Applications in the Spatial\nSciences, edited by N. Wrigley, 127–44. London: Pion.\n\n\nOrd, J. Keith. 1975. “Estimation Methods for Models of Spatial\nInteraction.” Journal of the American Statistical\nAssociation 70: 120–26.\n\n\n———. 2010. “Spatial Autocorrelation: A Statistician’s\nReflections.” In Perspectives on Spatial Data Analysis,\nedited by L. Anselin and S. J. Rey, 165–80. Berlin: Springer-Verlag.\n\n\nPace, R. Kelley, and R. P. Barry. 1997. “Fast\nCARs.” Journal of Statistical Computation and\nSimulation 59 (2): 123–45.\n\n\nPace, R. Kelley, and James P. LeSage. 2008. “A Spatial\nHausman Test.” Economics Letters 101:\n282–84. https://doi.org/10.1016/j.econlet.2008.09.003.\n\n\nPadgham, Mark, Bob Rudis, Robin Lovelace, and Maëlle Salmon. 2017.\n“Osmdata.” Journal of Open Source Software 2 (14):\n305. https://doi.org/10.21105/joss.00305.\n\n\nPaelinck, Jean H. P. 2012. “Specification and Identification in\nSpatial Econometric Models.” Estadística Española 54:\n35–52.\n\n\n———. 2013. “Some Challenges for Spatial Econometricians.”\nIn Spatial Econometrics and Regional Economic Analysis, edited\nby Bogdan Suchecki, 292:11–20. Acta Universitas Lodziensis, Folia\nOeconomica. Wydawnictwa Uniwersytetu Łódzkiego.\n\n\nPaelinck, Jean H. P., and Leo H. Klaassen. 1979. Spatial\nEconometrics. Farnborough: Saxon House.\n\n\nPaelinck, Jean H. P., and Peter Nijkamp. 1975. Operational Theory\nand Method in Regional Economics. Farnborough: Saxon House.\n\n\nPan, Minjie, Weiyong Zou, Kangjuan Lv, and Xinlei Qian. 2023. “Can\nEnvironmental Protection Interview Policy Reduce Air Pollution? -a\nSpatial Difference-in-Differences Approach.” Applied\nEconomics 55 (11): 1217–33. https://doi.org/10.1080/00036846.2022.2096869.\n\n\nPatuelli, Roberto, Norbert Schanne, Daniel A. Griffith, and Peter\nNijkamp. 2012. “PERSISTENCE OF REGIONAL UNEMPLOYMENT: APPLICATION\nOF a SPATIAL FILTERING APPROACH TO LOCAL LABOR MARKETS IN\nGERMANY.” Journal of Regional Science 52 (2): 300–323.\nhttps://doi.org/10.1111/j.1467-9787.2012.00759.x.\n\n\nPebesma, Edzer, and Roger Bivand. 2023. Spatial Data Science with\nApplications in R. Boca Raton, FL: CRC Press.\n\n\nPerroux, François. 1950. “Economic Space: Theory and\nApplications.” Quarterly Journal of Economics 64:\n89–104.\n\n\nPinheiro, Jose C., and Douglas M. Bates. 2000. Mixed-Effects Models\nin S and S-Plus. New York: Springer.\n\n\nPiras, Gianfranco. 2010. “Sphet: Spatial Models with\nHeteroskedastic Innovations in R.” Journal of\nStatistical Software 35: 1–21.\n\n\nPiras, Gianfranco, and Paolo Postiglione. 2022. “A Deeper Look at\nImpacts in Spatial Durbin Model with Sphet.” Geographical\nAnalysis 54 (3): 664–84. https://doi.org/10.1111/gean.12318.\n\n\nPiras, Gianfranco, and Mauricio Sarrias. 2023. “Heterogeneous\nSpatial Models in r: Spatial Regimes Models.” Journal of\nSpatial Econometrics 4. https://doi.org/10.1007/s43071-023-00034-1.\n\n\nPonsard, Claude. 1983. History of Spatial Economic Theory.\nBerlin: Springer-Verlag.\n\n\nQiu, Feng, and Qingmeng Tong. 2021. “A Spatial\nDifference-in-Differences Approach to Evaluate the Impact of Light Rail\nTransit on Property Values.” Economic Modelling 99:\n105496. https://doi.org/10.1016/j.econmod.2021.03.015.\n\n\nRevelli, Federico. 2003. “Reaction or Interaction?\nSpatial Process Identification in Multi-Tiered Government\nStructures.” Journal of Urban Economics 53: 29–53.\n\n\n———. 2006. “Performance Rating and Yardstick Competition in Social\nService Provision.” Journal of Public Economics 90:\n459–75.\n\n\nRevelli, Federico, and Per Tovmo. 2007. “Revealed Yardstick\nCompetition: Local Government Efficiency Patterns in\nNorway.” Journal of Urban Economics 62:\n121–34.\n\n\nRey, Sergio, Dani Arribas-Bel, and Levi J. Wolf. 2023. Geographic\nData Science with Python. Boca Raton, FL: CRC Press.\nhttps://geographicdata.science.\n\n\nRipley, Brian D. 1981. Spatial Statistics. New York: John Wiley\n& Sons.\n\n\n———. 1988. Statistical Inference for Spatial Processes.\nCambridge: Cambridge University Press.\n\n\nRubin, Donald B. 1974. “Estimating Causal Effects of Treatments in\nRandomized and Nonrandomized Studies.” Journal of Educational\nPsychology 66: 688–701. https://doi.org/10.1037/h0037350.\n\n\n———. 1978. “Bayesian Inference for Causal Effects: The Role of\nRandomization.” The Annals of Statistics 6 (1): 34–58.\n\n\nSchabenberger, O., and C. A. Gotway. 2005. Statistical Methods for\nSpatial Data Analysis. Boca Raton/London: Chapman & Hall/CRC.\n\n\nSchratz, Patrick, Jannes Muenchow, Eugenia Iturritxa, Jakob Richter, and\nAlexander Brenning. 2019. “Hyperparameter Tuning and Performance\nAssessment of Statistical and Machine-Learning Algorithms Using Spatial\nData.” Ecological Modelling 406: 109–20. https://doi.org/10.1016/j.ecolmodel.2019.06.002.\n\n\nSmirnov, O., and Luc Anselin. 2009. “An O(N) Parallel\nMethod of Computing the Log-Jacobian of the\nVariable Transformation for Models with Spatial Interaction on a\nLattice.” Computational Statistics & Data Analysis\n53 (8): 2980–88.\n\n\nSmith, Tony E. 2009. “Estimation Bias in Spatial Models with\nStrongly Connected Weight Matrices.” Geographical\nAnalysis 41 (3): 307–32. https://doi.org/10.1111/j.1538-4632.2009.00758.x.\n\n\nSmith, Tony E., and K. L. Lee. 2012. “The\neffects of spatial autoregressive dependencies on inference in ordinary\nleast squares: a geometric approach.” Journal of\nGeographical Systems 14 (January): 91–124. https://doi.org/10.1007/s10109-011-0152-x.\n\n\nStephan, Frederick F. 1934. “Sampling Errors and Interpretations\nof Social Data Ordered in Time and Space.” Journal of the\nAmerican Statistical Association 29 (185): 165–66.\n\n\nStudent. 1914. “The Elimination of Spurious Correlation Due to\nPosition in Time or Space.” Biometrika 10 (1): 179–80.\n\n\nSuesse, Thomas. 2018. “Marginal Maximum Likelihood Estimation of\nSAR Models with Missing Data.” Computational Statistics &\nData Analysis 120: 98–110. https://doi.org/10.1016/j.csda.2017.11.004.\n\n\nSuesse, Thomas, and Andrew Zammit-Mangion. 2017. “Computational\nAspects of the EM Algorithm for Spatial Econometric Models with Missing\nData.” Journal of Statistical Computation and Simulation\n87 (9): 1767–86. https://doi.org/10.1080/00949655.2017.1286495.\n\n\nSunak, Yasin, and Reinhard Madlener. 2016. “The Impact of Wind\nFarm Visibility on Property Values: A Spatial Difference-in-Differences\nAnalysis.” Energy Economics 55: 79–91. https://doi.org/10.1016/j.eneco.2015.12.025.\n\n\nSYMANSKI, STEFAN. 1996. “The Impact of Compulsory Competitive\nTendering on Refuse Collection Services.” Fiscal Studies\n17 (3): 1–19. https://doi.org/https://doi.org/10.1111/j.1475-5890.1996.tb00491.x.\n\n\nSZYMANSKI, STEFAN, and SEAN WILKINS. 1993. “Cheap Rubbish?\nCompetitive Tendering and Contracting Out in Refuse Collection –\n1981–88.” Fiscal Studies 14 (3): 109–30.\nhttps://doi.org/https://doi.org/10.1111/j.1475-5890.1993.tb00489.x.\n\n\nTheil, H. 1964. “Some Developments of Economic Thought in the\nNetherlands.” The American Economic Review 54: pp.\n34–55.\n\n\nTiefelsdorf, Michael. 2002. “The Saddlepoint Approximation of\nMoran’s I and Local Moran’s Ii Reference\nDistributions and Their Numerical Evaluation.” Geographical\nAnalysis 34: 187–206.\n\n\nTiefelsdorf, Michael, and Daniel A. Griffith. 2007.\n“Semiparametric Filtering of Spatial Autocorrelation: The\nEigenvector Approach.” Environment and Planning A: Economy\nand Space 39 (5): 1193–1221. https://doi.org/10.1068/a37378.\n\n\nTobler, Waldo R. 1970. “A Computer Movie Simulating Urban Growth\nin the Detroit Region.” Economic Geography 46: 234–40.\n\n\nTylor, Edward B. 1889. “On a Method of Investigating the\nDevelopment of Institutions; Applied to Laws of Marriage and\nDescent.” The Journal of the Anthropological Institute of\nGreat Britain and Ireland 18: 245–72. http://www.jstor.org/stable/2842423.\n\n\nValavi, Roozbeh, Jane Elith, José J. Lahoz-Monfort, and Gurutzeta\nGuillera-Arroita. 2019. “blockCV: An R Package for\nGenerating Spatially or Environmentally Separated Folds for k-Fold\nCross-Validation of Species Distribution Models.” Methods in\nEcology and Evolution 10 (2): 225–32. https://doi.org/10.1111/2041-210X.13107.\n\n\nVidoli, Francesco, Giacomo Pignataro, and Roberto Benedetti. 2022.\n“Identification of Spatial Regimes of the Production Function of\nItalian Hospitals Through Spatially Constrained Cluster-Wise\nRegression.” Socio-Economic Planning Sciences 82:\n101223. https://doi.org/10.1016/j.seps.2022.101223.\n\n\nWagner, Martin, and Achim Zeileis. 2019. “Heterogeneity and\nSpatial Dependence of Regional Growth in the EU: A\nRecursive Partitioning Approach.” German Economic Review\n20 (1): 67–82. https://doi.org/10.1111/geer.12146.\n\n\nWang, Zhijian, and Yunquan Song. 2023. “Deep Learning for the\nSpatial Additive Autoregressive Model with Nonparametric Endogenous\nEffect.” Spatial Statistics 55: 100743. https://doi.org/10.1016/j.spasta.2023.100743.\n\n\nWard, M. D., and K. S. Gleditsch. 2008. Spatial Regression\nModels. Thousand Oaks, CA: Sage.\n\n\nWilson, Alan G. 2000. Complex Spatial Systems: The Modelling\nFoundations of Urban and Regional Analysis. Harlow: Prentice Hall.\n\n\n———. 2002. “Complex Spatial Systems: Challenges for\nModellers.” Mathematical and Computer Modelling 36:\n379–87.\n\n\n———. 2012. The Science of Cities and Regions: Lectures on\nMathematical Model Design. Dordrecht: Springer.\n\n\nWolf, Levi J. 2023. “Beyond Open Science: Data, Code, and\nCausality.” Environment and Planning B: Urban Analytics and\nCity Science 50 (9): 2333–36. https://doi.org/10.1177/23998083231210180.\n\n\nXiao, Shuyue, Yunquan Song, and Zhijian Wang. 2023. “Nonparametric\nSpatial Autoregressive Model Using Deep Neural Networks.”\nSpatial Statistics 57: 100766. https://doi.org/10.1016/j.spasta.2023.100766.\n\n\nYoshida, Takahiro, Daisuke Murakami, and Hajime Seya. 2022.\n“Spatial Prediction of Apartment Rent Using Regression-Based and\nMachine Learning-Based Approaches with a Large Dataset.”\nJournal of Real Estate Finance & Economics, 1–28. https://doi.org/10.1007/s11146-022-09929-6.\n\n\nYu, Nannan, and Ying Jin. 2023. “The Unintended Economic Impact of\nHigh-Speed Rail on China’s Non-Core Cities: A\nSpatial-Difference-in-Differences Analysis.” Cities 143:\n104618. https://doi.org/10.1016/j.cities.2023.104618.\n\n\nYule, G. Udny, and M. G. Kendall. 1958. An Introduction to the\nTheory of Statistics. 14th ed. London: Charles Griffin.\n\n\nZeng, Juying, Cristina Blanco-González-Tejero, and F. Javier Sendra.\n2023. “The Spatial Difference-in-Difference Measurement of Policy\nEffect of Environmental Protection Interview on Green\nInnovation.” Technological Forecasting and Social Change\n191: 122511. https://doi.org/10.1016/j.techfore.2023.122511.\n\n\nZhang, Xu, Lin Liu, Minxuan Lan, Guangwen Song, Luzi Xiao, and Jianguo\nChen. 2022. “Interpretable Machine Learning Models for Crime\nPrediction.” Computers, Environment and Urban Systems\n94: 101789. https://doi.org/10.1016/j.compenvurbsys.2022.101789.\n\n\nZhu, Di, Yu Liu, Xin Yao, and Manfred M. Fischer. 2023a.\n“Correction to: Spatial Regression Graph Convolutional Neural\nNetworks: A Deep Learning Paradigm for Spatial Multivariate\nDistributions.” GeoInformatica 27: 641–42. https://doi.org/10.1007/s10707-022-00461-6.\n\n\n———. 2023b. “Spatial Regression Graph Convolutional Neural\nNetworks: A Deep Learning Paradigm for Spatial Multivariate\nDistributions.” GeoInformatica 26: 645–76. https://doi.org/10.1007/s10707-021-00454-x.",
    "crumbs": [
      "References"
    ]
  }
]